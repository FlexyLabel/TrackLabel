<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Track Label Pro - Producci√≥n</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --bg: #0b0e11; --sidebar: #15191d; --surface: #1e2329;
            --orange: #ff7a00; --green: #00ff88; --red: #ff4444;
            --text: #f0f0f0; --border: #282e35;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; 
            margin: 0; padding: 0; min-height: 100vh; display: flex; flex-direction: column;
        }

        /* --- PANTALLA DE SEGURIDAD --- */
        #master-lock {
            position: fixed; inset: 0; background: #000; z-index: 50000;
            display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .lock-box {
            background: var(--surface); padding: 40px; border-radius: 35px;
            text-align: center; border: 1px solid var(--border); width: 100%; max-width: 400px;
        }

        /* --- LOGIN DE OPERARIOS (NOMBRES CORREGIDOS) --- */
        .login-overlay {
            position: fixed; inset: 0; background: var(--bg); z-index: 40000;
            display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .user-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 25px 0;
        }
        .user-item {
            background: var(--sidebar); padding: 15px 5px; border-radius: 20px; border: 1px solid #333;
            cursor: pointer; text-align: center; transition: 0.3s;
        }
        .user-item:hover, .user-item.selected { border-color: var(--orange); background: #222; }
        .user-initial { 
            width: 45px; height: 45px; border-radius: 50%; border: 2px solid #444; 
            display: flex; align-items: center; justify-content: center; margin: 0 auto 8px; 
            font-weight: bold; font-size: 18px; color: #fff;
        }
        .user-name { font-size: 12px; font-weight: 500; color: #aaa; }
        .selected .user-name { color: var(--orange); }

        /* --- LAYOUT --- */
        .app-container { display: flex; flex-direction: row; min-height: 100vh; }

        .sidebar-planta {
            width: 320px; background: var(--sidebar); border-right: 1px solid var(--border);
            padding: 25px; flex-shrink: 0; display: flex; flex-direction: column; gap: 20px;
        }

        .panel-stats {
            background: var(--surface); padding: 20px; border-radius: 25px; border: 1px solid var(--border);
        }
        .panel-stats h4 { margin: 0 0 12px 0; font-size: 11px; color: var(--orange); text-transform: uppercase; letter-spacing: 1px; }

        .bar-bg { background: #000; height: 10px; border-radius: 5px; margin: 10px 0; overflow: hidden; }
        .bar-fill { background: var(--orange); height: 100%; width: 0%; transition: 0.8s; }

        .main-content { flex: 1; padding: 25px; display: flex; flex-direction: column; gap: 20px; }

        /* ORGANIZACI√ìN VERTICAL FORZADA */
        .kanban-vertical {
            display: flex; flex-direction: column !important; gap: 25px; width: 100%; max-width: 850px; margin: 0 auto;
        }
        .machine-block { background: var(--sidebar); border-radius: 25px; border: 1px solid var(--border); overflow: hidden; }
        .machine-header { 
            padding: 18px 25px; background: rgba(255,255,255,0.02); 
            display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #222; 
        }
        .drop-zone { padding: 15px; min-height: 110px; }

        /* TARJETAS */
        .job-card {
            background: var(--surface); padding: 20px; border-radius: 22px; margin-bottom: 15px;
            border-left: 6px solid var(--orange); cursor: pointer; transition: 0.2s;
        }
        .job-card:active { transform: scale(0.97); }
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }

        /* MODALES */
        .modal {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.92);
            z-index: 20000; padding: 20px; overflow-y: auto; backdrop-filter: blur(5px);
        }
        .modal-box {
            background: var(--surface); border-radius: 35px; padding: 35px;
            width: 100%; max-width: 500px; margin: 0 auto; border: 1px solid #333;
        }
        .btn-action {
            width: 100%; padding: 18px; border-radius: 18px; border: none;
            font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 15px;
        }
        .btn-orange { background: var(--orange); color: white; }
        .btn-green { background: var(--green); color: black; }
        .btn-red { background: var(--red); color: white; }

        input, select {
            width: 100%; padding: 15px; background: #000; border: 1px solid #333;
            color: white; border-radius: 15px; margin-bottom: 15px;
        }

        @media (max-width: 850px) {
            .app-container { flex-direction: column; }
            .sidebar-planta { width: 100%; border-right: none; border-bottom: 1px solid var(--border); }
        }
    </style>
</head>
<body>

<div id="master-lock">
    <div class="lock-box">
        <h2 style="color:var(--orange); margin-top:0;">CONTROL DE ACCESO</h2>
        <p style="color:#666; font-size:14px;">Introduce la clave del sistema</p>
        <input type="password" id="m-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="text-align:center; letter-spacing: 3px;">
        <button class="btn-action btn-orange" onclick="unlock()">ENTRAR AL PANEL</button>
    </div>
</div>

<div id="login-screen" class="login-overlay" style="display:none">
    <div class="lock-box" style="max-width:480px;">
        <h3 style="margin-top:0;">OPERARIOS EN PLANTA</h3>
        <div class="user-grid">
            <div class="user-item" onclick="selUser('Isa', this)"><div class="user-initial">I</div><div class="user-name">Isa</div></div>
            <div class="user-item" onclick="selUser('Jaume', this)"><div class="user-initial">J</div><div class="user-name">Jaume</div></div>
            <div class="user-item" onclick="selUser('Ivan', this)"><div class="user-initial" style="border-color:var(--orange); color:var(--orange)">I</div><div class="user-name">Ivan</div></div>
            <div class="user-item" onclick="selUser('Anna', this)"><div class="user-initial">A</div><div class="user-name">Anna</div></div>
            <div class="user-item" onclick="selUser('Toni', this)"><div class="user-initial">T</div><div class="user-name">Toni</div></div>
        </div>
        <input type="password" id="u-pin" placeholder="PIN" style="text-align:center;">
        <button class="btn-action btn-orange" onclick="login()">INICIAR SESI√ìN</button>
    </div>
</div>

<div id="app-main" class="app-container" style="display:none">
    
    <aside class="sidebar-planta">
        <div style="display:flex; align-items:center; gap:12px;">
            <div style="background:var(--orange); padding:10px; border-radius:12px; color:black; font-weight:900; font-size:18px;">TL</div>
            <h2 style="margin:0; font-size:20px;">PLANTA</h2>
        </div>

        <div class="panel-stats">
            <h4>RENDIMIENTO</h4>
            <div class="bar-bg"><div id="prog-bar" class="bar-fill"></div></div>
            <span id="prog-text" style="font-size:12px; color:#888;">0% completado</span>
        </div>

        <div class="panel-stats">
            <h4>TRABAJOS ACTIVOS</h4>
            <div style="display:flex; justify-content:space-between; margin-bottom:8px;">Activos: <strong id="s-act">0</strong></div>
            <div style="display:flex; justify-content:space-between;">Hechos Hoy: <strong id="s-fin" style="color:var(--green)">0</strong></div>
        </div>

        <div class="panel-stats" style="flex:1;">
            <h4>ACTIVIDAD RECIENTE</h4>
            <div id="log" style="font-size:11px; color:#555; overflow-y:auto; max-height:300px;"></div>
        </div>
        
        <button onclick="location.reload()" style="background:none; border:none; color:#444; font-size:11px; cursor:pointer; text-decoration: underline;">Cerrar Sesi√≥n / Bloquear</button>
    </aside>

    <main class="main-content">
        <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <div>
                <h2 id="welcome" style="margin:0; font-size:24px;">Cargando...</h2>
                <span style="color:var(--orange); font-size:11px; font-weight:bold; letter-spacing: 1px;">SISTEMA TRACK LABEL V3</span>
            </div>
            <button class="btn-action btn-orange" style="width:auto; padding:12px 25px" onclick="openNew()">+ NUEVA ORDEN</button>
        </header>

        <div class="kanban-vertical">
            <div class="machine-block">
                <div class="machine-header"><span>FLEXO / OFFSET</span> <span id="c-flexo" style="background:#000; padding:4px 10px; border-radius:8px; color:var(--orange)">0</span></div>
                <div id="list-flexo" class="drop-zone"></div>
            </div>
            <div class="machine-block">
                <div class="machine-header"><span>DIGITAL</span> <span id="c-digital" style="background:#000; padding:4px 10px; border-radius:8px; color:var(--orange)">0</span></div>
                <div id="list-digital" class="drop-zone"></div>
            </div>
            <div class="machine-block">
                <div class="machine-header"><span>REPASO / EXPEDICI√ìN</span> <span id="c-repaso" style="background:#000; padding:4px 10px; border-radius:8px; color:var(--orange)">0</span></div>
                <div id="list-acabados" class="drop-zone"></div>
            </div>
        </div>
    </main>
</div>

<div id="modal-new" class="modal">
    <div class="modal-box">
        <h3 style="margin-top:0">LANZAR ORDEN</h3>
        <label style="font-size:11px; color:var(--orange); font-weight:bold;">CLIENTE</label>
        <input type="text" id="in-cli" placeholder="Empresa">
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
            <div>
                <label style="font-size:11px; color:var(--orange); font-weight:bold;">M√ÅQUINA</label>
                <select id="in-maq">
                    <option value="list-flexo">FLEXO</option>
                    <option value="list-digital">DIGITAL</option>
                </select>
            </div>
            <div>
                <label style="font-size:11px; color:var(--orange); font-weight:bold;">METROS</label>
                <input type="number" id="in-met" placeholder="0">
            </div>
        </div>

        <label style="font-size:11px; color:var(--orange); font-weight:bold;">T√âCNICO (TROQUEL/GRABADO)</label>
        <input type="text" id="in-tec" placeholder="Referencias">

        <button class="btn-action btn-orange" onclick="saveJob()">GUARDAR EN COLA</button>
        <button class="btn-action" style="background:none; color:#555" onclick="closeNew()">Cancelar</button>
    </div>
</div>

<div id="modal-time" class="modal">
    <div class="modal-box" id="time-content">
        </div>
</div>

<script>
const MASTER_PASS = "TrackLabel#";
const USERS = {"Ivan":"1234", "Isa":"1234", "Jaume":"1234", "Anna":"1234", "Toni":"1234"};

let db = JSON.parse(localStorage.getItem('tl_final_db')) || {};
let finCount = parseInt(localStorage.getItem('tl_final_count')) || 0;
let activeUser = "Ivan";
let currentJobId = null;

// SEGURIDAD
function unlock() {
    if(document.getElementById('m-pass').value === MASTER_PASS) {
        document.getElementById('master-lock').style.display = 'none';
        document.getElementById('login-screen').style.display = 'flex';
    } else { alert("Acceso Denegado"); }
}

function selUser(n, el) {
    activeUser = n;
    document.querySelectorAll('.user-item').forEach(i => i.classList.remove('selected'));
    el.classList.add('selected');
}

function login() {
    if(USERS[activeUser] === document.getElementById('u-pin').value) {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app-main').style.display = 'flex';
        document.getElementById('welcome').innerText = "Hola, " + activeUser;
        render();
        initSort();
    } else { alert("PIN Incorrecto"); }
}

// PRODUCCI√ìN
function render() {
    document.querySelectorAll('.drop-zone').forEach(z => z.innerHTML = "");
    Object.keys(db).forEach(id => {
        const item = db[id];
        const card = document.createElement('div');
        card.className = "job-card";
        card.id = id;
        card.onclick = () => openTime(id);
        
        let dotColor = '#444';
        if(item.start) dotColor = 'var(--green)';
        
        card.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <strong style="font-size:16px;">${item.cli.toUpperCase()}</strong>
                <span class="status-dot" style="background:${dotColor}"></span>
            </div>
            <div style="font-size:12px; color:#777; margin-top:8px;">
                üìè ${item.met}m | üõ†Ô∏è ${item.tec}
            </div>
        `;
        document.getElementById(item.maq).appendChild(card);
    });
    updateStats();
}

function saveJob() {
    const cli = document.getElementById('in-cli').value;
    const met = document.getElementById('in-met').value;
    if(!cli || !met) return;
    const id = "ID-"+Date.now();
    db[id] = { cli, met, maq: document.getElementById('in-maq').value, tec: document.getElementById('in-tec').value || "S/N", start: null };
    save();
    closeNew();
    addLog("Orden creada: " + cli);
}

function openTime(id) {
    currentJobId = id;
    const item = db[id];
    const box = document.getElementById('time-content');
    box.innerHTML = `
        <h2 style="margin:0; color:var(--orange)">${item.cli}</h2>
        <p style="color:#888; margin-bottom:25px;">${item.met} metros | Ref: ${item.tec}</p>
        
        ${!item.start ? 
            `<button class="btn-action btn-green" onclick="timerAction('start')">FICHAR INICIO</button>` : 
            `<div style="background:#00ff8811; color:var(--green); padding:15px; border-radius:15px; margin-bottom:15px; text-align:center; border:1px solid var(--green)">Iniciado a las: ${item.start}</div>`
        }

        ${item.start ? 
            `<button class="btn-action btn-red" onclick="timerAction('end')">TERMINAR TRABAJO</button>` : 
            ""
        }

        <button class="btn-action" style="background:#222; color:white; margin-top:20px" onclick="closeTime()">VOLVER</button>
    `;
    document.getElementById('modal-time').style.display = 'block';
}

function timerAction(type) {
    const now = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    if(type === 'start') {
        db[currentJobId].start = now;
        addLog("‚ñ∂ " + activeUser + " inici√≥: " + db[currentJobId].cli);
    } else {
        addLog("‚úî " + activeUser + " termin√≥: " + db[currentJobId].cli);
        delete db[currentJobId];
        finCount++;
    }
    save();
    closeTime();
}

function initSort() {
    document.querySelectorAll('.drop-zone').forEach(z => {
        new Sortable(z, { group: 'prod_planta', animation: 150, onEnd: (e) => {
            db[e.item.id].maq = e.to.id;
            save();
        }});
    });
}

function save() {
    localStorage.setItem('tl_final_db', JSON.stringify(db));
    localStorage.setItem('tl_final_count', finCount);
    render();
}

function updateStats() {
    document.getElementById('s-act').innerText = Object.keys(db).length;
    document.getElementById('s-fin').innerText = finCount;
    document.getElementById('c-flexo').innerText = document.getElementById('list-flexo').children.length;
    document.getElementById('c-digital').innerText = document.getElementById('list-digital').children.length;
    document.getElementById('c-repaso').innerText = document.getElementById('list-acabados').children.length;
    
    const total = Object.keys(db).length + finCount;
    const perc = total === 0 ? 0 : Math.round((finCount/total)*100);
    document.getElementById('prog-bar').style.width = perc + "%";
    document.getElementById('prog-text').innerText = perc + "% completado";
}

function addLog(m) {
    const l = document.getElementById('log');
    const time = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    l.innerHTML = `<div style="margin-bottom:8px; border-bottom:1px solid #222; padding-bottom:4px;">[${time}] ${m}</div>` + l.innerHTML;
}

function openNew() { document.getElementById('modal-new').style.display = 'block'; }
function closeNew() { document.getElementById('modal-new').style.display = 'none'; }
function closeTime() { document.getElementById('modal-time').style.display = 'none'; }
</script>
</body>
</html>
