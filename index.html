<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TrackLabel Pro v2026 | Sistema de Control de Planta</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --bg-deep: #080a0c;
            --bg-main: #0f1216;
            --surface: #171a1f;
            --surface-light: #1f232a;
            --accent: #ff7a00;
            --accent-hover: #ff9500;
            --green: #00ff88;
            --red: #ff4757;
            --blue: #00d1ff;
            --text-main: #e1e1e1;
            --text-dim: #8b949e;
            --border: #2d333b;
            --shadow: 0 8px 32px rgba(0,0,0,0.5);
        }

        /* --- RESET & BASE --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { 
            background: var(--bg-deep); color: var(--text-main); 
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif; 
            margin: 0; padding: 0; min-height: 100vh; overflow: hidden;
        }

        /* --- SCROLLBAR --- */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-deep); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }

        /* --- PANTALLAS DE BLOQUEO --- */
        .full-overlay {
            position: fixed; inset: 0; background: var(--bg-deep); z-index: 99999;
            display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .glass-panel {
            background: var(--surface); padding: 40px; border-radius: 40px;
            border: 1px solid var(--border); width: 100%; max-width: 480px;
            text-align: center; box-shadow: var(--shadow);
            animation: fadeIn 0.5s ease;
        }

        .user-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 30px 0; }
        .user-card {
            background: var(--bg-main); padding: 20px 10px; border-radius: 20px;
            border: 2px solid transparent; cursor: pointer; transition: 0.3s;
        }
        .user-card:hover { border-color: var(--accent); transform: translateY(-3px); }
        .user-card.active { border-color: var(--accent); background: rgba(255,122,0,0.1); }
        .user-card i { font-size: 24px; color: var(--accent); margin-bottom: 10px; display: block; }
        
        /* --- LAYOUT --- */
        .app-shell { display: flex; height: 100vh; width: 100vw; }

        /* SIDEBAR */
        .sidebar {
            width: 300px; background: var(--bg-main); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; flex-shrink: 0;
        }
        .sidebar-header { padding: 30px; border-bottom: 1px solid var(--border); }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 20px; }
        
        .nav-user {
            background: var(--surface); padding: 15px; border-radius: 20px;
            display: flex; align-items: center; gap: 12px; cursor: pointer; margin-bottom: 25px;
        }
        .nav-user .avatar { 
            width: 40px; height: 40px; background: var(--accent); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-weight: 900; color: #000;
        }

        /* MAIN AREA */
        .main-stage { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: var(--bg-deep); }
        .top-bar { 
            padding: 15px 40px; background: var(--bg-main); border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .kanban-container { flex: 1; padding: 25px; display: flex; flex-direction: column; gap: 30px; overflow-y: auto; }

        /* --- KANBAN SECTIONS --- */
        .machine-lane { background: var(--surface); border-radius: 30px; border: 1px solid var(--border); overflow: hidden; }
        .lane-header { 
            padding: 20px 30px; background: rgba(255,255,255,0.02); border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .lane-header h3 { margin: 0; font-size: 14px; letter-spacing: 2px; text-transform: uppercase; color: var(--text-dim); }
        .drop-zone { padding: 20px; min-height: 120px; }

        /* --- CARDS --- */
        .job-card {
            background: var(--surface-light); padding: 24px; border-radius: 25px;
            margin-bottom: 20px; border-left: 10px solid var(--accent);
            cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: 0.3s; position: relative;
        }
        .job-card:hover { transform: scale(1.01); background: #262c36; }
        .job-card h4 { margin: 0 0 10px 0; font-size: 18px; color: #fff; }
        .card-meta { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .badge { background: var(--bg-deep); padding: 5px 12px; border-radius: 10px; font-size: 11px; border: 1px solid var(--border); }
        .status-pill { 
            position: absolute; top: 20px; right: 20px; 
            padding: 4px 12px; border-radius: 100px; font-size: 10px; font-weight: 800;
        }

        /* --- FORMS & INPUTS --- */
        .field-group { margin-bottom: 20px; text-align: left; }
        .field-group label { display: block; font-size: 11px; font-weight: 800; color: var(--accent); text-transform: uppercase; margin: 0 0 8px 10px; }
        input, select, textarea {
            width: 100%; padding: 16px; background: var(--bg-deep); border: 1px solid var(--border);
            color: #fff; border-radius: 18px; font-size: 15px; transition: 0.3s;
        }
        input:focus { border-color: var(--accent); box-shadow: 0 0 0 4px rgba(255,122,0,0.1); }

        /* --- BUTTONS --- */
        .btn {
            padding: 18px 25px; border-radius: 20px; border: none; font-weight: 800;
            cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn-accent { background: var(--accent); color: #000; }
        .btn-dark { background: var(--surface-light); color: #fff; border: 1px solid var(--border); }
        .btn-red { background: var(--red); color: #fff; }
        .btn-outline { background: transparent; border: 2px solid var(--border); color: var(--text-dim); }
        .btn:active { transform: scale(0.96); }

        /* --- MODALES --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 80000;
            display: none; align-items: flex-start; justify-content: center; padding: 40px 20px;
            overflow-y: auto; backdrop-filter: blur(10px);
        }
        .modal-content {
            background: var(--surface); width: 100%; max-width: 700px;
            border-radius: 40px; padding: 40px; border: 1px solid var(--border);
            animation: slideUp 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }

        /* --- TIMERS & WORKFLOW --- */
        .workflow-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin: 30px 0; }
        .stat-card { background: var(--bg-main); padding: 25px; border-radius: 30px; text-align: center; border: 1px solid var(--border); }
        .stat-card .val { font-size: 42px; font-weight: 900; font-family: 'Courier New', monospace; color: var(--green); }
        
        /* --- ANIMATIONS --- */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* --- SEARCH --- */
        .search-wrapper { position: relative; width: 300px; }
        .search-wrapper i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-dim); }
        .search-wrapper input { padding-left: 45px; height: 45px; border-radius: 100px; }

    </style>
</head>
<body>

    <div id="master-lock" class="full-overlay">
        <div class="glass-panel">
            <i class="fas fa-lock" style="font-size: 40px; color: var(--accent); margin-bottom: 20px;"></i>
            <h1 style="margin: 0; letter-spacing: 5px;">TRACKLABEL<span style="color:var(--accent)">PRO</span></h1>
            <p style="color: var(--text-dim); margin-top: 10px;">Autenticación del Terminal de Planta</p>
            <div class="field-group" style="margin-top: 30px;">
                <input type="password" id="master-input" placeholder="••••••••" style="text-align: center; letter-spacing: 8px; font-size: 24px;">
            </div>
            <button class="btn btn-accent" style="width: 100%;" onclick="unlockSystem()">ACCEDER AL PANEL</button>
        </div>
    </div>

    <div id="login-screen" class="full-overlay" style="display: none;">
        <div class="glass-panel" style="max-width: 600px;">
            <h2>INICIO DE TURNO</h2>
            <p style="color: var(--text-dim);">Selecciona tu perfil para registrar actividad</p>
            <div class="user-grid">
                <div class="user-card" onclick="selectUser('Ivan', this)"><i class="fas fa-user-gear"></i>Ivan</div>
                <div class="user-card" onclick="selectUser('Isa', this)"><i class="fas fa-user-ninja"></i>Isa</div>
                <div class="user-card" onclick="selectUser('Jaume', this)"><i class="fas fa-user-astronaut"></i>Jaume</div>
                <div class="user-card" onclick="selectUser('Anna', this)"><i class="fas fa-user-tie"></i>Anna</div>
                <div class="user-card" onclick="selectUser('Toni', this)"><i class="fas fa-user-doctor"></i>Toni</div>
                <div class="user-card" onclick="selectUser('Admin', this)"><i class="fas fa-user-shield"></i>Admin</div>
            </div>
            <input type="password" id="user-pin" placeholder="PIN DE SEGURIDAD" style="text-align: center; margin-bottom: 20px;">
            <button class="btn btn-accent" style="width: 100%;" onclick="attemptLogin()">CONFIRMAR IDENTIDAD</button>
        </div>
    </div>

    <div id="app-shell" class="app-shell" style="display: none;">
        
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="nav-user" onclick="logout()">
                    <div class="avatar" id="user-initial">U</div>
                    <div style="text-align: left;">
                        <div id="user-name" style="font-weight: 800; font-size: 15px;">Operario</div>
                        <div style="font-size: 10px; color: var(--accent);">TURNO ACTIVO ⇄</div>
                    </div>
                </div>
                <div class="panel-stats">
                    <h4>OBJETIVO DIARIO</h4>
                    <div class="bar-bg"><div id="main-progress-bar" class="bar-fill"></div></div>
                    <div style="display: flex; justify-content: space-between; font-size: 11px; font-weight: 800;">
                        <span id="progress-pct">0%</span>
                        <span id="jobs-done">0 COMPLETADOS</span>
                    </div>
                </div>
            </div>
            <div class="sidebar-content">
                <h4 style="font-size: 11px; color: var(--text-dim); margin-bottom: 15px;">MÉTRICAS EN VIVO</h4>
                <div id="live-stats-container">
                    </div>
                <hr style="border: 0; border-top: 1px solid var(--border); margin: 20px 0;">
                <h4 style="font-size: 11px; color: var(--text-dim); margin-bottom: 15px;">HISTORIAL RECIENTE</h4>
                <div id="log-list" style="display: flex; flex-direction: column; gap: 10px;"></div>
            </div>
        </aside>

        <main class="main-stage">
            <header class="top-bar">
                <div class="search-wrapper">
                    <i class="fas fa-search"></i>
                    <input type="text" id="job-search" placeholder="Buscar por cliente o ID..." oninput="filterJobs()">
                </div>
                <div style="display: flex; gap: 15px;">
                    <button class="btn btn-dark" style="padding: 10px 20px; height: 45px;" onclick="toggleAdminPanel()">
                        <i class="fas fa-chart-line"></i> REPORTES
                    </button>
                    <button class="btn btn-accent" style="padding: 10px 25px; height: 45px;" onclick="openJobModal()">
                        <i class="fas fa-plus"></i> NUEVA ORDEN
                    </button>
                </div>
            </header>

            <div class="kanban-container">
                <section class="machine-lane">
                    <div class="lane-header">
                        <h3><i class="fas fa-print"></i> Flexografía / Offset</h3>
                        <span id="count-flexo" class="badge">0</span>
                    </div>
                    <div id="lane-flexo" class="drop-zone"></div>
                </section>

                <section class="machine-lane">
                    <div class="lane-header">
                        <h3><i class="fas fa-bolt"></i> Impresión Digital</h3>
                        <span id="count-digital" class="badge">0</span>
                    </div>
                    <div id="lane-digital" class="drop-zone"></div>
                </section>

                <section class="machine-lane">
                    <div class="lane-header">
                        <h3><i class="fas fa-check-double"></i> Repaso y Acabados</h3>
                        <span id="count-repaso" class="badge">0</span>
                    </div>
                    <div id="lane-repaso" class="drop-zone"></div>
                </section>
            </div>
        </main>
    </div>

    <div id="job-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="modal-title">NUEVA ORDEN DE FABRICACIÓN</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px;">
                <div class="field-group" style="grid-column: span 2;">
                    <label>Cliente / Proyecto</label>
                    <input type="text" id="f-client" placeholder="Nombre de la empresa...">
                </div>
                <div class="field-group">
                    <label>Máquina Destino</label>
                    <select id="f-machine">
                        <option value="lane-flexo">FLEXOGRAFÍA</option>
                        <option value="lane-digital">DIGITAL</option>
                        <option value="lane-repaso">REPASO</option>
                    </select>
                </div>
                <div class="field-group">
                    <label>Metros Estimados</label>
                    <input type="number" id="f-meters" placeholder="0">
                </div>
                <div class="field-group">
                    <label>Troquel Referencia</label>
                    <input type="text" id="f-die" placeholder="REF-000">
                </div>
                <div class="field-group">
                    <label>Grabado / Plancha</label>
                    <input type="text" id="f-engrave" placeholder="G-123">
                </div>
                <div class="field-group">
                    <label>Material</label>
                    <input type="text" id="f-material" placeholder="Ej: PP Mate">
                </div>
                <div class="field-group">
                    <label>Acabado</label>
                    <input type="text" id="f-finish" placeholder="Laminado, Barniz...">
                </div>
                <div class="field-group" style="grid-column: span 2;">
                    <label>Observaciones de Producción</label>
                    <textarea id="f-notes" rows="3" placeholder="Instrucciones críticas..."></textarea>
                </div>
                <div class="field-group">
                    <label>Color de Prioridad</label>
                    <input type="color" id="f-color" value="#ff7a00" style="height: 60px; padding: 5px;">
                </div>
            </div>
            <div style="display: flex; gap: 15px; margin-top: 30px;">
                <button class="btn btn-accent" style="flex: 1;" onclick="saveJob()">CONFIRMAR ORDEN</button>
                <button id="btn-delete-job" class="btn btn-red" style="display: none;" onclick="deleteJob()">BORRAR</button>
                <button class="btn btn-dark" onclick="closeJobModal()">CANCELAR</button>
            </div>
        </div>
    </div>

    <div id="timer-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 800px;">
            <div id="timer-header" style="text-align: center;">
                <h1 id="t-client-name" style="margin: 0;">CLIENTE</h1>
                <div id="t-status-badge" style="display: inline-block; margin-top: 10px;">ESTADO</div>
            </div>

            <div class="workflow-grid">
                <div class="stat-card">
                    <label>TIEMPO TRANSCURRIDO</label>
                    <div id="timer-val" class="val">00:00:00</div>
                </div>
                <div class="stat-card">
                    <label>VELOCIDAD MEDIA</label>
                    <div id="speed-val" class="val" style="color: var(--blue);">0</div>
                    <span style="font-size: 11px; color: var(--text-dim);">METROS / MINUTO</span>
                </div>
            </div>

            <div id="controls-pre" style="display: none;">
                <button class="btn btn-accent" style="height: 100px; font-size: 22px; width: 100%;" onclick="changeStatus('TIRAJE')">
                    <i class="fas fa-play"></i> COMENZAR TIRAJE
                </button>
            </div>

            <div id="controls-run" style="display: none;">
                <div style="display: grid; grid-template-columns: 1fr 1.5fr; gap: 20px; margin-bottom: 20px;">
                    <button class="btn btn-red" style="height: 80px;" onclick="openIncident()">
                        <i class="fas fa-pause"></i> REGISTRAR PARADA
                    </button>
                    <div class="stat-card" style="padding: 10px;">
                        <label>METROS PRODUCIDOS</label>
                        <input type="number" id="m-real" style="border: none; background: transparent; text-align: center; font-size: 32px; font-weight: 900; color: #fff;" placeholder="0">
                    </div>
                </div>
                <button class="btn btn-green" style="height: 80px; width: 100%; font-size: 20px;" onclick="finishJob()">
                    <i class="fas fa-check-circle"></i> FINALIZAR ORDEN
                </button>
            </div>

            <div id="incident-panel" style="display: none; background: rgba(255,71,87,0.1); border: 1px solid var(--red); padding: 25px; border-radius: 25px; margin-top: 20px;">
                <h4 style="margin: 0 0 15px 0; color: var(--red);">MOTIVO DE LA PARADA</h4>
                <select id="incident-type">
                    <option value="Limpieza">Limpieza de Máquina</option>
                    <option value="Avería">Avería Mecánica / Eléctrica</option>
                    <option value="Material">Falta de Material / Tinta</option>
                    <option value="Ajuste">Ajuste de Registro / Color</option>
                    <option value="Cambio">Cambio de Bobina</option>
                    <option value="Otros">Otros (Especificar en notas)</option>
                </select>
                <button class="btn btn-red" style="margin-top: 15px; width: 100%;" onclick="confirmIncident()">CONFIRMAR INCIDENCIA</button>
            </div>

            <button class="btn btn-outline" style="margin-top: 20px; width: 100%;" onclick="closeTimerModal()">CERRAR Y SEGUIR EN SEGUNDO PLANO</button>
        </div>
    </div>

    <audio id="sound-success" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3"></audio>

    <script>
        /**
         * TRACKLABEL PRO - MOTOR LÓGICO
         * @author Ivan & Gemini Pro
         * @version 2026.1
         */

        // --- ESTADO GLOBAL ---
        let DB = JSON.parse(localStorage.getItem('tl_v2026_db')) || {};
        let LOGS = JSON.parse(localStorage.getItem('tl_v2026_logs')) || [];
        let STATS = JSON.parse(localStorage.getItem('tl_v2026_stats')) || { done: 0, meters: 0 };
        
        let CURRENT_USER = null;
        let SELECTED_USER_TMP = null;
        let ACTIVE_JOB_ID = null;
        let CLOCK_TIMER = null;

        const MASTER_KEY = "TrackLabel#";
        const USERS = {
            "Ivan": "1234", "Isa": "1234", "Jaume": "1234",
            "Anna": "1234", "Toni": "1234", "Admin": "0000"
        };

        // --- SISTEMA DE ACCESO ---
        function unlockSystem() {
            const val = document.getElementById('master-input').value;
            if(val === MASTER_KEY) {
                document.getElementById('master-lock').style.display = 'none';
                document.getElementById('login-screen').style.display = 'flex';
            } else {
                alert("Código de terminal incorrecto.");
            }
        }

        function selectUser(name, el) {
            SELECTED_USER_TMP = name;
            document.querySelectorAll('.user-card').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
        }

        function attemptLogin() {
            const pin = document.getElementById('user-pin').value;
            if(SELECTED_USER_TMP && USERS[SELECTED_USER_TMP] === pin) {
                CURRENT_USER = SELECTED_USER_TMP;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-shell').style.display = 'flex';
                document.getElementById('user-name').innerText = CURRENT_USER;
                document.getElementById('user-initial').innerText = CURRENT_USER.charAt(0);
                document.getElementById('user-pin').value = "";
                initApp();
            } else {
                alert("PIN incorrecto o usuario no seleccionado.");
            }
        }

        function logout() {
            if(confirm("¿Cerrar sesión de operario?")) {
                location.reload();
            }
        }

        // --- GESTIÓN DE ÓRDENES ---
        function initApp() {
            renderKanban();
            updateUI();
            initDragAndDrop();
        }

        function openJobModal(id = null) {
            ACTIVE_JOB_ID = id;
            const modal = document.getElementById('job-modal');
            const title = document.getElementById('modal-title');
            const btnDel = document.getElementById('btn-delete-job');
            
            if(id) {
                const j = DB[id];
                title.innerText = "EDITAR ORDEN: " + j.client;
                document.getElementById('f-client').value = j.client;
                document.getElementById('f-machine').value = j.lane;
                document.getElementById('f-meters').value = j.meters;
                document.getElementById('f-die').value = j.die;
                document.getElementById('f-engrave').value = j.engrave;
                document.getElementById('f-material').value = j.material;
                document.getElementById('f-finish').value = j.finish;
                document.getElementById('f-notes').value = j.notes;
                document.getElementById('f-color').value = j.color;
                btnDel.style.display = "block";
            } else {
                title.innerText = "NUEVA ORDEN DE FABRICACIÓN";
                resetForm();
                btnDel.style.display = "none";
            }
            modal.style.display = 'flex';
        }

        function saveJob() {
            const id = ACTIVE_JOB_ID || "OT-" + Date.now();
            const client = document.getElementById('f-client').value;
            if(!client) return alert("El nombre del cliente es obligatorio");

            DB[id] = {
                id: id,
                client: client,
                lane: document.getElementById('f-machine').value,
                meters: document.getElementById('f-meters').value || 0,
                die: document.getElementById('f-die').value || "-",
                engrave: document.getElementById('f-engrave').value || "-",
                material: document.getElementById('f-material').value || "-",
                finish: document.getElementById('f-finish').value || "-",
                notes: document.getElementById('f-notes').value || "",
                color: document.getElementById('f-color').value,
                status: DB[id]?.status || "ESPERA",
                startTime: DB[id]?.startTime || null,
                totalTime: DB[id]?.totalTime || 0,
                stops: DB[id]?.stops || 0,
                operator: DB[id]?.operator || CURRENT_USER
            };

            saveToStorage();
            closeJobModal();
            renderKanban();
        }

        function deleteJob() {
            if(confirm("¿Estás seguro de eliminar esta orden? Se perderán los datos.")) {
                delete DB[ACTIVE_JOB_ID];
                saveToStorage();
                closeJobModal();
                renderKanban();
            }
        }

        // --- WORKFLOW Y TIEMPOS ---
        function openTimerModal(id) {
            ACTIVE_JOB_ID = id;
            const j = DB[id];
            const modal = document.getElementById('timer-modal');
            
            document.getElementById('t-client-name').innerText = j.client;
            updateTimerDisplay(j);

            // Mostrar controles según estado
            const cPre = document.getElementById('controls-pre');
            const cRun = document.getElementById('controls-run');
            const inc = document.getElementById('incident-panel');

            inc.style.display = "none";

            if(j.status === "ESPERA") {
                j.status = "PREPARACIÓN";
                j.startTime = Date.now();
                j.operator = CURRENT_USER;
                addLog(`PREP: ${CURRENT_USER} inició preparación de ${j.client}`);
                saveToStorage();
            }

            if(j.status === "PREPARACIÓN") {
                cPre.style.display = "block";
                cRun.style.display = "none";
            } else {
                cPre.style.display = "none";
                cRun.style.display = "block";
            }

            modal.style.display = 'flex';
            startLiveClock();
        }

        function changeStatus(newStatus) {
            const j = DB[ACTIVE_JOB_ID];
            j.status = newStatus;
            addLog(`${newStatus}: ${j.client} entra en fase de ${newStatus}`);
            saveToStorage();
            openTimerModal(ACTIVE_JOB_ID); // Refrescar vista
        }

        function startLiveClock() {
            if(CLOCK_TIMER) clearInterval(CLOCK_TIMER);
            CLOCK_TIMER = setInterval(() => {
                const j = DB[ACTIVE_JOB_ID];
                if(!j) return;
                const diff = Date.now() - j.startTime;
                document.getElementById('timer-val').innerText = formatTime(diff);
                
                // Cálculo velocidad m/min
                const mReal = document.getElementById('m-real').value || 0;
                const mins = diff / 60000;
                const speed = mins > 0 ? Math.round(mReal / mins) : 0;
                document.getElementById('speed-val').innerText = speed;
            }, 1000);
        }

        function openIncident() {
            document.getElementById('incident-panel').style.display = 'block';
        }

        function confirmIncident() {
            const type = document.getElementById('incident-type').value;
            const j = DB[ACTIVE_JOB_ID];
            j.stops++;
            addLog(`STOP: Parada en ${j.client} por ${type}`);
            saveToStorage();
            document.getElementById('incident-panel').style.display = 'none';
            alert("Incidencia registrada. La máquina sigue en pausa.");
        }

        function finishJob() {
            const mReal = document.getElementById('m-real').value;
            if(!mReal || mReal <= 0) return alert("Debes introducir los metros reales producidos.");

            const j = DB[ACTIVE_JOB_ID];
            const finalTime = Date.now() - j.startTime;
            
            // Guardar en estadísticas
            STATS.done++;
            STATS.meters += parseInt(mReal);
            
            addLog(`FIN: ${j.client} finalizado | ${mReal}m en ${formatTime(finalTime)}`);
            
            document.getElementById('sound-success').play();
            delete DB[ACTIVE_JOB_ID];
            saveToStorage();
            closeTimerModal();
            renderKanban();
            updateUI();
        }

        // --- UTILIDADES ---
        function renderKanban() {
            const lanes = ['lane-flexo', 'lane-digital', 'lane-repaso'];
            lanes.forEach(l => document.getElementById(l).innerHTML = "");

            const searchVal = document.getElementById('job-search').value.toLowerCase();

            Object.keys(DB).forEach(id => {
                const j = DB[id];
                if(j.client.toLowerCase().includes(searchVal) || j.material.toLowerCase().includes(searchVal)) {
                    const card = document.createElement('div');
                    card.className = "job-card";
                    card.id = j.id;
                    card.style.borderLeftColor = j.color;
                    card.onclick = () => {
                        if(j.status === "ESPERA") openJobModal(j.id);
                        else openTimerModal(j.id);
                    };

                    card.innerHTML = `
                        <div class="status-pill" style="background: ${getStatusColor(j.status)}">
                            ${j.status}
                        </div>
                        <h4>${j.client.toUpperCase()}</h4>
                        <div class="card-meta">
                            <span class="badge"><i class="fas fa-ruler"></i> ${j.meters}m</span>
                            <span class="badge"><i class="fas fa-scissors"></i> T: ${j.die}</span>
                            <span class="badge"><i class="fas fa-layer-group"></i> ${j.material}</span>
                        </div>
                        <div style="font-size: 10px; color: var(--text-dim); display: flex; justify-content: space-between;">
                            <span><i class="fas fa-user"></i> ${j.operator}</span>
                            <span>${j.stops > 0 ? '⚠️ '+j.stops+' Paradas' : ''}</span>
                        </div>
                    `;
                    document.getElementById(j.lane).appendChild(card);
                }
            });
            updateLaneCounters();
        }

        function initDragAndDrop() {
            ['lane-flexo', 'lane-digital', 'lane-repaso'].forEach(laneId => {
                new Sortable(document.getElementById(laneId), {
                    group: 'production',
                    animation: 250,
                    ghostClass: 'sortable-ghost',
                    onEnd: (evt) => {
                        const jobId = evt.item.id;
                        DB[jobId].lane = evt.to.id;
                        saveToStorage();
                        updateLaneCounters();
                    }
                });
            });
        }

        function formatTime(ms) {
            let s = Math.floor(ms / 1000);
            let m = Math.floor(s / 60);
            let h = Math.floor(m / 60);
            s %= 60; m %= 60;
            return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        }

        function getStatusColor(status) {
            switch(status) {
                case 'TIRAJE': return 'var(--green)';
                case 'PREPARACIÓN': return 'var(--blue)';
                case 'PARADA': return 'var(--red)';
                default: return 'var(--border)';
            }
        }

        function addLog(msg) {
            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            LOGS.unshift({time, msg});
            if(LOGS.length > 20) LOGS.pop();
            saveToStorage();
            updateLogUI();
        }

        function updateLogUI() {
            const container = document.getElementById('log-list');
            container.innerHTML = LOGS.map(l => `
                <div style="font-size: 10px; padding: 8px; border-radius: 10px; background: rgba(255,255,255,0.03);">
                    <b style="color:var(--accent)">[${l.time}]</b> ${l.msg}
                </div>
            `).join('');
        }

        function updateUI() {
            const pct = STATS.done > 0 ? Math.min(100, (STATS.done / 10) * 100) : 0;
            document.getElementById('main-progress-bar').style.width = pct + "%";
            document.getElementById('progress-pct').innerText = Math.round(pct) + "%";
            document.getElementById('jobs-done').innerText = STATS.done + " COMPLETADOS";
            updateLogUI();
        }

        function updateLaneCounters() {
            ['flexo', 'digital', 'repaso'].forEach(l => {
                document.getElementById('count-'+l).innerText = document.getElementById('lane-'+l).children.length;
            });
        }

        function filterJobs() { renderKanban(); }
        function saveToStorage() {
            localStorage.setItem('tl_v2026_db', JSON.stringify(DB));
            localStorage.setItem('tl_v2026_logs', JSON.stringify(LOGS));
            localStorage.setItem('tl_v2026_stats', JSON.stringify(STATS));
        }

        function resetForm() {
            const fields = ['f-client', 'f-meters', 'f-die', 'f-engrave', 'f-material', 'f-finish', 'f-notes'];
            fields.forEach(f => document.getElementById(f).value = "");
            document.getElementById('f-color').value = "#ff7a00";
            document.getElementById('f-machine').value = "lane-flexo";
        }

        function closeJobModal() { document.getElementById('job-modal').style.display = 'none'; }
        function closeTimerModal() { 
            document.getElementById('timer-modal').style.display = 'none'; 
            clearInterval(CLOCK_TIMER);
            renderKanban(); 
        }

        function updateTimerDisplay(j) {
            const badge = document.getElementById('t-status-badge');
            badge.innerText = j.status;
            badge.style.background = getStatusColor(j.status);
            badge.style.color = (j.status === 'ESPERA') ? '#fff' : '#000';
            badge.style.padding = "5px 20px";
            badge.style.borderRadius = "100px";
            badge.style.fontWeight = "900";
        }

        // --- PANEL DE ADMINISTRACIÓN (VISTA RÁPIDA) ---
        function toggleAdminPanel() {
            alert(`RESUMEN JORNADA:\n\nÓrdenes finalizadas: ${STATS.done}\nMetros totales: ${STATS.meters}m\nOperario actual: ${CURRENT_USER}`);
        }

        // Teclado físico: ESC para cerrar modales
        window.onkeydown = function(e) {
            if(e.key === "Escape") { closeJobModal(); closeTimerModal(); }
        }
    </script>
</body>
</html>
