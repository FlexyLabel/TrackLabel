<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Track Label Pro - Control de Tiempos</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --bg: #0b0e11;
            --sidebar: #15191d;
            --surface: #1e2329;
            --orange: #ff7a00;
            --green: #00ff88;
            --red: #ff4444;
            --text: #f0f0f0;
            --border: #282e35;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: var(--bg); 
            color: var(--text); 
            font-family: 'Segoe UI', sans-serif; 
            margin: 0; 
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* --- SEGURIDAD --- */
        #master-lock {
            position: fixed; inset: 0; background: #000; z-index: 50000;
            display: flex; align-items: center; justify-content: center; padding: 20px;
        }

        .lock-box {
            background: var(--surface); padding: 40px; border-radius: 35px;
            text-align: center; border: 1px solid var(--border); width: 100%; max-width: 400px;
        }

        /* --- LOGIN --- */
        .login-overlay {
            position: fixed; inset: 0; background: var(--bg); z-index: 40000;
            display: flex; align-items: center; justify-content: center;
        }

        .user-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 25px 0;
        }

        .user-btn {
            background: var(--sidebar); padding: 20px; border-radius: 20px;
            border: 1px solid #333; cursor: pointer; text-align: center;
        }

        .user-btn.selected { border-color: var(--orange); background: #222; }

        /* --- LAYOUT PRINCIPAL --- */
        .app-container {
            display: flex;
            flex-direction: row;
            min-height: 100vh;
        }

        /* COLUMNA PLANTA (SIDEBAR) */
        .sidebar-planta {
            width: 320px;
            background: var(--sidebar);
            border-right: 1px solid var(--border);
            padding: 25px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .panel-stats {
            background: var(--surface); padding: 20px; border-radius: 25px;
            border: 1px solid var(--border);
        }

        .panel-stats h4 { margin: 0 0 10px 0; font-size: 11px; color: var(--orange); letter-spacing: 1px; }

        .bar-bg { background: #000; height: 10px; border-radius: 5px; margin: 10px 0; overflow: hidden; }
        .bar-fill { background: var(--orange); height: 100%; width: 0%; transition: 0.5s; }

        /* CONTENIDO - M√ÅQUINAS EN VERTICAL */
        .main-content {
            flex: 1;
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* FUERZA LA VERTICALIDAD */
        .kanban-vertical {
            display: flex;
            flex-direction: column !important; 
            gap: 25px;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }

        .machine-block {
            background: var(--sidebar);
            border-radius: 25px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .machine-header {
            padding: 15px 25px;
            background: rgba(255,255,255,0.03);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #222;
        }

        .drop-zone {
            padding: 15px;
            min-height: 100px;
        }

        /* --- TARJETAS --- */
        .job-card {
            background: var(--surface);
            padding: 18px;
            border-radius: 20px;
            margin-bottom: 15px;
            border-left: 6px solid var(--orange);
            cursor: pointer;
            transition: 0.2s;
        }

        .job-card:active { transform: scale(0.98); }

        .job-card .status-dot {
            height: 8px; width: 8px; border-radius: 50%; display: inline-block; margin-right: 5px;
        }

        /* --- MODALES --- */
        .modal {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9);
            z-index: 20000; padding: 20px; overflow-y: auto;
        }

        .modal-box {
            background: var(--surface); border-radius: 30px; padding: 30px;
            width: 100%; max-width: 500px; margin: 0 auto; border: 1px solid #444;
        }

        .btn-action {
            width: 100%; padding: 18px; border-radius: 15px; border: none;
            font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 15px;
        }

        .btn-orange { background: var(--orange); color: white; }
        .btn-green { background: var(--green); color: #000; }
        .btn-red { background: var(--red); color: white; }

        input, select {
            width: 100%; padding: 15px; background: #000; border: 1px solid #333;
            color: white; border-radius: 12px; margin-bottom: 15px;
        }

        /* RESPONSIVE */
        @media (max-width: 850px) {
            .app-container { flex-direction: column; }
            .sidebar-planta { width: 100%; border-right: none; border-bottom: 1px solid var(--border); }
        }
    </style>
</head>
<body>

<div id="master-lock">
    <div class="lock-box">
        <h2 style="color:var(--orange)">TRACK LABEL</h2>
        <p>Introduce la contrase√±a maestra</p>
        <input type="password" id="m-pass" placeholder="Contrase√±a">
        <button class="btn-action btn-orange" onclick="unlock()">ENTRAR</button>
    </div>
</div>

<div id="login-screen" class="login-overlay" style="display:none">
    <div class="lock-box">
        <h3>SELECCIONAR OPERARIO</h3>
        <div class="user-grid">
            <div class="user-btn" onclick="selUser('Ivan', this)">I</div>
            <div class="user-btn" onclick="selUser('Isa', this)">I</div>
            <div class="user-btn" onclick="selUser('Jaume', this)">J</div>
            <div class="user-btn" onclick="selUser('Anna', this)">A</div>
            <div class="user-btn" onclick="selUser('Toni', this)">T</div>
        </div>
        <input type="password" id="u-pin" placeholder="PIN">
        <button class="btn-action btn-orange" onclick="login()">ACCEDER AL PANEL</button>
    </div>
</div>

<div id="app-main" class="app-container" style="display:none">
    
    <aside class="sidebar-planta">
        <div style="display:flex; align-items:center; gap:10px;">
            <div style="background:var(--orange); padding:8px; border-radius:10px; color:black; font-weight:900;">TL</div>
            <h3 style="margin:0">PLANTA</h3>
        </div>

        <div class="panel-stats">
            <h4>RENDIMIENTO DIARIO</h4>
            <div class="bar-bg"><div id="prog-bar" class="bar-fill"></div></div>
            <span id="prog-text" style="font-size:12px;">0% completado</span>
        </div>

        <div class="panel-stats">
            <h4>TRABAJOS</h4>
            <div style="display:flex; justify-content:space-between;">Activos: <strong id="s-act">0</strong></div>
            <div style="display:flex; justify-content:space-between;">Hechos: <strong id="s-fin" style="color:var(--green)">0</strong></div>
        </div>

        <div class="panel-stats" style="flex:1;">
            <h4>HISTORIAL</h4>
            <div id="log" style="font-size:11px; color:#555; overflow-y:auto; max-height:200px;"></div>
        </div>
    </aside>

    <main class="main-content">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 id="welcome" style="margin:0">Hola, Iv√°n</h2>
            <button class="btn-action btn-orange" style="width:auto; padding:10px 20px" onclick="openNew()">+ NUEVO</button>
        </div>

        <div class="kanban-vertical">
            <div class="machine-block">
                <div class="machine-header">FLEXO <span id="c-flexo" style="color:var(--orange)">0</span></div>
                <div id="list-flexo" class="drop-zone"></div>
            </div>
            <div class="machine-block">
                <div class="machine-header">DIGITAL <span id="c-digital" style="color:var(--orange)">0</span></div>
                <div id="list-digital" class="drop-zone"></div>
            </div>
            <div class="machine-block">
                <div class="machine-header">REPASO <span id="c-repaso" style="color:var(--orange)">0</span></div>
                <div id="list-acabados" class="drop-zone"></div>
            </div>
        </div>
    </main>
</div>

<div id="modal-new" class="modal">
    <div class="modal-box">
        <h3>NUEVA ORDEN</h3>
        <input type="text" id="in-cli" placeholder="Cliente">
        <input type="number" id="in-met" placeholder="Metros">
        <input type="text" id="in-tec" placeholder="Ref. Troquel/Grabado">
        <select id="in-maq">
            <option value="list-flexo">FLEXO</option>
            <option value="list-digital">DIGITAL</option>
        </select>
        <button class="btn-action btn-orange" onclick="saveJob()">GUARDAR</button>
        <button class="btn-action" style="background:none; color:#555" onclick="closeNew()">Cancelar</button>
    </div>
</div>

<div id="modal-time" class="modal">
    <div class="modal-box" id="time-content">
        </div>
</div>

<script>
const MASTER = "TrackLabel#";
const USERS = {"Ivan":"1234", "Isa":"1234", "Jaume":"1234", "Anna":"1234", "Toni":"1234"};

let db = JSON.parse(localStorage.getItem('tl_db_v3')) || {};
let finCount = parseInt(localStorage.getItem('tl_fin_v3')) || 0;
let user = "Iv√°n";
let activeJobId = null;

// SEGURIDAD
function unlock() {
    if(document.getElementById('m-pass').value === MASTER) {
        document.getElementById('master-lock').style.display = 'none';
        document.getElementById('login-screen').style.display = 'flex';
    } else { alert("Error"); }
}

function selUser(n, el) {
    user = n;
    document.querySelectorAll('.user-btn').forEach(b => b.classList.remove('selected'));
    el.classList.add('selected');
}

function login() {
    if(USERS[user] === document.getElementById('u-pin').value) {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app-main').style.display = 'flex';
        document.getElementById('welcome').innerText = "Hola, " + user;
        render();
        initSort();
    } else { alert("PIN incorrecto"); }
}

// PRODUCCI√ìN
function render() {
    document.querySelectorAll('.drop-zone').forEach(z => z.innerHTML = "");
    Object.keys(db).forEach(id => {
        const item = db[id];
        const card = document.createElement('div');
        card.className = "job-card";
        card.id = id;
        card.onclick = () => openTime(id);
        
        let statusColor = item.start ? 'var(--green)' : '#555';
        if(item.end) statusColor = 'var(--red)';

        card.innerHTML = `
            <div style="display:flex; justify-content:space-between;">
                <strong>${item.cli.toUpperCase()}</strong>
                <span class="status-dot" style="background:${statusColor}"></span>
            </div>
            <div style="font-size:12px; color:#777; margin-top:5px;">
                üìè ${item.met}m | üõ†Ô∏è ${item.tec}
            </div>
        `;
        document.getElementById(item.maq).appendChild(card);
    });
    updateUI();
}

function saveJob() {
    const cli = document.getElementById('in-cli').value;
    const met = document.getElementById('in-met').value;
    if(!cli || !met) return;
    const id = "ID-"+Date.now();
    db[id] = { cli, met, maq: document.getElementById('in-maq').value, tec: document.getElementById('in-tec').value || "S/N", start: null, end: null };
    save();
    closeNew();
    addLog("Creado: " + cli);
}

function openTime(id) {
    activeJobId = id;
    const item = db[id];
    const box = document.getElementById('time-content');
    box.innerHTML = `
        <h2 style="margin:0">${item.cli}</h2>
        <p style="color:#666">Metros: ${item.met} | Ref: ${item.tec}</p>
        <hr border="0" style="border-top:1px solid #333; margin:20px 0">
        
        ${!item.start ? 
            `<button class="btn-action btn-green" onclick="timerAction('start')">INICIAR TRABAJO</button>` : 
            `<div style="color:var(--green); margin-bottom:10px;">Iniciado a las: ${item.start}</div>`
        }

        ${item.start && !item.end ? 
            `<button class="btn-action btn-red" onclick="timerAction('end')">FINALIZAR Y ARCHIVAR</button>` : 
            ""
        }

        <button class="btn-action" style="background:#222; color:white" onclick="closeTime()">CERRAR</button>
    `;
    document.getElementById('modal-time').style.display = 'block';
}

function timerAction(type) {
    const now = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    if(type === 'start') {
        db[activeJobId].start = now;
        addLog("‚ñ∂ Inici√≥: " + db[activeJobId].cli);
    } else {
        addLog("‚úî Termin√≥: " + db[activeJobId].cli);
        delete db[activeJobId];
        finCount++;
    }
    save();
    closeTime();
}

function initSort() {
    document.querySelectorAll('.drop-zone').forEach(z => {
        new Sortable(z, { group: 'p', animation: 150, onEnd: (e) => {
            db[e.item.id].maq = e.to.id;
            save();
        }});
    });
}

function save() {
    localStorage.setItem('tl_db_v3', JSON.stringify(db));
    localStorage.setItem('tl_fin_v3', finCount);
    render();
}

function updateUI() {
    document.getElementById('s-act').innerText = Object.keys(db).length;
    document.getElementById('s-fin').innerText = finCount;
    document.getElementById('c-flexo').innerText = document.getElementById('list-flexo').children.length;
    document.getElementById('c-digital').innerText = document.getElementById('list-digital').children.length;
    document.getElementById('c-repaso').innerText = document.getElementById('list-acabados').children.length;
    
    const total = Object.keys(db).length + finCount;
    const perc = total === 0 ? 0 : Math.round((finCount/total)*100);
    document.getElementById('prog-bar').style.width = perc + "%";
    document.getElementById('prog-text').innerText = perc + "% completado hoy";
}

function addLog(m) {
    const l = document.getElementById('log');
    l.innerHTML = `<div>[${new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}] ${m}</div>` + l.innerHTML;
}

function openNew() { document.getElementById('modal-new').style.display = 'block'; }
function closeNew() { document.getElementById('modal-new').style.display = 'none'; }
function closeTime() { document.getElementById('modal-time').style.display = 'none'; }
</script>
</body>
</html>
