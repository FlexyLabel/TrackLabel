<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TrackLabel Pro Enterprise | v2.6.5</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800;900&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-deep: #010204;
            --bg-panel: #0b0e14;
            --bg-surface: #151921;
            --bg-card: #1c212b;
            --accent: #ff7a00;
            --accent-glow: rgba(255, 122, 0, 0.4);
            --success: #2ea043;
            --warning: #f1e05a;
            --error: #f85149;
            --info: #388bfd;
            --text-main: #e6edf3;
            --text-dim: #8b949e;
            --border: #30363d;
            --radius-xl: 35px;
            --radius-lg: 20px;
        }

        /* --- RESET & BASE --- */
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body, html { 
            background: var(--bg-deep); color: var(--text-main); 
            font-family: 'Inter', sans-serif; margin: 0; padding: 0; 
            height: 100vh; width: 100vw; overflow: hidden;
        }

        /* --- ACCESO --- */
        .system-lock {
            position: fixed; inset: 0; background: var(--bg-deep); z-index: 99999;
            display: flex; align-items: center; justify-content: center; padding: 30px;
        }
        .lock-container {
            background: var(--bg-panel); border: 1px solid var(--border);
            padding: 50px; border-radius: var(--radius-xl); width: 100%; max-width: 500px;
            text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        /* --- APP LAYOUT --- */
        .app-layout { display: flex; height: 100vh; width: 100vw; }
        
        .sidebar { 
            width: 320px; background: var(--bg-panel); border-right: 1px solid var(--border); 
            display: flex; flex-direction: column; flex-shrink: 0;
        }
        
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: #05070a; }

        /* --- HEADER --- */
        .top-nav {
            height: 90px; padding: 0 40px; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            background: var(--bg-panel);
        }

        /* --- KANBAN BOARD --- */
        .kanban-view { 
            flex: 1; overflow-x: auto; overflow-y: hidden; padding: 30px; 
            display: flex; gap: 30px; align-items: flex-start;
        }
        .lane { 
            background: rgba(11, 14, 20, 0.5); border-radius: 30px; border: 1px solid var(--border); 
            width: 400px; flex-shrink: 0; max-height: 100%; display: flex; flex-direction: column;
        }
        .lane-header { padding: 25px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .lane-header h3 { margin: 0; font-size: 13px; letter-spacing: 2px; color: var(--text-dim); text-transform: uppercase; }
        
        .job-container { 
            padding: 20px; overflow-y: auto; flex: 1; min-height: 150px;
            /* Evita que el scroll se bloquee con Sortable */
            scrollbar-width: thin; scrollbar-color: var(--border) transparent;
        }

        /* --- JOB CARDS (CON SOPORTE DRAG) --- */
        .job-card {
            background: var(--bg-surface); border-radius: 25px; padding: 22px;
            border-left: 10px solid var(--accent); position: relative;
            margin-bottom: 20px; cursor: grab; /* Indica que es arrastrable */
            transition: transform 0.2s, box-shadow 0.2s;
            user-select: none;
        }
        .job-card:active { cursor: grabbing; }
        .job-card.sortable-ghost { opacity: 0.3; transform: scale(0.95); border: 2px dashed var(--accent); }
        .job-card h4 { margin: 0 0 12px 0; font-size: 20px; font-weight: 800; pointer-events: none; }

        .card-tags { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; pointer-events: none; }
        .tag { background: rgba(0,0,0,0.3); padding: 5px 12px; border-radius: 10px; font-size: 10px; border: 1px solid var(--border); color: var(--text-dim); }

        /* ÁREA DE ACCIÓN (MARCADA EN AZUL) */
        .action-area {
            background: rgba(255, 122, 0, 0.05);
            border: 1px dashed var(--border);
            border-radius: 15px;
            padding: 12px;
            margin-top: 10px;
        }
        .btn-direct-action {
            width: 100%; padding: 14px; border-radius: 12px; border: none;
            font-weight: 900; font-size: 12px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            text-transform: uppercase; transition: 0.3s;
        }
        .btn-st-espera { background: var(--accent); color: #000; }
        .btn-st-prep { background: var(--info); color: #fff; }
        .btn-st-run { background: var(--success); color: #fff; }

        /* --- MODALES --- */
        .modal-mask {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 80000;
            display: none; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(10px);
        }
        .modal-body {
            background: var(--bg-panel); border: 1px solid var(--border); width: 100%;
            max-width: 800px; border-radius: 40px; padding: 45px; max-height: 90vh; overflow-y: auto;
        }

        /* --- CRONÓMETRO --- */
        .hero-clock {
            background: #000; border-radius: 30px; padding: 40px; text-align: center;
            border: 1px solid var(--border); margin: 25px 0; box-shadow: inset 0 0 30px rgba(0,0,0,0.5);
        }
        .clock-val { font-family: 'JetBrains Mono'; font-size: 80px; color: var(--success); letter-spacing: -2px; }

        /* --- INPUTS --- */
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        input, select, textarea {
            width: 100%; background: var(--bg-deep); border: 1px solid var(--border);
            color: #fff; padding: 18px; border-radius: 15px; font-size: 14px;
        }
        label { display: block; font-size: 11px; font-weight: 800; color: var(--accent); margin-bottom: 8px; text-transform: uppercase; }

        .btn-main { padding: 18px; border-radius: 15px; border: none; font-weight: 900; cursor: pointer; transition: 0.2s; }

    </style>
</head>
<body>

    <div id="screen-login" class="system-lock">
        <div class="lock-container">
            <i class="fas fa-microchip" style="font-size: 50px; color: var(--accent); margin-bottom: 20px;"></i>
            <h1>TRACKLABEL <span style="color:var(--accent)">PRO</span></h1>
            <input type="password" id="pin" placeholder="PIN OPERARIO" style="text-align: center; font-size: 24px; margin: 30px 0; letter-spacing: 8px;">
            <button class="btn-main" onclick="login()" style="width:100%; background:var(--accent); color:#000;">ENTRAR AL TURNO</button>
        </div>
    </div>

    <div id="app" class="app-layout" style="display: none;">
        <aside class="sidebar">
            <div style="padding:40px 30px; border-bottom:1px solid var(--border);">
                <div style="background:var(--bg-surface); padding:20px; border-radius:20px; display:flex; align-items:center; gap:15px;">
                    <div id="op-avatar" style="width:45px; height:45px; background:var(--accent); border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:900; color:#000; font-size:20px;">I</div>
                    <div>
                        <div id="op-name" style="font-weight:900; font-size:18px;">Ivan</div>
                        <div style="font-size:10px; color:var(--success); font-weight:800;">SISTEMA ACTIVO</div>
                    </div>
                </div>
            </div>
            <div id="audit-log" style="flex:1; padding:25px; overflow-y:auto; font-size:11px; color:var(--text-dim); line-height:1.8;"></div>
        </aside>

        <main class="main-content">
            <header class="top-nav">
                <input type="text" id="search" placeholder="Filtrar por cliente, material..." oninput="draw()" style="width:400px; border-radius:50px;">
                <button class="btn-main" onclick="openEditor()" style="background:var(--accent); padding:12px 30px;">+ NUEVA ORDEN</button>
            </header>

            <div class="kanban-view">
                <div class="lane">
                    <div class="lane-header"><h3>FLEXOGRAFÍA</h3><span id="c-flexo" class="tag">0</span></div>
                    <div id="lane-flexo" class="job-container"></div>
                </div>
                <div class="lane">
                    <div class="lane-header"><h3>IMPRESIÓN DIGITAL</h3><span id="c-digital" class="tag">0</span></div>
                    <div id="lane-digital" class="job-container"></div>
                </div>
                <div class="lane">
                    <div class="lane-header"><h3>REPASO / ACABADO</h3><span id="c-repaso" class="tag">0</span></div>
                    <div id="lane-repaso" class="job-container"></div>
                </div>
            </div>
        </main>
    </div>

    <div id="modal-editor" class="modal-mask">
        <div class="modal-body">
            <h2 id="ed-title" style="margin-bottom:30px;">GESTIÓN DE ORDEN</h2>
            <div class="form-row">
                <div style="grid-column: span 2;"><label>Cliente / Trabajo</label><input type="text" id="f-cli"></div>
                <div><label>Línea de Producción</label>
                    <select id="f-lane">
                        <option value="lane-flexo">FLEXOGRAFÍA</option>
                        <option value="lane-digital">DIGITAL</option>
                        <option value="lane-repaso">REPASO</option>
                    </select>
                </div>
                <div><label>Metros Planificados</label><input type="number" id="f-met"></div>
                <div><label>Referencia Troquel</label><input type="text" id="f-tro"></div>
                <div><label>Material / Sustrato</label><input type="text" id="f-mat"></div>
            </div>
            <div style="display:flex; gap:15px; margin-top:20px;">
                <button class="btn-main" onclick="save()" style="flex:2; background:var(--accent);">GUARDAR EN TABLERO</button>
                <button class="btn-main" id="btn-del" onclick="removeJob()" style="flex:1; background:var(--error); display:none;">ELIMINAR</button>
                <button class="btn-main" onclick="closeModal('modal-editor')" style="flex:1; background:var(--bg-surface); color:#fff; border:1px solid var(--border);">CANCELAR</button>
            </div>
        </div>
    </div>

    <div id="modal-prod" class="modal-mask">
        <div class="modal-body" style="max-width:900px;">
            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                <div>
                    <h1 id="p-cli" style="margin:0; font-size:35px; font-weight:900;">CLIENTE</h1>
                    <p id="p-detalles" style="color:var(--text-dim); margin-top:10px;"></p>
                </div>
                <div id="p-status-pill" style="padding:10px 25px; border-radius:100px; font-weight:900; font-size:12px;">ESTADO</div>
            </div>
            
            <div class="hero-clock">
                <div id="p-clock" class="clock-val">00:00:00</div>
                <div style="font-size:12px; letter-spacing:4px; color:var(--text-dim); margin-top:10px; font-weight:800;">CRONÓMETRO DE ACTIVIDAD</div>
            </div>

            <div class="form-row">
                <div><label>Metraje Real Producido</label><input type="number" id="p-real" style="font-size:30px; font-weight:900; text-align:center; color:var(--accent);"></div>
                <div><label>Velocidad Media (m/min)</label><div id="p-speed" style="padding:18px; border-radius:15px; background:var(--bg-deep); text-align:center; font-weight:900; font-size:30px;">0.0</div></div>
            </div>

            <div id="p-actions" style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-top:20px;"></div>
            
            <button class="btn-main" onclick="closeModal('modal-prod')" style="width:100%; margin-top:30px; background:transparent; border:1px solid var(--border); color:var(--text-dim);">VOLVER AL TABLERO (EL TIEMPO NO SE DETIENE)</button>
        </div>
    </div>

    <script>
        /**
         * LÓGICA DE NEGOCIO TRACKLABEL v2.6.5
         * Foco: Estabilidad de Tiempos y Drag & Drop
         */
        
        let JOBS = JSON.parse(localStorage.getItem('tl_enterprise_jobs')) || {};
        let activeId = null;
        let clockInterval = null;

        function login() {
            if(document.getElementById('pin').value === "1234") {
                document.getElementById('screen-login').style.display = 'none';
                document.getElementById('app').style.display = 'flex';
                init();
            } else { alert("PIN Incorrecto"); }
        }

        function init() {
            draw();
            initDraggable(); // Inicializa el arrastre
            addLog("Turno iniciado por Ivan");
        }

        function draw() {
            const query = document.getElementById('search').value.toLowerCase();
            const columns = ['lane-flexo', 'lane-digital', 'lane-repaso'];
            columns.forEach(c => document.getElementById(c).innerHTML = "");

            Object.keys(JOBS).forEach(id => {
                const j = JOBS[id];
                if(j.cli.toLowerCase().includes(query)) {
                    const card = document.createElement('div');
                    card.className = "job-card";
                    card.setAttribute('data-id', id); // Crítico para el arrastre
                    card.style.borderLeftColor = getStatusColor(j.status);

                    // Botón dinámico según el estado
                    let actionBtn = "";
                    if(j.status === "ESPERA") {
                        actionBtn = `<button class="btn-direct-action btn-st-espera" onclick="event.stopPropagation(); startPhase('${id}', 'PREPARACIÓN')"><i class="fas fa-play"></i> INICIAR PREPARACIÓN</button>`;
                    } else if(j.status === "PREPARACIÓN") {
                        actionBtn = `<button class="btn-direct-action btn-st-prep" onclick="event.stopPropagation(); startPhase('${id}', 'TIRAJE')"><i class="fas fa-rocket"></i> PASAR A TIRAJE</button>`;
                    } else {
                        actionBtn = `<button class="btn-direct-action btn-st-run" onclick="event.stopPropagation(); openProduction('${id}')"><i class="fas fa-cog fa-spin"></i> GESTIONAR PRODUCCIÓN</button>`;
                    }

                    card.innerHTML = `
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h4 onclick="event.stopPropagation(); openEditor('${id}')">${j.cli.toUpperCase()}</h4>
                            <span class="tag" style="background:rgba(0,0,0,0.5)">${j.status}</span>
                        </div>
                        <div class="card-tags">
                            <span class="tag"><i class="fas fa-ruler"></i> ${j.met}m</span>
                            <span class="tag"><i class="fas fa-fingerprint"></i> ${j.tro}</span>
                            <span class="tag"><i class="fas fa-layer-group"></i> ${j.mat}</span>
                        </div>
                        <div class="action-area">${actionBtn}</div>
                    `;
                    document.getElementById(j.lane).appendChild(card);
                }
            });
            updateStats();
        }

        // --- CONTROL DE TIEMPOS (LOGICA REALISTA) ---
        function startPhase(id, newStatus) {
            const j = JOBS[id];
            const now = Date.now();

            // Guardar tiempo acumulado de la fase que cerramos
            if(j.startTime) {
                j.totalMs = (j.totalMs || 0) + (now - j.startTime);
            }

            j.status = newStatus;
            j.startTime = now; // Nuevo punto de inicio
            
            addLog(`${j.cli} -> Nueva Fase: ${newStatus}`);
            save();
            draw();
            openProduction(id);
        }

        function openProduction(id) {
            activeId = id;
            const j = JOBS[id];
            
            document.getElementById('p-cli').innerText = j.cli;
            document.getElementById('p-detalles').innerText = `${j.mat} | Troquel: ${j.tro} | Planificado: ${j.met}m`;
            
            const pill = document.getElementById('p-status-pill');
            pill.innerText = j.status;
            pill.style.background = getStatusColor(j.status);
            pill.style.color = (j.status === 'ESPERA') ? '#fff' : '#000';
            
            document.getElementById('p-real').value = j.realMet || 0;

            const actions = document.getElementById('p-actions');
            actions.innerHTML = "";

            if(j.status === "PREPARACIÓN") {
                actions.innerHTML = `<button class="btn-main" onclick="startPhase('${id}', 'TIRAJE')" style="grid-column: span 2; background:var(--success); color:#fff; font-size:20px;">INICIAR PRODUCCIÓN (TIRAJE)</button>`;
            } else if(j.status === "TIRAJE") {
                actions.innerHTML = `
                    <button class="btn-main" onclick="startPhase('${id}', 'PARADA')" style="background:var(--error); color:#fff;">NOTIFICAR PARADA</button>
                    <button class="btn-main" onclick="finishOrder('${id}')" style="background:var(--success); color:#fff;">FINALIZAR Y CERRAR OT</button>
                `;
            } else if(j.status === "PARADA") {
                actions.innerHTML = `<button class="btn-main" onclick="startPhase('${id}', 'TIRAJE')" style="grid-column: span 2; background:var(--info); color:#fff;">REANUDAR TIRAJE</button>`;
            }

            document.getElementById('modal-prod').style.display = 'flex';
            
            if(clockInterval) clearInterval(clockInterval);
            clockInterval = setInterval(updateClock, 1000);
        }

        function updateClock() {
            const j = JOBS[activeId];
            if(!j || j.status === "PARADA" || !j.startTime) return;

            const total = (Date.now() - j.startTime) + (j.totalMs || 0);
            document.getElementById('p-clock').innerText = formatTime(total);
            
            // Calc velocidad
            const m = document.getElementById('p-real').value || 0;
            const mins = total / 60000;
            document.getElementById('p-speed').innerText = mins > 0 ? (m / mins).toFixed(1) : "0.0";
            j.realMet = m;
        }

        function finishOrder(id) {
            if(confirm("¿Confirmas que el pedido está terminado y quieres sacarlo del tablero?")) {
                addLog(`ORDEN COMPLETADA: ${JOBS[id].cli} (${JOBS[id].realMet} metros)`);
                delete JOBS[id];
                save();
                closeModal('modal-prod');
                draw();
            }
        }

        // --- ARRASTRE (DRAG & DROP) ---
        function initDraggable() {
            const containers = ['lane-flexo', 'lane-digital', 'lane-repaso'];
            containers.forEach(cid => {
                new Sortable(document.getElementById(cid), {
                    group: 'factory-workflow',
                    animation: 200,
                    ghostClass: 'sortable-ghost',
                    handle: '.job-card', // Se puede arrastrar desde cualquier parte de la tarjeta
                    filter: 'button, input, h4', // Pero no si haces clic en botones o el título
                    preventOnFilter: false,
                    onEnd: function(evt) {
                        const id = evt.item.getAttribute('data-id');
                        const newLane = evt.to.id;
                        
                        if(JOBS[id]) {
                            JOBS[id].lane = newLane;
                            save();
                            updateStats();
                            addLog(`Movido: ${JOBS[id].cli} a ${newLane.replace('lane-','')}`);
                        }
                    }
                });
            });
        }

        // --- FUNCIONES AUXILIARES ---
        function save() { localStorage.setItem('tl_enterprise_jobs', JSON.stringify(JOBS)); }
        
        function saveOrder() {
            const id = activeId || "OT-" + Date.now();
            JOBS[id] = {
                id,
                cli: document.getElementById('f-cli').value,
                met: document.getElementById('f-met').value,
                tro: document.getElementById('f-tro').value,
                mat: document.getElementById('f-mat').value,
                lane: document.getElementById('f-lane').value,
                status: JOBS[id]?.status || "ESPERA",
                totalMs: JOBS[id]?.totalMs || 0,
                realMet: JOBS[id]?.realMet || 0,
                startTime: JOBS[id]?.startTime || null
            };
            save();
            closeModal('modal-editor');
            draw();
        }

        function openEditor(id = null) {
            activeId = id;
            const delBtn = document.getElementById('btn-del');
            if(id) {
                const j = JOBS[id];
                document.getElementById('f-cli').value = j.cli;
                document.getElementById('f-met').value = j.met;
                document.getElementById('f-tro').value = j.tro;
                document.getElementById('f-mat').value = j.mat;
                document.getElementById('f-lane').value = j.lane;
                delBtn.style.display = "block";
            } else {
                ['f-cli','f-met','f-tro','f-mat'].forEach(i => document.getElementById(i).value = "");
                delBtn.style.display = "none";
            }
            document.getElementById('modal-editor').style.display = 'flex';
        }

        function removeJob() {
            if(confirm("¿Borrar permanentemente?")) {
                delete JOBS[activeId];
                save();
                closeModal('modal-editor');
                draw();
            }
        }

        function formatTime(ms) {
            let s = Math.floor(ms/1000), m = Math.floor(s/60), h = Math.floor(m/60);
            return `${h.toString().padStart(2,'0')}:${(m%60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
        }

        function getStatusColor(s) {
            if(s === 'TIRAJE') return 'var(--success)';
            if(s === 'PREPARACIÓN') return 'var(--info)';
            if(s === 'PARADA') return 'var(--error)';
            return 'var(--border)';
        }

        function closeModal(m) { 
            document.getElementById(m).style.display='none'; 
            if(m === 'modal-prod') clearInterval(clockInterval);
        }

        function addLog(m) {
            const l = document.getElementById('audit-log');
            const d = new Date().toLocaleTimeString();
            l.innerHTML = `<div><span style="color:var(--accent)">[${d}]</span> ${m}</div>` + l.innerHTML;
        }

        function updateStats() {
            ['flexo','digital','repaso'].forEach(l => {
                document.getElementById('c-'+l).innerText = document.getElementById('lane-'+l).children.length;
            });
        }

        // Alias para compatibilidad con el botón de guardar
        window.save = saveOrder;
    </script>
</body>
</html>
