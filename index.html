<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TrackLabel Pro v2026 | Industrial Control System</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-dark: #05070a;
            --bg-panel: #0d1117;
            --bg-card: #161b22;
            --bg-input: #010409;
            --accent: #ff7a00;
            --accent-soft: rgba(255, 122, 0, 0.15);
            --green: #238636;
            --green-glow: #3fb950;
            --red: #da3633;
            --blue: #1f6feb;
            --text-primary: #f0f6fc;
            --text-secondary: #8b949e;
            --border: #30363d;
            --shadow-lg: 0 15px 35px rgba(0,0,0,0.8);
            --radius: 24px;
        }

        /* --- ESTILOS BASE --- */
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { 
            background: var(--bg-dark); color: var(--text-primary); 
            font-family: 'Inter', sans-serif; margin: 0; padding: 0; 
            height: 100vh; overflow: hidden;
        }

        /* --- PANTALLAS DE BLOQUEO --- */
        .full-screen-lock {
            position: fixed; inset: 0; background: var(--bg-dark); z-index: 99999;
            display: flex; align-items: center; justify-content: center; padding: 20px;
            background-image: radial-gradient(circle at center, #161b22 0%, #05070a 100%);
        }
        .lock-content {
            background: var(--bg-panel); padding: 50px; border-radius: 40px;
            border: 1px solid var(--border); width: 100%; max-width: 500px;
            text-align: center; box-shadow: var(--shadow-lg);
            animation: fadeIn 0.5s ease-out;
        }

        .user-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 30px 0; }
        .user-box {
            background: var(--bg-card); padding: 20px 10px; border-radius: 20px;
            border: 2px solid var(--border); cursor: pointer; transition: 0.2s;
        }
        .user-box.selected { border-color: var(--accent); background: var(--accent-soft); transform: scale(1.05); }
        .user-box i { font-size: 24px; color: var(--accent); margin-bottom: 10px; display: block; }

        /* --- LAYOUT PRINCIPAL --- */
        .app-shell { display: flex; height: 100vh; width: 100vw; }

        /* SIDEBAR */
        .app-sidebar {
            width: 320px; background: var(--bg-panel); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; flex-shrink: 0;
        }
        .sb-top { padding: 30px; border-bottom: 1px solid var(--border); }
        .sb-main { flex: 1; overflow-y: auto; padding: 20px; }
        
        .active-user-card {
            background: var(--bg-card); padding: 20px; border-radius: 22px;
            display: flex; align-items: center; gap: 15px; border: 1px solid var(--border);
            margin-bottom: 25px;
        }
        .avatar-circle {
            width: 48px; height: 48px; background: var(--accent); color: #000;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: 900; font-size: 18px;
        }

        /* MAIN STAGE */
        .app-main { flex: 1; display: flex; flex-direction: column; background: var(--bg-dark); }
        .app-header {
            padding: 15px 40px; background: var(--bg-panel); border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }

        /* --- KANBAN & LANES --- */
        .kanban-board { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; gap: 35px; }
        .lane-section { background: var(--bg-panel); border-radius: 35px; border: 1px solid var(--border); overflow: hidden; }
        .lane-header { 
            padding: 20px 35px; background: rgba(255,255,255,0.02); border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .lane-header h2 { margin: 0; font-size: 14px; letter-spacing: 2px; text-transform: uppercase; color: var(--text-secondary); }
        .job-grid { padding: 20px; min-height: 180px; display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 20px; }

        /* --- JOB CARD (OPTIMIZADA CON BOT√ìN) --- */
        .job-card {
            background: var(--bg-card); padding: 25px; border-radius: 28px;
            border-left: 10px solid var(--accent); position: relative;
            transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .job-card:hover { transform: translateY(-5px); background: #1c2128; border-right: 1px solid var(--border); }
        .job-card h3 { margin: 0 0 10px 0; font-size: 20px; color: #fff; }
        .job-info { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
        .info-pill { background: #0d1117; padding: 5px 12px; border-radius: 10px; font-size: 11px; border: 1px solid var(--border); color: var(--text-secondary); }
        
        /* BOT√ìN DE ACCI√ìN EN TARJETA */
        .card-action-btn {
            width: 100%; padding: 14px; border-radius: 15px; border: none;
            font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: 0.2s; font-size: 13px; margin-top: 10px;
        }
        .btn-start { background: var(--accent); color: #000; }
        .btn-view { background: var(--blue); color: #fff; }
        .btn-start:hover { filter: brightness(1.2); }

        .status-dot {
            position: absolute; top: 20px; right: 20px; padding: 4px 12px;
            border-radius: 100px; font-size: 10px; font-weight: 900;
        }

        /* --- MODALES --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 90000;
            display: none; align-items: center; justify-content: center; padding: 25px;
            backdrop-filter: blur(15px);
        }
        .modal-box {
            background: var(--bg-panel); width: 100%; max-width: 850px;
            border-radius: 40px; padding: 45px; border: 1px solid var(--border);
            max-height: 90vh; overflow-y: auto; box-shadow: var(--shadow-lg);
        }

        /* --- PRODUCTION UI --- */
        .timer-hero {
            background: #000; padding: 40px; border-radius: 35px; text-align: center;
            border: 1px solid var(--border); margin: 25px 0;
        }
        .timer-val { font-family: 'JetBrains Mono', monospace; font-size: 90px; color: var(--green-glow); text-shadow: 0 0 20px rgba(63, 185, 80, 0.3); }
        
        .metrics-bar { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .metric-card { background: var(--bg-card); padding: 20px; border-radius: 25px; text-align: center; border: 1px solid var(--border); }
        .metric-card label { display: block; font-size: 10px; color: var(--accent); font-weight: 900; margin-bottom: 8px; text-transform: uppercase; }
        .metric-card span { font-size: 24px; font-weight: 800; }

        /* --- BOTONES GENERALES --- */
        .btn-ui {
            padding: 18px 28px; border-radius: 20px; border: none; font-weight: 800;
            cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 12px;
        }
        .btn-main { background: var(--accent); color: #000; }
        .btn-success { background: var(--green); color: #fff; }
        .btn-danger { background: var(--red); color: #fff; }
        .btn-ghost { background: transparent; border: 2px solid var(--border); color: var(--text-secondary); }

        /* --- FORMULARIOS --- */
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; font-size: 11px; font-weight: 800; color: var(--accent); margin-bottom: 10px; padding-left: 10px; }
        input, select, textarea {
            width: 100%; padding: 18px; background: var(--bg-input); border: 1px solid var(--border);
            color: #fff; border-radius: 18px; font-size: 16px;
        }
        input:focus { border-color: var(--accent); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    </style>
</head>
<body>

    <div id="master-lock" class="full-screen-lock">
        <div class="lock-content">
            <h1 style="letter-spacing: 5px;">TRACKLABEL<span style="color:var(--accent)">PRO</span></h1>
            <p>SISTEMA DE GESTI√ìN DE PRODUCCI√ìN v2026</p>
            <input type="password" id="m-pin" placeholder="PASSWORD TERMINAL" style="text-align: center; margin: 30px 0; font-size: 22px; letter-spacing: 8px;">
            <button class="btn-ui btn-main" style="width: 100%;" onclick="unlockMaster()">ACCEDER</button>
        </div>
    </div>

    <div id="user-lock" class="full-screen-lock" style="display: none;">
        <div class="lock-content" style="max-width: 600px;">
            <h2>CONTROL DE PLANTA</h2>
            <div class="user-grid">
                <div class="user-box" onclick="selectUser('Ivan', this)"><i class="fas fa-user-gear"></i>Ivan</div>
                <div class="user-box" onclick="selectUser('Isa', this)"><i class="fas fa-user-ninja"></i>Isa</div>
                <div class="user-box" onclick="selectUser('Jaume', this)"><i class="fas fa-user-astronaut"></i>Jaume</div>
                <div class="user-box" onclick="selectUser('Anna', this)"><i class="fas fa-user-tie"></i>Anna</div>
                <div class="user-box" onclick="selectUser('Toni', this)"><i class="fas fa-user-doctor"></i>Toni</div>
                <div class="user-box" onclick="selectUser('Admin', this)"><i class="fas fa-user-shield"></i>Admin</div>
            </div>
            <input type="password" id="u-pin" placeholder="PIN DE SEGURIDAD" style="text-align: center; margin-bottom: 25px;">
            <button class="btn-ui btn-main" style="width: 100%;" onclick="login()">INICIAR TURNO</button>
        </div>
    </div>

    <div id="app-ui" class="app-shell" style="display: none;">
        
        <aside class="app-sidebar">
            <div class="sb-top">
                <div class="active-user-card" onclick="location.reload()">
                    <div class="avatar-circle" id="av-init">?</div>
                    <div>
                        <div id="av-name" style="font-weight: 800;">Operario</div>
                        <div style="font-size: 10px; color: var(--accent);">TURNO ACTIVO ‚ö°</div>
                    </div>
                </div>
                <div class="metric-card">
                    <label>PROGRESO DIARIO</label>
                    <div style="background:#000; height:8px; border-radius:10px; margin:10px 0; overflow:hidden;">
                        <div id="daily-progress" style="background:var(--accent); width:0%; height:100%; transition:1s;"></div>
                    </div>
                    <span id="daily-pct" style="font-size:12px;">0% COMPLETADO</span>
                </div>
            </div>
            <div class="sb-main">
                <h4 style="font-size:11px; color:var(--text-secondary); text-transform:uppercase; margin-bottom:15px;">Logs de Actividad</h4>
                <div id="log-container" style="font-size:11px; line-height:1.8;"></div>
            </div>
        </aside>

        <main class="app-main">
            <header class="app-header">
                <div style="position:relative; width:350px;">
                    <i class="fas fa-search" style="position:absolute; left:20px; top:18px; color:var(--text-secondary)"></i>
                    <input type="text" id="job-search" placeholder="Buscar pedido..." oninput="renderBoard()" style="padding-left:50px; height:52px; border-radius:100px;">
                </div>
                <div style="display:flex; gap:15px;">
                    <button class="btn-ui btn-ghost" onclick="showReports()"><i class="fas fa-chart-line"></i></button>
                    <button class="btn-ui btn-main" onclick="openEditor()">+ NUEVA ORDEN</button>
                </div>
            </header>

            <div class="kanban-board">
                <section class="lane-section">
                    <div class="lane-header"><h2>Flexograf√≠a / Offset</h2> <span id="count-flexo" class="info-pill">0</span></div>
                    <div id="lane-flexo" class="job-grid"></div>
                </section>
                <section class="lane-section">
                    <div class="lane-header"><h2>Impresi√≥n Digital</h2> <span id="count-digital" class="info-pill">0</span></div>
                    <div id="lane-digital" class="job-grid"></div>
                </section>
                <section class="lane-section">
                    <div class="lane-header"><h2>Repaso / Acabado</h2> <span id="count-repaso" class="info-pill">0</span></div>
                    <div id="lane-repaso" class="job-grid"></div>
                </section>
            </div>
        </main>
    </div>

    <div id="modal-edit" class="modal-overlay">
        <div class="modal-box">
            <h2 id="edit-title">CREAR NUEVO PEDIDO</h2>
            <div class="form-row">
                <div class="input-group" style="grid-column: span 2;"><label>Cliente / Proyecto</label><input type="text" id="f-cli"></div>
                <div class="input-group"><label>M√°quina Destino</label>
                    <select id="f-lane">
                        <option value="lane-flexo">FLEXOGRAF√çA</option>
                        <option value="lane-digital">DIGITAL</option>
                        <option value="lane-repaso">REPASO</option>
                    </select>
                </div>
                <div class="input-group"><label>Metros Estimados</label><input type="number" id="f-met"></div>
                <div class="input-group"><label>Troquel</label><input type="text" id="f-tro"></div>
                <div class="input-group"><label>Material</label><input type="text" id="f-mat"></div>
                <div class="input-group" style="grid-column: span 2;"><label>Observaciones de Producci√≥n</label><textarea id="f-obs" rows="3"></textarea></div>
                <div class="input-group"><label>Prioridad (Color)</label><input type="color" id="f-col" value="#ff7a00" style="height:65px;"></div>
            </div>
            <div style="display:flex; gap:15px; margin-top:30px;">
                <button class="btn-ui btn-main" style="flex:1" onclick="saveJob()">GUARDAR PEDIDO</button>
                <button id="btn-del" class="btn-ui btn-danger" style="display:none" onclick="deleteJob()">ELIMINAR</button>
                <button class="btn-ui btn-ghost" onclick="closeModal('modal-edit')">CANCELAR</button>
            </div>
        </div>
    </div>

    <div id="modal-prod" class="modal-overlay">
        <div class="modal-box" style="max-width: 900px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h1 id="p-cli" style="margin:0">CLIENTE</h1>
                <div id="p-status" class="status-dot">ESTADO</div>
            </div>

            <div class="timer-hero">
                <div id="p-clock" class="timer-val">00:00:00</div>
                <div style="color:var(--text-secondary); letter-spacing:3px; font-size:12px; margin-top:10px;">TIEMPO DE ACTIVIDAD</div>
            </div>

            <div class="metrics-bar">
                <div class="metric-card"><label>OBJETIVO</label><span id="p-obj">0</span>m</div>
                <div class="metric-card" style="border-color:var(--accent);"><label>REALIZADO</label>
                    <input type="number" id="p-real" style="border:none; background:transparent; text-align:center; font-size:24px; font-weight:900; color:#fff; padding:0;">
                </div>
                <div class="metric-card"><label>VELOCIDAD</label><span id="p-speed" style="color:var(--blue)">0</span> <small>m/min</small></div>
            </div>

            <div id="p-actions" style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                </div>

            <div id="p-stop-panel" style="display:none; margin-top:25px; padding:25px; background:rgba(218,54,51,0.1); border-radius:25px; border:1px solid var(--red);">
                <label style="color:var(--red); font-weight:800; display:block; margin-bottom:10px;">MOTIVO DE LA PARADA</label>
                <select id="p-stop-reason">
                    <option>Cambio de Bobina</option>
                    <option>Limpieza / Mantenimiento</option>
                    <option>Ajuste de Registro</option>
                    <option>Aver√≠a M√°quina</option>
                    <option>Falta de Material</option>
                </select>
                <button class="btn-ui btn-danger" style="width:100%; margin-top:15px;" onclick="confirmStop()">CONFIRMAR PAUSA</button>
            </div>

            <button class="btn-ui btn-ghost" style="width:100%; margin-top:25px;" onclick="closeModal('modal-prod')">SALIR AL PANEL PRINCIPAL</button>
        </div>
    </div>

    <script>
        /**
         * TRACKLABEL PRO v2026 - L√ìGICA DE CONTROL
         * @author: Ivan & Gemini
         */

        // --- ESTADO GLOBAL ---
        let DB = JSON.parse(localStorage.getItem('tl26_db')) || {};
        let LOGS = JSON.parse(localStorage.getItem('tl26_logs')) || [];
        let STATS = JSON.parse(localStorage.getItem('tl26_stats')) || { finished: 0, meters: 0 };
        
        let op = null;
        let opTmp = null;
        let activeId = null;
        let clockInterval = null;

        // --- ACCESO ---
        function unlockMaster() {
            if(document.getElementById('m-pin').value === "TrackLabel#") {
                document.getElementById('master-lock').style.display = 'none';
                document.getElementById('user-lock').style.display = 'flex';
            } else alert("Error de acceso");
        }

        function selectUser(name, el) {
            opTmp = name;
            document.querySelectorAll('.user-box').forEach(b => b.classList.remove('selected'));
            el.classList.add('selected');
        }

        function login() {
            if(!opTmp || document.getElementById('u-pin').value !== "1234") return alert("PIN Incorrecto");
            op = opTmp;
            document.getElementById('user-lock').style.display = 'none';
            document.getElementById('app-ui').style.display = 'flex';
            document.getElementById('av-name').innerText = op;
            document.getElementById('av-init').innerText = op.charAt(0);
            init();
        }

        // --- CORE ---
        function init() {
            renderBoard();
            updateDailyStats();
            initDragAndDrop();
            addLog("Turno iniciado por " + op);
        }

        function renderBoard() {
            const query = document.getElementById('job-search').value.toLowerCase();
            const lanes = ['lane-flexo', 'lane-digital', 'lane-repaso'];
            lanes.forEach(l => document.getElementById(l).innerHTML = "");

            Object.keys(DB).forEach(id => {
                const j = DB[id];
                if(j.cli.toLowerCase().includes(query)) {
                    const card = document.createElement('div');
                    card.className = "job-card";
                    card.style.borderLeftColor = j.col;
                    
                    // L√≥gica del bot√≥n de la tarjeta
                    const isWaiting = j.status === "ESPERA";
                    const btnLabel = isWaiting ? "INICIAR PREPARACI√ìN" : "CONTROLAR TIEMPOS";
                    const btnClass = isWaiting ? "btn-start" : "btn-view";
                    const btnIcon = isWaiting ? "fa-play" : "fa-clock";

                    card.innerHTML = `
                        <div class="status-dot" style="background:${getStatusColor(j.status)}">${j.status}</div>
                        <h3 onclick="openEditor('${id}')">${j.cli.toUpperCase()}</h3>
                        <div class="job-info">
                            <span class="info-pill"><i class="fas fa-ruler"></i> ${j.met}m</span>
                            <span class="info-pill"><i class="fas fa-tag"></i> ${j.tro}</span>
                            <span class="info-pill"><i class="fas fa-layer-group"></i> ${j.mat}</span>
                        </div>
                        <button class="card-action-btn ${btnClass}" onclick="handleQuickAction('${id}')">
                            <i class="fas ${btnIcon}"></i> ${btnLabel}
                        </button>
                    `;
                    document.getElementById(j.lane).appendChild(card);
                }
            });
            updateCounters();
        }

        // --- ACCIONES R√ÅPIDAS (EL BOT√ìN QUE PEDISTE) ---
        function handleQuickAction(id) {
            const j = DB[id];
            if(j.status === "ESPERA") {
                // Iniciar preparaci√≥n directamente
                j.status = "PREPARACI√ìN";
                j.startTime = Date.now();
                j.lastOp = op;
                addLog(`PREP: ${j.cli} iniciada por ${op}`);
                save();
            }
            // Abrir el modal de tiempos en cualquier caso (si ya estaba iniciado o reci√©n iniciado)
            openProduction(id);
        }

        // --- PRODUCCI√ìN ---
        function openProduction(id) {
            activeId = id;
            const j = DB[id];
            
            document.getElementById('p-cli').innerText = j.cli;
            document.getElementById('p-obj').innerText = j.met;
            document.getElementById('p-real').value = j.realMeters || 0;
            
            updateStatusUI(j.status);
            renderProductionActions(j.status);
            
            document.getElementById('modal-prod').style.display = 'flex';
            
            if(clockInterval) clearInterval(clockInterval);
            clockInterval = setInterval(() => updateClock(j), 1000);
        }

        function renderProductionActions(status) {
            const box = document.getElementById('p-actions');
            box.innerHTML = "";
            
            if(status === "PREPARACI√ìN") {
                box.innerHTML = `<button class="btn-ui btn-main" style="grid-column: span 2; height:70px;" onclick="setStatus('TIRAJE')">üöÄ INICIAR TIRAJE</button>`;
            } else if(status === "TIRAJE") {
                box.innerHTML = `
                    <button class="btn-ui btn-danger" onclick="document.getElementById('p-stop-panel').style.display='block'">‚ö†Ô∏è PARADA</button>
                    <button class="btn-ui btn-success" onclick="finishJob()">‚úÖ FINALIZAR</button>
                `;
            } else if(status === "PARADA") {
                box.innerHTML = `<button class="btn-ui btn-main" style="grid-column: span 2; height:70px;" onclick="setStatus('TIRAJE')">‚ñ∂ REANUDAR</button>`;
            }
        }

        function updateClock(j) {
            const now = Date.now();
            const elapsed = (now - j.startTime) + (j.totalTimeMs || 0);
            document.getElementById('p-clock').innerText = formatMs(elapsed);
            
            // Velocidad
            const real = document.getElementById('p-real').value || 0;
            const mins = elapsed / 60000;
            document.getElementById('p-speed').innerText = mins > 0 ? Math.round(real/mins) : 0;
            j.realMeters = real;
        }

        function setStatus(newSt) {
            const j = DB[activeId];
            const now = Date.now();
            
            if(j.startTime) {
                j.totalTimeMs = (j.totalTimeMs || 0) + (now - j.startTime);
            }
            
            j.status = newSt;
            j.startTime = now;
            addLog(`${newSt}: ${j.cli}`);
            save();
            openProduction(activeId);
            renderBoard();
        }

        function finishJob() {
            const j = DB[activeId];
            const r = document.getElementById('p-real').value;
            if(!r || r <= 0) return alert("Introduce metros reales");

            if(confirm("¬øFinalizar orden?")) {
                STATS.finished++;
                STATS.meters += parseInt(r);
                addLog(`FIN: ${j.cli} | ${r}m`);
                delete DB[activeId];
                save();
                closeModal('modal-prod');
                renderBoard();
                updateDailyStats();
            }
        }

        function confirmStop() {
            const reason = document.getElementById('p-stop-reason').value;
            addLog(`STOP: ${DB[activeId].cli} por ${reason}`);
            document.getElementById('p-stop-panel').style.display = 'none';
            setStatus('PARADA');
        }

        // --- EDITOR ---
        function openEditor(id = null) {
            activeId = id;
            if(id) {
                const j = DB[id];
                document.getElementById('edit-title').innerText = "EDITAR ORDEN";
                document.getElementById('f-cli').value = j.cli;
                document.getElementById('f-met').value = j.met;
                document.getElementById('f-tro').value = j.tro;
                document.getElementById('f-mat').value = j.mat;
                document.getElementById('f-obs').value = j.obs;
                document.getElementById('f-col').value = j.col;
                document.getElementById('f-lane').value = j.lane;
                document.getElementById('btn-del').style.display = 'block';
            } else {
                document.getElementById('edit-title').innerText = "NUEVA ORDEN";
                resetForm();
                document.getElementById('btn-del').style.display = 'none';
            }
            document.getElementById('modal-edit').style.display = 'flex';
        }

        function saveJob() {
            const cli = document.getElementById('f-cli').value;
            if(!cli) return alert("Cliente necesario");
            const id = activeId || "OT-" + Date.now();
            DB[id] = {
                id, cli, 
                met: document.getElementById('f-met').value,
                tro: document.getElementById('f-tro').value,
                mat: document.getElementById('f-mat').value,
                obs: document.getElementById('f-obs').value,
                col: document.getElementById('f-col').value,
                lane: document.getElementById('f-lane').value,
                status: DB[id]?.status || "ESPERA",
                totalTimeMs: DB[id]?.totalTimeMs || 0,
                realMeters: DB[id]?.realMeters || 0
            };
            save(); closeModal('modal-edit'); renderBoard();
        }

        // --- UTILS ---
        function save() {
            localStorage.setItem('tl26_db', JSON.stringify(DB));
            localStorage.setItem('tl26_logs', JSON.stringify(LOGS));
            localStorage.setItem('tl26_stats', JSON.stringify(STATS));
        }
        function addLog(m) {
            const t = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            LOGS.unshift(`<b>[${t}]</b> ${m}`);
            if(LOGS.length > 40) LOGS.pop();
            document.getElementById('log-container').innerHTML = LOGS.join('<br>');
        }
        function updateDailyStats() {
            const pct = Math.min(100, (STATS.finished / 10) * 100);
            document.getElementById('daily-progress').style.width = pct + "%";
            document.getElementById('daily-pct').innerText = Math.round(pct) + "% COMPLETADO";
        }
        function formatMs(ms) {
            let s = Math.floor(ms/1000), m = Math.floor(s/60), h = Math.floor(m/60);
            return `${h}:${(m%60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
        }
        function getStatusColor(s) {
            if(s === "TIRAJE") return "var(--green)";
            if(s === "PREPARACI√ìN") return "var(--blue)";
            if(s === "PARADA") return "var(--red)";
            return "var(--border)";
        }
        function updateStatusUI(st) {
            const el = document.getElementById('p-status');
            el.innerText = st;
            el.style.background = getStatusColor(st);
            el.style.color = (st === "ESPERA") ? "#fff" : "#000";
        }
        function closeModal(id) { 
            document.getElementById(id).style.display = 'none'; 
            if(clockInterval) clearInterval(clockInterval);
            renderBoard();
        }
        function deleteJob() { if(confirm("¬øBorrar?")) { delete DB[activeId]; save(); closeModal('modal-edit'); renderBoard(); } }
        function resetForm() {
            ['f-cli','f-met','f-tro','f-mat','f-obs'].forEach(i => document.getElementById(i).value = "");
            document.getElementById('f-col').value = "#ff7a00";
        }
        function updateCounters() {
            ['flexo', 'digital', 'repaso'].forEach(l => {
                document.getElementById('count-'+l).innerText = document.getElementById('lane-'+l).children.length;
            });
        }
        function showReports() {
            alert(`RESUMEN JORNADA\n\nFinalizados: ${STATS.finished}\nMetros totales: ${STATS.meters}m\nOperario: ${op}`);
        }
        function initDragAndDrop() {
            ['lane-flexo', 'lane-digital', 'lane-repaso'].forEach(l => {
                new Sortable(document.getElementById(l), {
                    group: 'p', animation: 200,
                    onEnd: (e) => {
                        const id = e.item.querySelector('h3').getAttribute('onclick').match(/'([^']+)'/)[1];
                        DB[id].lane = e.to.id;
                        save(); updateCounters();
                    }
                });
            });
        }
    </script>
</body>
</html>
