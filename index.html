<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TrackLabel Pro v2026 | Enterprise Industrial System</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-ultra: #020406;
            --bg-panel: #0d1117;
            --bg-surface: #161b22;
            --bg-card: #21262d;
            --accent: #ff7a00;
            --accent-glow: rgba(255, 122, 0, 0.3);
            --green: #238636;
            --green-bright: #3fb950;
            --red: #da3633;
            --blue: #1f6feb;
            --text-white: #f0f6fc;
            --text-gray: #8b949e;
            --border: #30363d;
            --radius-xl: 35px;
            --radius-lg: 20px;
            --shadow-heavy: 0 20px 50px rgba(0,0,0,0.7);
        }

        /* --- GLOBAL & SCROLL --- */
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { 
            background: var(--bg-ultra); color: var(--text-white); 
            font-family: 'Inter', sans-serif; margin: 0; padding: 0; 
            height: 100vh; overflow: hidden; font-size: 16px;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-ultra); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }

        /* --- SYSTEM OVERLAYS (LOCKS) --- */
        .system-overlay {
            position: fixed; inset: 0; background: var(--bg-ultra); z-index: 99999;
            display: flex; align-items: center; justify-content: center; padding: 25px;
            background-image: radial-gradient(circle at center, #161b22 0%, #020406 100%);
        }
        .lock-card {
            background: var(--bg-panel); padding: 50px; border-radius: var(--radius-xl);
            border: 1px solid var(--border); width: 100%; max-width: 550px;
            text-align: center; box-shadow: var(--shadow-heavy);
            animation: slideUp 0.6s cubic-bezier(0.23, 1, 0.32, 1);
        }
        .lock-card h1 { font-size: 32px; letter-spacing: 10px; margin-bottom: 10px; font-weight: 900; }
        .lock-card p { color: var(--text-gray); margin-bottom: 40px; }

        .user-selection-grid { 
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 35px; 
        }
        .u-item {
            background: var(--bg-surface); padding: 25px 10px; border-radius: var(--radius-lg);
            border: 2px solid var(--border); cursor: pointer; transition: 0.3s;
        }
        .u-item:hover { border-color: var(--accent); background: var(--bg-card); }
        .u-item.active { border-color: var(--accent); background: var(--accent-glow); transform: scale(1.05); }
        .u-item i { font-size: 30px; color: var(--accent); margin-bottom: 15px; display: block; }
        .u-name { font-weight: 700; font-size: 14px; }

        /* --- MAIN LAYOUT --- */
        .app-container { display: flex; height: 100vh; width: 100vw; }

        .main-sidebar {
            width: 350px; background: var(--bg-panel); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; flex-shrink: 0;
        }
        .sb-header { padding: 40px 30px; border-bottom: 1px solid var(--border); }
        .sb-body { flex: 1; overflow-y: auto; padding: 30px; }
        
        .op-badge {
            background: var(--bg-surface); padding: 20px; border-radius: var(--radius-lg);
            display: flex; align-items: center; gap: 15px; border: 1px solid var(--border);
            margin-bottom: 30px; cursor: pointer;
        }
        .op-badge .avatar {
            width: 50px; height: 50px; background: var(--accent); color: #000;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: 900; font-size: 20px;
        }

        .stats-minipanel {
            background: rgba(0,0,0,0.3); padding: 20px; border-radius: var(--radius-lg);
            border: 1px solid var(--border); margin-bottom: 25px;
        }
        .stats-minipanel h4 { margin: 0 0 15px 0; font-size: 12px; color: var(--text-gray); text-transform: uppercase; }
        
        .progress-container { height: 12px; background: #000; border-radius: 10px; overflow: hidden; margin-bottom: 10px; }
        .progress-bar { height: 100%; background: var(--accent); width: 0%; transition: 1.5s cubic-bezier(0.1, 0, 0, 1); }

        /* --- STAGE & KANBAN --- */
        .stage { flex: 1; display: flex; flex-direction: column; background: var(--bg-ultra); }
        .top-nav {
            padding: 20px 40px; background: var(--bg-panel); border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }

        .kanban-view { flex: 1; padding: 35px; overflow-y: auto; display: flex; flex-direction: column; gap: 40px; }
        .lane { background: var(--bg-panel); border-radius: 40px; border: 1px solid var(--border); }
        .lane-title { 
            padding: 25px 40px; border-bottom: 1px solid var(--border); 
            display: flex; justify-content: space-between; align-items: center;
        }
        .lane-title h2 { margin: 0; font-size: 16px; letter-spacing: 3px; text-transform: uppercase; color: var(--text-gray); }
        .lane-count { background: var(--bg-surface); padding: 5px 15px; border-radius: 10px; font-weight: 900; color: var(--accent); }
        
        .card-container { padding: 25px; min-height: 180px; display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }

        /* --- JOB CARDS --- */
        .job-card {
            background: var(--bg-surface); padding: 28px; border-radius: 30px;
            border-left: 12px solid var(--accent); cursor: pointer; position: relative;
            transition: 0.4s; border-top: 1px solid transparent; border-right: 1px solid transparent;
        }
        .job-card:hover { transform: translateY(-8px); background: var(--bg-card); border-color: var(--border); box-shadow: var(--shadow-heavy); }
        .job-card h3 { margin: 0 0 15px 0; font-size: 22px; color: #fff; }
        .card-row { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
        .tag { background: rgba(0,0,0,0.4); border: 1px solid var(--border); padding: 6px 12px; border-radius: 12px; font-size: 12px; color: var(--text-gray); }
        
        .status-indicator {
            position: absolute; top: 25px; right: 25px; padding: 6px 16px; border-radius: 100px;
            font-size: 10px; font-weight: 900; text-transform: uppercase;
        }

        /* --- MODALS --- */
        .modal-mask {
            position: fixed; inset: 0; background: rgba(0,0,0,0.96); z-index: 80000;
            display: none; align-items: center; justify-content: center; padding: 30px;
            backdrop-filter: blur(20px);
        }
        .modal-wrap {
            background: var(--bg-panel); width: 100%; max-width: 900px; max-height: 90vh;
            border-radius: 50px; padding: 50px; border: 1px solid var(--border);
            overflow-y: auto; position: relative; box-shadow: var(--shadow-heavy);
        }

        /* --- PRODUCTION UI (TIMER MODAL) --- */
        .timer-display-box {
            background: #000; padding: 50px; border-radius: 40px; text-align: center;
            border: 1px solid var(--border); margin: 30px 0;
        }
        .clock-val { font-family: 'JetBrains Mono', monospace; font-size: 100px; color: var(--green-bright); line-height: 1; }
        .clock-label { color: var(--text-gray); letter-spacing: 5px; font-size: 12px; margin-top: 15px; }

        .metrics-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; margin-bottom: 40px; }
        .metric-item { background: var(--bg-surface); padding: 25px; border-radius: 30px; text-align: center; border: 1px solid var(--border); }
        .metric-item label { display: block; font-size: 11px; color: var(--accent); font-weight: 900; margin-bottom: 10px; }
        .metric-item .val { font-size: 28px; font-weight: 900; }

        /* --- BUTTONS & INPUTS --- */
        .btn-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .btn-pro {
            padding: 24px; border-radius: 25px; border: none; font-weight: 900;
            cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 15px; font-size: 18px;
        }
        .btn-accent { background: var(--accent); color: #000; }
        .btn-green { background: var(--green-bright); color: #000; }
        .btn-red { background: var(--red); color: #fff; }
        .btn-outline { background: transparent; border: 2px solid var(--border); color: var(--text-gray); }
        .btn-pro:active { transform: scale(0.96); }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .input-wrap { margin-bottom: 25px; }
        .input-wrap label { display: block; font-size: 12px; font-weight: 900; color: var(--accent); margin: 0 0 10px 15px; text-transform: uppercase; }
        input, select, textarea {
            width: 100%; padding: 20px; background: var(--bg-ultra); border: 1px solid var(--border);
            color: #fff; border-radius: 22px; font-size: 16px; transition: 0.3s;
        }
        input:focus { border-color: var(--accent); box-shadow: 0 0 0 4px var(--accent-glow); }

        /* --- ANIMATIONS --- */
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    </style>
</head>
<body>

    <div id="master-lock-screen" class="system-overlay">
        <div class="lock-card">
            <i class="fas fa-shield-halved" style="font-size: 50px; color: var(--accent); margin-bottom: 25px;"></i>
            <h1>TRACKLABEL<span style="color:var(--accent)">PRO</span></h1>
            <p>AUTENTICACIÓN DE TERMINAL REQUERIDA</p>
            <div class="input-wrap">
                <input type="password" id="m-key" placeholder="••••••••" style="text-align: center; font-size: 30px; letter-spacing: 10px;">
            </div>
            <button class="btn-pro btn-accent" style="width: 100%;" onclick="validateMaster()">DESBLOQUEAR TERMINAL</button>
        </div>
    </div>

    <div id="user-lock-screen" class="system-overlay" style="display: none;">
        <div class="lock-card" style="max-width: 700px;">
            <h2>CONTROL DE TURNO</h2>
            <p>SELECCIONE OPERARIO PARA INICIAR ACTIVIDAD</p>
            <div class="user-selection-grid">
                <div class="u-item" onclick="selOp('Ivan', this)"><i class="fas fa-user-gear"></i><div class="u-name">Ivan</div></div>
                <div class="u-item" onclick="selOp('Isa', this)"><i class="fas fa-user-ninja"></i><div class="u-name">Isa</div></div>
                <div class="u-item" onclick="selOp('Jaume', this)"><i class="fas fa-user-astronaut"></i><div class="u-name">Jaume</div></div>
                <div class="u-item" onclick="selOp('Anna', this)"><i class="fas fa-user-tie"></i><div class="u-name">Anna</div></div>
                <div class="u-item" onclick="selOp('Toni', this)"><i class="fas fa-user-doctor"></i><div class="u-name">Toni</div></div>
                <div class="u-item" onclick="selOp('Admin', this)"><i class="fas fa-user-shield"></i><div class="u-name">Admin</div></div>
            </div>
            <input type="password" id="u-pin" placeholder="PIN DE ACCESO" style="text-align: center; margin-bottom: 25px;">
            <button class="btn-pro btn-accent" style="width: 100%;" onclick="attemptLogin()">CONFIRMAR ENTRADA</button>
        </div>
    </div>

    <div id="main-app" class="app-container" style="display: none;">
        
        <aside class="main-sidebar">
            <div class="sb-header">
                <div class="op-badge" onclick="logout()">
                    <div class="avatar" id="avatar-init">?</div>
                    <div style="text-align: left;">
                        <div id="active-op-name" style="font-weight: 900; font-size: 18px;">Operario</div>
                        <div style="font-size: 11px; color: var(--accent);">TURNO ACTIVO ⇄</div>
                    </div>
                </div>
                <div class="stats-minipanel">
                    <h4>EFICIENCIA DIARIA</h4>
                    <div class="progress-container"><div id="daily-bar" class="progress-bar"></div></div>
                    <div style="display: flex; justify-content: space-between; font-size: 12px; font-weight: 900;">
                        <span id="daily-pct">0%</span>
                        <span id="daily-count">0/10 PEDIDOS</span>
                    </div>
                </div>
            </div>
            <div class="sb-body">
                <h4 style="font-size: 11px; letter-spacing: 2px; color: var(--text-gray); margin-bottom: 20px;">REGISTRO DE PLANTA</h4>
                <div id="system-logs" style="font-size: 12px; line-height: 2;">
                    </div>
            </div>
        </aside>

        <main class="stage">
            <nav class="top-nav">
                <div style="position: relative; width: 400px;">
                    <i class="fas fa-search" style="position: absolute; left: 20px; top: 22px; color: var(--text-gray);"></i>
                    <input type="text" id="main-search" placeholder="Buscar cliente, material o troquel..." oninput="refreshBoard()" style="padding-left: 55px; height: 60px; border-radius: 100px;">
                </div>
                <div style="display: flex; gap: 20px;">
                    <button class="btn-pro btn-outline" style="padding: 0 25px; height: 60px;" onclick="showAdminReport()">
                        <i class="fas fa-file-invoice"></i> REPORTES
                    </button>
                    <button class="btn-pro btn-accent" style="padding: 0 35px; height: 60px;" onclick="openEditor()">
                        <i class="fas fa-plus"></i> NUEVA ORDEN
                    </button>
                </div>
            </nav>

            <div class="kanban-view">
                <div class="lane">
                    <div class="lane-title"><h2><i class="fas fa-print"></i> Flexografía / Offset</h2> <span class="lane-count" id="c-lane-flexo">0</span></div>
                    <div id="lane-flexo" class="card-container"></div>
                </div>
                <div class="lane">
                    <div class="lane-title"><h2><i class="fas fa-bolt"></i> Impresión Digital</h2> <span class="lane-count" id="c-lane-digital">0</span></div>
                    <div id="lane-digital" class="card-container"></div>
                </div>
                <div class="lane">
                    <div class="lane-title"><h2><i class="fas fa-check-double"></i> Repaso y Acabados</h2> <span class="lane-count" id="c-lane-repaso">0</span></div>
                    <div id="lane-repaso" class="card-container"></div>
                </div>
            </div>
        </main>
    </div>

    <div id="modal-editor" class="modal-mask">
        <div class="modal-wrap">
            <h2 id="editor-title" style="margin: 0 0 40px 0;">NUEVA ORDEN DE TRABAJO</h2>
            <div class="form-grid">
                <div class="input-wrap" style="grid-column: span 2;"><label>Nombre del Cliente</label><input type="text" id="f-client" placeholder="Ej: Industrias Alimenticias S.A."></div>
                <div class="input-wrap"><label>Línea de Producción</label>
                    <select id="f-lane">
                        <option value="lane-flexo">FLEXOGRAFÍA</option>
                        <option value="lane-digital">DIGITAL</option>
                        <option value="lane-repaso">REPASO</option>
                    </select>
                </div>
                <div class="input-wrap"><label>Metraje Objetivo</label><input type="number" id="f-meters" placeholder="0"></div>
                <div class="input-wrap"><label>Referencia Troquel</label><input type="text" id="f-die" placeholder="R-450"></div>
                <div class="input-wrap"><label>Material / Sustrato</label><input type="text" id="f-material" placeholder="PP Blanco Mate"></div>
                <div class="input-wrap" style="grid-column: span 2;"><label>Instrucciones de Fabricación</label><textarea id="f-obs" rows="4"></textarea></div>
                <div class="input-wrap"><label>Color de Alerta</label><input type="color" id="f-color" value="#ff7a00" style="height: 70px;"></div>
            </div>
            <div class="btn-group" style="margin-top: 40px;">
                <button class="btn-pro btn-accent" onclick="saveJob()">GUARDAR ORDEN</button>
                <button id="btn-delete" class="btn-pro btn-red" style="display: none;" onclick="deleteJob()">ELIMINAR</button>
                <button class="btn-pro btn-outline" onclick="closeModal('modal-editor')">VOLVER</button>
            </div>
        </div>
    </div>

    <div id="modal-production" class="modal-mask">
        <div class="modal-wrap" style="max-width: 1000px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1 id="p-client-name" style="margin: 0;">CLIENTE</h1>
                    <p id="p-material-info" style="color: var(--text-gray); margin-top: 5px;">Material</p>
                </div>
                <div id="p-status-badge" class="status-indicator">ESTADO</div>
            </div>

            <div class="timer-display-box">
                <div id="main-clock" class="clock-val">00:00:00</div>
                <div class="clock-label">TIEMPO ACTIVO EN FASE</div>
            </div>

            <div class="metrics-grid">
                <div class="metric-item"><label>METROS OBJETIVO</label><div class="val" id="m-obj">0</div></div>
                <div class="metric-item" style="border-color: var(--accent);"><label>METROS REALES</label>
                    <input type="number" id="m-input" style="border: none; background: transparent; text-align: center; font-size: 30px; font-weight: 900; color: #fff; padding: 0;" oninput="calcSpeed()">
                </div>
                <div class="metric-item"><label>VELOCIDAD MEDIA</label><div class="val" id="m-speed" style="color: var(--blue);">0</div><small>m/min</small></div>
            </div>

            <div id="production-controls" class="btn-group">
                </div>

            <div id="stop-panel" style="display: none; margin-top: 30px; padding: 30px; background: rgba(218, 54, 51, 0.1); border-radius: 30px; border: 1px solid var(--red);">
                <h3 style="color: var(--red); margin-top: 0;">REGISTRAR PARADA TÉCNICA</h3>
                <div class="form-grid">
                    <div class="input-wrap" style="grid-column: span 2;">
                        <label>Motivo de la Interrupción</label>
                        <select id="stop-reason">
                            <option>Cambio de Bobina / Material</option>
                            <option>Limpieza de Cabezales / Clichés</option>
                            <option>Ajuste de Registro / Color</option>
                            <option>Avería Mecánica / Eléctrica</option>
                            <option>Falta de Consumibles (Tinta/Barniz)</option>
                            <option>Descanso Operario / Cambio Turno</option>
                        </select>
                    </div>
                </div>
                <button class="btn-pro btn-red" style="width: 100%;" onclick="executeStop()">CONFIRMAR PARADA</button>
            </div>

            <button class="btn-pro btn-outline" style="width: 100%; margin-top: 30px;" onclick="closeModal('modal-production')">OCULTAR VENTANA (SIGUE EN CURSO)</button>
        </div>
    </div>

    <audio id="snd-success" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3"></audio>

    <script>
        /**
         * TRACKLABEL PRO v2026 - LÓGICA INDUSTRIAL REFORZADA
         * @author: Ivan & Gemini Pro
         * @lines: 750+
         */

        // --- PERSISTENCIA Y VARIABLES GLOBALES ---
        let JOBS = JSON.parse(localStorage.getItem('tl_jobs_v26')) || {};
        let LOG_DATA = JSON.parse(localStorage.getItem('tl_logs_v26')) || [];
        let GLOBAL_STATS = JSON.parse(localStorage.getItem('tl_stats_v26')) || { completed: 0, totalMeters: 0 };
        
        let currentUser = null;
        let selectedUserTmp = null;
        let activeJobId = null;
        let mainClockInterval = null;

        const MASTER_PIN = "TrackLabel#";
        const OPERATORS = { "Ivan":"1234", "Isa":"1234", "Jaume":"1234", "Anna":"1234", "Toni":"1234", "Admin":"0000" };

        // --- SISTEMA DE SEGURIDAD ---
        function validateMaster() {
            const key = document.getElementById('m-key').value;
            if(key === MASTER_PIN) {
                document.getElementById('master-lock-screen').style.display = 'none';
                document.getElementById('user-lock-screen').style.display = 'flex';
            } else {
                alert("Acceso denegado. Terminal bloqueado.");
            }
        }

        function selOp(name, el) {
            selectedUserTmp = name;
            document.querySelectorAll('.u-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
        }

        function attemptLogin() {
            const pin = document.getElementById('u-pin').value;
            if(selectedUserTmp && OPERATORS[selectedUserTmp] === pin) {
                currentUser = selectedUserTmp;
                document.getElementById('user-lock-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'flex';
                document.getElementById('active-op-name').innerText = currentUser;
                document.getElementById('avatar-init').innerText = currentUser.charAt(0);
                startSystem();
            } else {
                alert("PIN Inválido.");
            }
        }

        function logout() {
            if(confirm("¿Desea cerrar la sesión del operario actual?")) location.reload();
        }

        // --- CORE LOGIC ---
        function startSystem() {
            refreshBoard();
            updateDailyStats();
            initDragAndDrop();
            addSystemLog("Sistema iniciado por " + currentUser);
        }

        function refreshBoard() {
            const query = document.getElementById('main-search').value.toLowerCase();
            const lanes = ['lane-flexo', 'lane-digital', 'lane-repaso'];
            lanes.forEach(l => document.getElementById(l).innerHTML = "");

            Object.keys(JOBS).forEach(id => {
                const j = JOBS[id];
                if(j.client.toLowerCase().includes(query) || j.material.toLowerCase().includes(query)) {
                    const card = document.createElement('div');
                    card.className = "job-card";
                    card.style.borderLeftColor = j.color;
                    card.onclick = () => handleJobClick(id);
                    card.innerHTML = `
                        <div class="status-indicator" style="background:${getStatusColor(j.status)}">${j.status}</div>
                        <h3>${j.client.toUpperCase()}</h3>
                        <div class="card-row">
                            <span class="tag"><i class="fas fa-ruler"></i> ${j.meters}m</span>
                            <span class="tag"><i class="fas fa-microchip"></i> ${j.die}</span>
                            <span class="tag"><i class="fas fa-box"></i> ${j.material}</span>
                        </div>
                        <div style="font-size: 11px; color: var(--text-gray); display: flex; justify-content: space-between; align-items:center;">
                            <span><i class="fas fa-user-circle"></i> ${j.lastOp || 'Pendiente'}</span>
                            <span>${j.stops.length > 0 ? '⚠️ ' + j.stops.length + ' PARADAS' : ''}</span>
                        </div>
                    `;
                    document.getElementById(j.lane).appendChild(card);
                }
            });
            updateCounters();
        }

        function handleJobClick(id) {
            activeJobId = id;
            const j = JOBS[id];
            if(j.status === "ESPERA") {
                openEditor(id);
            } else {
                openProduction(id);
            }
        }

        // --- GESTIÓN DE TIEMPOS Y PRODUCCIÓN ---
        function openProduction(id) {
            activeJobId = id;
            const j = JOBS[id];
            const modal = document.getElementById('modal-production');
            
            document.getElementById('p-client-name').innerText = j.client;
            document.getElementById('p-material-info').innerText = j.material + " | Troquel: " + j.die;
            document.getElementById('m-obj').innerText = j.meters;
            document.getElementById('m-input').value = j.realMeters || 0;
            
            updateStatusBadge(j.status);
            renderProductionButtons(j.status);
            
            modal.style.display = 'flex';
            
            if(mainClockInterval) clearInterval(mainClockInterval);
            mainClockInterval = setInterval(() => runClock(j), 1000);
        }

        function runClock(j) {
            const now = Date.now();
            const elapsed = (now - j.currentStartTime) + (j.totalTimeMs || 0);
            document.getElementById('main-clock').innerText = formatTime(elapsed);
            calcSpeed();
        }

        function renderProductionButtons(status) {
            const container = document.getElementById('production-controls');
            container.innerHTML = "";
            
            if(status === "PREPARACIÓN") {
                container.innerHTML = `
                    <button class="btn-pro btn-green" style="grid-column: span 2;" onclick="setJobStatus('TIRAJE')">
                        <i class="fas fa-rocket"></i> INICIAR TIRAJE (PRODUCCIÓN)
                    </button>
                `;
            } else if(status === "TIRAJE") {
                container.innerHTML = `
                    <button class="btn-pro btn-red" onclick="showStopPanel()">
                        <i class="fas fa-pause"></i> REGISTRAR PARADA
                    </button>
                    <button class="btn-pro btn-green" onclick="finishJob()">
                        <i class="fas fa-check-double"></i> FINALIZAR ORDEN
                    </button>
                `;
            } else if(status === "PARADA") {
                container.innerHTML = `
                    <button class="btn-pro btn-accent" style="grid-column: span 2;" onclick="setJobStatus('TIRAJE')">
                        <i class="fas fa-play"></i> REANUDAR PRODUCCIÓN
                    </button>
                `;
            }
        }

        function setJobStatus(newStatus) {
            const j = JOBS[activeJobId];
            const now = Date.now();

            // Guardar tiempo acumulado antes de cambiar
            if(j.currentStartTime) {
                j.totalTimeMs = (j.totalTimeMs || 0) + (now - j.currentStartTime);
            }

            j.status = newStatus;
            j.currentStartTime = now;
            j.lastOp = currentUser;

            addSystemLog(`${newStatus}: ${j.client} actualizado por ${currentUser}`);
            saveData();
            openProduction(activeJobId);
            refreshBoard();
        }

        function showStopPanel() {
            document.getElementById('stop-panel').style.display = 'block';
        }

        function executeStop() {
            const j = JOBS[activeJobId];
            const reason = document.getElementById('stop-reason').value;
            j.stops.push({ reason: reason, time: new Date().toLocaleTimeString() });
            
            document.getElementById('stop-panel').style.display = 'none';
            setJobStatus('PARADA');
        }

        function finishJob() {
            const j = JOBS[activeJobId];
            const realM = document.getElementById('m-input').value;
            
            if(!realM || realM <= 0) {
                alert("Por favor, introduzca los metros reales producidos.");
                return;
            }

            if(confirm("¿Confirmar finalización de la orden?")) {
                document.getElementById('snd-success').play();
                GLOBAL_STATS.completed++;
                GLOBAL_STATS.totalMeters += parseInt(realM);
                
                addSystemLog(`FINALIZADO: ${j.client} | ${realM}m totales.`);
                delete JOBS[activeJobId];
                
                saveData();
                closeModal('modal-production');
                refreshBoard();
                updateDailyStats();
            }
        }

        // --- CRUD ÓRDENES ---
        function openEditor(id = null) {
            activeJobId = id;
            const modal = document.getElementById('modal-editor');
            const delBtn = document.getElementById('btn-delete');
            
            if(id) {
                const j = JOBS[id];
                document.getElementById('editor-title').innerText = "MODIFICAR ORDEN";
                document.getElementById('f-client').value = j.client;
                document.getElementById('f-meters').value = j.meters;
                document.getElementById('f-die').value = j.die;
                document.getElementById('f-material').value = j.material;
                document.getElementById('f-obs').value = j.obs;
                document.getElementById('f-color').value = j.color;
                document.getElementById('f-lane').value = j.lane;
                delBtn.style.display = 'block';
            } else {
                document.getElementById('editor-title').innerText = "NUEVA ORDEN";
                clearForm();
                delBtn.style.display = 'none';
            }
            modal.style.display = 'flex';
        }

        function saveJob() {
            const client = document.getElementById('f-client').value;
            if(!client) { alert("El nombre del cliente es obligatorio"); return; }

            const id = activeJobId || "JOB-" + Date.now();
            JOBS[id] = {
                id: id,
                client: client,
                meters: document.getElementById('f-meters').value || 0,
                die: document.getElementById('f-die').value || "N/A",
                material: document.getElementById('f-material').value || "Estándar",
                obs: document.getElementById('f-obs').value,
                color: document.getElementById('f-color').value,
                lane: document.getElementById('f-lane').value,
                status: JOBS[id]?.status || "ESPERA",
                stops: JOBS[id]?.stops || [],
                totalTimeMs: JOBS[id]?.totalTimeMs || 0,
                realMeters: JOBS[id]?.realMeters || 0,
                lastOp: JOBS[id]?.lastOp || currentUser,
                currentStartTime: JOBS[id]?.currentStartTime || null
            };

            saveData();
            closeModal('modal-editor');
            refreshBoard();
        }

        function deleteJob() {
            if(confirm("¿Eliminar permanentemente esta orden?")) {
                delete JOBS[activeJobId];
                saveData();
                closeModal('modal-editor');
                refreshBoard();
            }
        }

        // --- UTILS ---
        function formatTime(ms) {
            let s = Math.floor(ms / 1000);
            let m = Math.floor(s / 60);
            let h = Math.floor(m / 60);
            return `${h.toString().padStart(2,'0')}:${(m%60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
        }

        function getStatusColor(st) {
            switch(st) {
                case 'PREPARACIÓN': return '#1f6feb';
                case 'TIRAJE': return '#238636';
                case 'PARADA': return '#da3633';
                default: return '#30363d';
            }
        }

        function updateStatusBadge(st) {
            const b = document.getElementById('p-status-badge');
            b.innerText = st;
            b.style.background = getStatusColor(st);
        }

        function calcSpeed() {
            const j = JOBS[activeJobId];
            const m = document.getElementById('m-input').value || 0;
            const now = Date.now();
            const elapsedMs = (now - j.currentStartTime) + (j.totalTimeMs || 0);
            const mins = elapsedMs / 60000;
            const speed = mins > 0 ? (m / mins).toFixed(1) : 0;
            document.getElementById('m-speed').innerText = speed;
            j.realMeters = m; // Persistencia inmediata
        }

        function addSystemLog(msg) {
            const t = new Date().toLocaleTimeString();
            LOG_DATA.unshift(`[${t}] ${msg}`);
            if(LOG_DATA.length > 50) LOG_DATA.pop();
            updateLogUI();
        }

        function updateLogUI() {
            const container = document.getElementById('system-logs');
            container.innerHTML = LOG_DATA.map(l => `<div style="border-bottom: 1px solid #161b22; padding: 5px 0;">${l}</div>`).join('');
        }

        function updateDailyStats() {
            const target = 10;
            const pct = Math.min(100, (GLOBAL_STATS.completed / target) * 100);
            document.getElementById('daily-bar').style.width = pct + "%";
            document.getElementById('daily-pct').innerText = Math.round(pct) + "%";
            document.getElementById('daily-count').innerText = `${GLOBAL_STATS.completed} / ${target} PEDIDOS`;
        }

        function updateCounters() {
            ['flexo','digital','repaso'].forEach(l => {
                document.getElementById('c-lane-'+l).innerText = document.getElementById('lane-'+l).children.length;
            });
        }

        function saveData() {
            localStorage.setItem('tl_jobs_v26', JSON.stringify(JOBS));
            localStorage.setItem('tl_logs_v26', JSON.stringify(LOG_DATA));
            localStorage.setItem('tl_stats_v26', JSON.stringify(GLOBAL_STATS));
        }

        function clearForm() {
            const f = ['f-client','f-meters','f-die','f-material','f-obs'];
            f.forEach(id => document.getElementById(id).value = "");
            document.getElementById('f-color').value = "#ff7a00";
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
            if(id === 'modal-production' && mainClockInterval) clearInterval(mainClockInterval);
            refreshBoard();
        }

        function showAdminReport() {
            alert(`REPORT DE PLANTA - 2026\n\nPedidos Completados: ${GLOBAL_STATS.completed}\nMetros Totales: ${GLOBAL_STATS.totalMeters}m\nOperario: ${currentUser}`);
        }

        function initDragAndDrop() {
            ['lane-flexo', 'lane-digital', 'lane-repaso'].forEach(id => {
                new Sortable(document.getElementById(id), {
                    group: 'production', animation: 300, ghostClass: 'job-card-ghost',
                    onEnd: (e) => {
                        // Al mover una tarjeta de "ESPERA" a una máquina, inicia preparación automáticamente
                        const jobId = e.item.onclick.toString().match(/'([^']+)'/)[1];
                        JOBS[jobId].lane = e.to.id;
                        if(JOBS[jobId].status === "ESPERA") {
                            activeJobId = jobId;
                            setJobStatus("PREPARACIÓN");
                        }
                        saveData();
                        updateCounters();
                    }
                });
            });
        }
    </script>
</body>
</html>
