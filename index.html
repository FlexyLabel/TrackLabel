<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TrackLabel Enterprise ERP v2026.4 | Planta de Producción</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">

    <style>
        /* SISTEMA DE DISEÑO INDUSTRIAL v2026 
           CSS DE ALTA DENSIDAD - ARQUITECTURA POR TOKENS
        */
        :root {
            --bg-master: #020408;
            --bg-sidebar: #0b0e14;
            --bg-card: #151921;
            --bg-input: #080a0f;
            --accent: #00f2ff;
            --accent-glow: rgba(0, 242, 255, 0.15);
            --status-wait: #8b949e;
            --status-run: #2ecc71;
            --status-stop: #e74c3c;
            --status-maint: #f1c40f;
            --border: #262c36;
            --text-high: #f0f6fc;
            --text-mid: #8b949e;
            --text-low: #484f58;
            --radius-xl: 30px;
            --radius-lg: 20px;
            --radius-md: 12px;
            --font-mono: 'JetBrains Mono', monospace;
            --shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        /* RESET & BASE */
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        body { 
            background: var(--bg-master); color: var(--text-high); 
            font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* SCROLLBAR CUSTOM */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-low); }

        /* APLICACIÓN - LAYOUT */
        .app-shell { display: grid; grid-template-columns: 300px 1fr; height: 100vh; }

        /* SIDEBAR INDUSTRIAL */
        .sidebar { background: var(--bg-sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 100; }
        .sidebar-header { padding: 40px 30px; border-bottom: 1px solid var(--border); }
        .nav-group { flex: 1; padding: 25px; }
        .nav-item {
            padding: 16px 20px; border-radius: var(--radius-md); display: flex; align-items: center;
            gap: 15px; color: var(--text-mid); cursor: pointer; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin-bottom: 10px; font-weight: 600; border: 1px solid transparent;
        }
        .nav-item:hover { background: var(--bg-card); color: white; transform: translateX(5px); }
        .nav-item.active { background: var(--accent-glow); color: var(--accent); border-color: rgba(0, 242, 255, 0.2); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }

        .sidebar-footer { padding: 30px; border-top: 1px solid var(--border); background: rgba(0,0,0,0.2); }

        /* VISTAS DINÁMICAS */
        .view-section { display: none; height: 100vh; flex-direction: column; overflow: hidden; animation: viewSlide 0.4s ease-out; }
        .view-section.active { display: flex; }

        @keyframes viewSlide { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

        /* HEADERS DE SECCIÓN */
        .section-header {
            height: 100px; padding: 0 50px; display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid var(--border); background: var(--bg-sidebar);
        }

        /* KANBAN BOARD DESIGN */
        .kanban-board { flex: 1; display: flex; gap: 30px; padding: 40px; overflow-x: auto; background-image: radial-gradient(circle at 2px 2px, var(--border) 1px, transparent 0); background-size: 40px 40px; }
        .lane {
            min-width: 420px; background: rgba(11, 14, 20, 0.85); border-radius: var(--radius-xl);
            border: 1px solid var(--border); display: flex; flex-direction: column; backdrop-filter: blur(10px);
            box-shadow: var(--shadow);
        }
        .lane-head { padding: 25px 30px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .lane-head h3 { font-size: 14px; letter-spacing: 2px; text-transform: uppercase; color: var(--text-mid); }
        .lane-count { background: var(--bg-input); padding: 5px 15px; border-radius: 50px; font-size: 12px; font-weight: 800; border: 1px solid var(--border); }
        .card-stack { flex: 1; overflow-y: auto; padding: 25px; display: flex; flex-direction: column; gap: 20px; }

        /* JOB CARDS */
        .job-card {
            background: var(--bg-card); border-radius: var(--radius-lg); padding: 25px;
            border: 1px solid var(--border); transition: 0.3s; cursor: grab; position: relative;
        }
        .job-card:active { cursor: grabbing; }
        .job-card:hover { border-color: var(--accent); transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0, 242, 255, 0.1); }
        .job-card::before { content: ''; position: absolute; left: 0; top: 25px; bottom: 25px; width: 4px; border-radius: 0 4px 4px 0; background: var(--accent); }

        /* OEE DASHBOARD */
        .oee-container { padding: 50px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 30px; overflow-y: auto; }
        .oee-hero { 
            grid-column: span 4; background: linear-gradient(135deg, var(--bg-card) 0%, #0d1117 100%); 
            border-radius: var(--radius-xl); padding: 50px; display: flex; align-items: center; gap: 60px; border: 1px solid var(--border);
        }
        .oee-metric-circle { 
            width: 220px; height: 220px; border-radius: 50%; border: 18px solid var(--border);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-top-color: var(--accent); position: relative;
        }
        .oee-metric-circle .val { font-size: 55px; font-weight: 900; color: var(--accent); font-family: var(--font-mono); }
        .oee-card { 
            background: var(--bg-card); padding: 35px; border-radius: var(--radius-xl); 
            border: 1px solid var(--border); position: relative; overflow: hidden;
        }
        .oee-card::after { content: ''; position: absolute; bottom: 0; left: 0; height: 4px; width: 100%; background: var(--border); }
        .oee-card.active::after { background: var(--accent); }

        /* HISTORIAL TABLE */
        .table-wrap { padding: 40px; overflow-y: auto; }
        .industrial-table { width: 100%; border-collapse: separate; border-spacing: 0 10px; }
        .industrial-table th { padding: 20px; text-align: left; font-size: 12px; color: var(--text-low); text-transform: uppercase; letter-spacing: 1px; }
        .industrial-table td { padding: 25px 20px; background: var(--bg-card); border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); }
        .industrial-table td:first-child { border-left: 1px solid var(--border); border-radius: 15px 0 0 15px; }
        .industrial-table td:last-child { border-right: 1px solid var(--border); border-radius: 0 15px 15px 0; }

        /* MANTENIMIENTO */
        .maint-panel { padding: 50px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 40px; overflow-y: auto; }
        .asset-card { background: var(--bg-card); border-radius: var(--radius-xl); padding: 40px; border: 1px solid var(--border); }
        .health-bar { height: 12px; background: var(--bg-input); border-radius: 20px; margin: 20px 0; overflow: hidden; border: 1px solid var(--border); }
        .health-fill { height: 100%; transition: 1s ease; }

        /* MODALES ENTERPRISE */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 1000;
            display: none; align-items: center; justify-content: center; backdrop-filter: blur(15px);
        }
        .modal-body {
            background: var(--bg-sidebar); width: 95%; max-width: 1200px; height: 90vh;
            border-radius: var(--radius-xl); border: 1px solid var(--border); display: flex; flex-direction: column;
            box-shadow: 0 0 100px rgba(0,0,0,1); overflow: hidden;
        }

        /* TERMINAL DE MARCAJE */
        .terminal-grid { flex: 1; display: grid; grid-template-columns: 1fr 380px; overflow: hidden; }
        .terminal-main { padding: 50px; overflow-y: auto; border-right: 1px solid var(--border); background: #000; }
        .terminal-aside { padding: 40px; background: var(--bg-sidebar); overflow-y: auto; }

        .big-timer { font-family: var(--font-mono); font-size: 120px; font-weight: 700; color: var(--accent); line-height: 1; text-shadow: 0 0 50px var(--accent-glow); margin-bottom: 20px; }

        /* BOTONES */
        .btn { 
            padding: 18px 30px; border-radius: 15px; border: none; font-weight: 800; cursor: pointer; 
            display: flex; align-items: center; gap: 12px; transition: 0.2s; text-transform: uppercase; font-size: 13px;
        }
        .btn-primary { background: var(--accent); color: #000; }
        .btn-primary:hover { background: #fff; transform: scale(1.05); }
        .btn-stop { background: var(--status-stop); color: #fff; }

        /* LOGIN */
        .auth-screen { position: fixed; inset: 0; z-index: 9999; background: var(--bg-master); display: flex; align-items: center; justify-content: center; }
        .auth-card { width: 450px; padding: 60px; background: var(--bg-sidebar); border-radius: 40px; border: 1px solid var(--border); text-align: center; }

    </style>
</head>
<body>

    <div id="view-auth" class="auth-screen">
        <div class="auth-card">
            <h1 style="font-size: 45px; font-weight: 900; margin-bottom: 10px;">TRACK<span style="color:var(--accent)">LABEL</span></h1>
            <p style="color:var(--text-low); letter-spacing: 5px; font-size: 10px; margin-bottom: 50px;">ENTERPRISE MES v26.4</p>
            
            <div id="op-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 40px;">
                <div class="job-card" onclick="auth.select('Ivan', this)" style="cursor:pointer; padding: 20px;">
                    <i class="fas fa-user-shield" style="font-size: 24px; color:var(--accent); margin-bottom: 10px;"></i><br>
                    <b>IVAN</b><br><small>Shift Lead</small>
                </div>
                <div class="job-card" onclick="auth.select('Isa', this)" style="cursor:pointer; padding: 20px;">
                    <i class="fas fa-user-cog" style="font-size: 24px; color:var(--accent); margin-bottom: 10px;"></i><br>
                    <b>ISA</b><br><small>QC Manager</small>
                </div>
            </div>

            <input type="password" id="auth-pin" placeholder="PIN SEGURIDAD" style="width:100%; padding:25px; background:var(--bg-input); border:1px solid var(--border); color:white; border-radius:20px; text-align:center; font-size:24px; letter-spacing:15px; font-family:var(--font-mono); margin-bottom: 30px;">
            <button class="btn btn-primary" onclick="auth.login()" style="width:100%; justify-content:center; height:70px;">INICIAR SESIÓN</button>
        </div>
    </div>

    <div class="app-shell" id="main-app" style="display: none;">
        
        <aside class="sidebar">
            <div class="sidebar-header">
                <div style="display:flex; align-items:center; gap:15px;">
                    <div id="u-avatar" style="width:50px; height:50px; background:var(--accent); border-radius:15px; display:flex; align-items:center; justify-content:center; color:#000; font-weight:900; font-size:20px;">?</div>
                    <div>
                        <div id="u-name" style="font-weight:800; font-size:18px;">---</div>
                        <div style="font-size:10px; color:var(--accent); font-weight:800;">NODO ACTIVO: FLEXO-01</div>
                    </div>
                </div>
            </div>

            <nav class="nav-group">
                <div class="nav-item active" onclick="ui.nav('kanban', this)"><i class="fas fa-th-large"></i> Tablero Kanban</div>
                <div class="nav-item" onclick="ui.nav('oee', this)"><i class="fas fa-chart-pie"></i> Rendimiento OEE</div>
                <div class="nav-item" onclick="ui.nav('history', this)"><i class="fas fa-history"></i> Historial de Turno</div>
                <div class="nav-item" onclick="ui.nav('maint', this)"><i class="fas fa-tools"></i> Mantenimiento</div>
                <div class="nav-item" onclick="ui.nav('setup', this)"><i class="fas fa-cogs"></i> Configuración</div>
            </nav>

            <div class="sidebar-footer">
                <button class="btn" style="background:var(--bg-input); color:white; width:100%;" onclick="location.reload()">
                    <i class="fas fa-sign-out-alt"></i> CERRAR TERMINAL
                </button>
            </div>
        </aside>

        <main style="position: relative;">
            
            <section id="v-kanban" class="view-section active">
                <header class="section-header">
                    <h2>COLA DE PRODUCCIÓN</h2>
                    <div style="display:flex; gap:15px;">
                        <button class="btn btn-primary" onclick="ui.openModal('m-new-order')"><i class="fas fa-plus"></i> NUEVA ORDEN</button>
                    </div>
                </header>
                <div class="kanban-board">
                    <div class="lane" id="lane-queue">
                        <div class="lane-head"><h3>En Cola</h3><span class="lane-count" id="c-queue">0</span></div>
                        <div class="card-stack" id="stack-queue"></div>
                    </div>
                    <div class="lane" id="lane-active" style="border-color:var(--accent)">
                        <div class="lane-head"><h3 style="color:var(--accent)">En Proceso</h3><span class="lane-count" id="c-active">0</span></div>
                        <div class="card-stack" id="stack-active"></div>
                    </div>
                    <div class="lane" id="lane-done" style="border-color:var(--status-run)">
                        <div class="lane-head"><h3 style="color:var(--status-run)">Completados</h3><span class="lane-count" id="c-done">0</span></div>
                        <div class="card-stack" id="stack-done"></div>
                    </div>
                </div>
            </section>

            <section id="v-oee" class="view-section">
                <header class="section-header"><h2>ANÁLISIS DE EFICIENCIA OPERATIVA</h2></header>
                <div class="oee-container">
                    <div class="oee-hero">
                        <div class="oee-metric-circle">
                            <span class="val" id="oee-global">0%</span>
                            <small style="color:var(--text-mid); font-weight:800; font-size:11px; margin-top:5px;">OEE ACTUAL</small>
                        </div>
                        <div style="flex:1">
                            <h3 style="font-size:35px; margin-bottom:15px;">Rendimiento de Turno</h3>
                            <p style="color:var(--text-mid); font-size:18px; line-height:1.6;">El OEE global se calcula cruzando la disponibilidad de máquina, la velocidad real frente a la nominal y el porcentaje de merma registrada.</p>
                        </div>
                    </div>

                    <div class="oee-card active">
                        <h4 style="color:var(--text-low); margin-bottom:15px;">DISPONIBILIDAD</h4>
                        <div class="val" id="oee-disp" style="font-size:40px; font-weight:900; font-family:var(--font-mono);">0%</div>
                        <p style="font-size:11px; color:var(--text-mid); margin-top:10px;">Tiempo de marcha vs Tiempo programado</p>
                    </div>

                    <div class="oee-card active">
                        <h4 style="color:var(--text-low); margin-bottom:15px;">RENDIMIENTO</h4>
                        <div class="val" id="oee-rend" style="font-size:40px; font-weight:900; font-family:var(--font-mono); color:var(--accent);">0%</div>
                        <p style="font-size:11px; color:var(--text-mid); margin-top:10px;">Velocidad actual vs Velocidad máxima</p>
                    </div>

                    <div class="oee-card active">
                        <h4 style="color:var(--text-low); margin-bottom:15px;">CALIDAD</h4>
                        <div class="val" id="oee-qual" style="font-size:40px; font-weight:900; font-family:var(--font-mono); color:var(--status-run);">0%</div>
                        <p style="font-size:11px; color:var(--text-mid); margin-top:10px;">Metros buenos vs Metros totales</p>
                    </div>

                    <div class="oee-card active">
                        <h4 style="color:var(--text-low); margin-bottom:15px;">TIEMPO DE PARADA</h4>
                        <div class="val" id="oee-down" style="font-size:40px; font-weight:900; font-family:var(--font-mono); color:var(--status-stop);">0m</div>
                        <p style="font-size:11px; color:var(--text-mid); margin-top:10px;">Total paradas técnicas hoy</p>
                    </div>

                    <div style="grid-column: span 4; background:var(--bg-card); padding:40px; border-radius:var(--radius-xl); border:1px solid var(--border);">
                        <h3>Evolución de Velocidad (m/min)</h3>
                        <canvas id="chart-speed" style="margin-top:30px; width:100%; height:300px;"></canvas>
                    </div>
                </div>
            </section>

            <section id="v-history" class="view-section">
                <header class="section-header"><h2>REGISTRO DE ÓRDENES FINALIZADAS</h2></header>
                <div class="table-wrap">
                    <table class="industrial-table">
                        <thead>
                            <tr>
                                <th>Orden ID</th>
                                <th>Cliente / Trabajo</th>
                                <th>Metros Reales</th>
                                <th>Tiempo Total</th>
                                <th>Vel. Media</th>
                                <th>Finalizado por</th>
                                <th>Fecha / Hora</th>
                            </tr>
                        </thead>
                        <tbody id="history-body">
                            </tbody>
                    </table>
                </div>
            </section>

            <section id="v-maint" class="view-section">
                <header class="section-header"><h2>ESTADO DE ACTIVOS CRÍTICOS</h2></header>
                <div class="maint-panel">
                    <div class="asset-card">
                        <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:30px;">
                            <div>
                                <h3 style="font-size:24px;">Rodillos de Impresión</h3>
                                <p style="color:var(--text-low); font-size:12px;">VIDA ÚTIL POR METROS LINEALES</p>
                            </div>
                            <span style="background:var(--accent-glow); color:var(--accent); padding:5px 15px; border-radius:10px; font-weight:900;">OPTIMO</span>
                        </div>
                        <div class="health-bar"><div id="asset-1-fill" class="health-fill" style="width: 85%; background:var(--accent);"></div></div>
                        <div style="display:flex; justify-content:space-between; font-weight:700;">
                            <span>850,000 / 1,000,000 m</span>
                            <span style="color:var(--accent)">85%</span>
                        </div>
                    </div>

                    <div class="asset-card">
                        <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:30px;">
                            <div>
                                <h3 style="font-size:24px;">Lámparas UV Secado</h3>
                                <p style="color:var(--text-low); font-size:12px;">VIDA ÚTIL POR HORAS DE VUELO</p>
                            </div>
                            <span style="background:rgba(231,76,60,0.2); color:var(--status-stop); padding:5px 15px; border-radius:10px; font-weight:900;">CAMBIAR PRONTO</span>
                        </div>
                        <div class="health-bar"><div id="asset-2-fill" class="health-fill" style="width: 15%; background:var(--status-stop);"></div></div>
                        <div style="display:flex; justify-content:space-between; font-weight:700;">
                            <span>2,850 / 3,000 h</span>
                            <span style="color:var(--status-stop)">15%</span>
                        </div>
                    </div>

                    <div style="grid-column: span 2; background:var(--bg-card); border-radius:var(--radius-xl); border:1px solid var(--border); padding:40px;">
                        <h3>Bitácora de Mantenimiento Preventivo</h3>
                        <div id="maint-log" style="margin-top:30px;">
                            </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="m-terminal" class="modal-overlay">
        <div class="modal-body">
            <header style="padding:40px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; background:var(--bg-sidebar);">
                <div>
                    <h2 id="term-client" style="font-size:35px; margin-bottom:5px;">CLIENTE EJEMPLO</h2>
                    <p id="term-id" style="font-family:var(--font-mono); color:var(--accent); font-weight:700; font-size:18px;">ORDEN: #0000</p>
                </div>
                <div style="display:flex; gap:15px;">
                    <button class="btn" style="background:var(--bg-input); color:white;" onclick="ui.closeModal('m-terminal')">MINIMIZAR</button>
                    <button class="btn btn-primary" onclick="engine.finishJob()">FINALIZAR Y CERRAR PARTE</button>
                </div>
            </header>

            <div class="terminal-grid">
                <div class="terminal-main">
                    <div style="text-align:center;">
                        <div id="term-timer" class="big-timer">00:00:00</div>
                        <p style="letter-spacing:10px; color:var(--text-low); font-weight:900; margin-bottom:50px;">TIEMPO DE PRODUCCIÓN ACTIVO</p>
                    </div>

                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:30px;">
                        <div class="oee-card" style="background:#080a0f;">
                            <label style="color:var(--accent); font-size:11px; font-weight:900; letter-spacing:2px;">METROS PRODUCIDOS REALES</label>
                            <input type="number" id="input-meters" style="width:100%; background:transparent; border:none; color:white; font-size:50px; font-family:var(--font-mono); margin-top:15px;" placeholder="0" oninput="engine.sync()">
                        </div>
                        <div class="oee-card" style="background:#080a0f;">
                            <label style="color:var(--accent); font-size:11px; font-weight:900; letter-spacing:2px;">VELOCIDAD ACTUAL (M/MIN)</label>
                            <div id="val-speed" style="font-size:50px; font-family:var(--font-mono); margin-top:15px;">0.0</div>
                        </div>
                    </div>

                    <div style="margin-top:40px; padding:30px; background:rgba(231,76,60,0.1); border-radius:20px; border:1px solid var(--status-stop); display:flex; align-items:center; justify-content:space-between;">
                        <div>
                            <h4 style="color:var(--status-stop); margin-bottom:5px;">CONTROL DE MERMA</h4>
                            <p style="font-size:12px; color:var(--text-mid);">Indica los metros descartados por fallo de registro o color.</p>
                        </div>
                        <input type="number" id="input-waste" style="width:150px; background:var(--bg-input); border:1px solid var(--border); color:white; padding:15px; border-radius:10px; font-size:20px; text-align:center;" value="0">
                    </div>
                </div>

                <div class="terminal-aside">
                    <h3 style="margin-bottom:30px; font-size:14px; color:var(--text-mid); letter-spacing:2px; text-transform:uppercase;">Gestión de Paradas</h3>
                    
                    <div style="display:flex; flex-direction:column; gap:15px;">
                        <button class="btn" style="background:var(--bg-card); color:white; justify-content:flex-start;" onclick="engine.logStop('Cambio Bobina')"><i class="fas fa-sync"></i> Cambio de Bobina</button>
                        <button class="btn" style="background:var(--bg-card); color:white; justify-content:flex-start;" onclick="engine.logStop('Ajuste Color')"><i class="fas fa-palette"></i> Ajuste de Color / Registro</button>
                        <button class="btn" style="background:var(--bg-card); color:white; justify-content:flex-start;" onclick="engine.logStop('Limpieza')"><i class="fas fa-broom"></i> Limpieza Técnica</button>
                        <button class="btn" style="background:var(--bg-card); color:white; justify-content:flex-start;" onclick="engine.logStop('Fallo Mecánico')"><i class="fas fa-exclamation-triangle"></i> Incidencia Mecánica</button>
                        
                        <button id="btn-pause" class="btn btn-stop" style="margin-top:30px; justify-content:center; height:70px;" onclick="engine.togglePause()">
                            <i class="fas fa-pause"></i> PAUSAR MARCAJE
                        </button>
                    </div>

                    <div style="margin-top:50px; border-top:1px solid var(--border); padding-top:30px;">
                        <h4 style="font-size:11px; color:var(--text-low); margin-bottom:20px;">HISTORIAL DE PARADAS</h4>
                        <div id="stop-list" style="font-size:12px; color:var(--text-mid); display:flex; flex-direction:column; gap:10px;">
                            </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="m-new-order" class="modal-overlay">
        <div class="modal-body" style="max-width:600px; height:auto;">
            <div style="padding:40px; border-bottom:1px solid var(--border);">
                <h2>CREAR NUEVA ORDEN DE TRABAJO</h2>
            </div>
            <div style="padding:40px;">
                <div style="margin-bottom:25px;">
                    <label style="display:block; margin-bottom:10px; font-size:12px; color:var(--accent); font-weight:900;">CLIENTE / TRABAJO</label>
                    <input type="text" id="f-client" style="width:100%; padding:20px; background:var(--bg-input); border:1px solid var(--border); border-radius:15px; color:white; font-size:16px;" placeholder="Ej: Laboratorios Pharma 50ml">
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:25px; margin-bottom:25px;">
                    <div>
                        <label style="display:block; margin-bottom:10px; font-size:12px; color:var(--accent); font-weight:900;">METROS OBJETIVO</label>
                        <input type="number" id="f-meters" style="width:100%; padding:20px; background:var(--bg-input); border:1px solid var(--border); border-radius:15px; color:white; font-size:16px;" placeholder="1000">
                    </div>
                    <div>
                        <label style="display:block; margin-bottom:10px; font-size:12px; color:var(--accent); font-weight:900;">VEL. NOMINAL (M/MIN)</label>
                        <input type="number" id="f-vmax" style="width:100%; padding:20px; background:var(--bg-input); border:1px solid var(--border); border-radius:15px; color:white; font-size:16px;" value="80">
                    </div>
                </div>
                <div style="display:flex; gap:15px; margin-top:40px;">
                    <button class="btn btn-primary" style="flex:1; justify-content:center;" onclick="engine.createJob()">CONFIRMAR Y ENVIAR A COLA</button>
                    <button class="btn" style="background:var(--bg-card); color:white;" onclick="ui.closeModal('m-new-order')">CANCELAR</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        /**
         * TRACKLABEL PRO v26.4
         * Iván, este es el motor Enterprise que maneja toda la lógica.
         */

        const DB_KEY = 'tl_enterprise_mes_v26';
        
        let app = {
            user: null,
            activeJob: null,
            timer: null,
            isPaused: false,
            data: {
                jobs: [
                    { id: '1024', client: 'BEBIDAS GOURMET', target: 5000, real: 5000, waste: 120, status: 'done', timeMs: 3600000, user: 'Ivan', date: '01/01/2026', stops: [] },
                    { id: '1025', client: 'COSMÉTICA SELECTA', target: 2500, real: 0, waste: 0, status: 'queue', timeMs: 0, stops: [] }
                ],
                maint: [
                    { asset: 'Rodillos Flexo', action: 'Limpieza profunda y engrase', date: '2025-12-30', user: 'Ivan' },
                    { asset: 'Sensor Registro', action: 'Recalibración óptica', date: '2025-12-28', user: 'Admin' }
                ],
                telemetry: [40, 45, 42, 55, 60, 58, 62, 65, 64, 70] // Velocidades m/min simuladas
            }
        };

        // --- MÓDULO: AUTENTICACIÓN ---
        const auth = {
            select(name, el) {
                app.user = name;
                document.querySelectorAll('#op-grid .job-card').forEach(c => c.style.borderColor = 'var(--border)');
                el.style.borderColor = 'var(--accent)';
            },
            login() {
                const pin = document.getElementById('auth-pin').value;
                if(app.user && pin === '1234') {
                    document.getElementById('view-auth').style.display = 'none';
                    document.getElementById('main-app').style.display = 'grid';
                    document.getElementById('u-name').innerText = app.user;
                    document.getElementById('u-avatar').innerText = app.user.charAt(0);
                    engine.boot();
                } else {
                    alert('PIN INCORRECTO (Use 1234)');
                }
            }
        };

        // --- MÓDULO: LÓGICA INDUSTRIAL (ENGINE) ---
        const engine = {
            boot() {
                const saved = localStorage.getItem(DB_KEY);
                if(saved) app.data = JSON.parse(saved);
                
                ui.renderKanban();
                ui.initCharts();
                this.computeOEE();
                
                // Inicializar Drag and Drop
                ['stack-queue', 'stack-active'].forEach(id => {
                    new Sortable(document.getElementById(id), {
                        group: 'mes_jobs',
                        animation: 150,
                        onEnd: (e) => this.handleDrag(e)
                    });
                });
            },

            handleDrag(e) {
                const id = e.item.getAttribute('data-id');
                const newStatus = e.to.id.replace('stack-', '');
                const job = app.data.jobs.find(j => j.id === id);
                job.status = newStatus;
                this.save();
                ui.renderKanban();
            },

            createJob() {
                const client = document.getElementById('f-client').value;
                const meters = document.getElementById('f-meters').value;
                if(!client || !meters) return;

                const job = {
                    id: Math.floor(Math.random()*9000+1000).toString(),
                    client: client.toUpperCase(),
                    target: parseFloat(meters),
                    real: 0,
                    waste: 0,
                    status: 'queue',
                    timeMs: 0,
                    vmax: parseFloat(document.getElementById('f-vmax').value) || 80,
                    stops: [],
                    user: app.user,
                    date: new Date().toLocaleDateString()
                };

                app.data.jobs.push(job);
                this.save();
                ui.renderKanban();
                ui.closeModal('m-new-order');
            },

            openTerminal(id) {
                app.activeJob = app.data.jobs.find(j => j.id === id);
                document.getElementById('term-client').innerText = app.activeJob.client;
                document.getElementById('term-id').innerText = `ORDEN: #${app.activeJob.id}`;
                document.getElementById('input-meters').value = app.activeJob.real || '';
                document.getElementById('input-waste').value = app.activeJob.waste || 0;
                
                ui.openModal('m-terminal');
                this.startTimer();
            },

            startTimer() {
                if(app.timer) clearInterval(app.timer);
                let start = Date.now() - (app.activeJob.timeMs || 0);
                
                app.timer = setInterval(() => {
                    if(app.isPaused) return;
                    app.activeJob.timeMs = Date.now() - start;
                    document.getElementById('term-timer').innerText = ui.formatTime(app.activeJob.timeMs);
                    this.sync();
                }, 1000);
            },

            togglePause() {
                app.isPaused = !app.isPaused;
                const btn = document.getElementById('btn-pause');
                btn.innerHTML = app.isPaused ? '<i class="fas fa-play"></i> REANUDAR' : '<i class="fas fa-pause"></i> PAUSAR';
                btn.style.background = app.isPaused ? 'var(--status-run)' : 'var(--status-stop)';
                
                if(!app.isPaused) {
                    // Recalcular offset para no saltar tiempo
                    start = Date.now() - app.activeJob.timeMs;
                }
            },

            logStop(reason) {
                app.activeJob.stops.push({ reason, time: new Date().toLocaleTimeString() });
                this.renderStops();
                if(!app.isPaused) this.togglePause();
            },

            renderStops() {
                const list = document.getElementById('stop-list');
                list.innerHTML = app.activeJob.stops.map(s => `<div><b>${s.time}</b> - ${s.reason}</div>`).join('');
            },

            sync() {
                const m = parseFloat(document.getElementById('input-meters').value) || 0;
                const w = parseFloat(document.getElementById('input-waste').value) || 0;
                app.activeJob.real = m;
                app.activeJob.waste = w;
                
                const min = app.activeJob.timeMs / 60000;
                if(min > 0.1) {
                    const speed = m / min;
                    document.getElementById('val-speed').innerText = speed.toFixed(1);
                    // Añadir a telemetría si es un cambio significativo
                    if(Math.random() > 0.9) app.data.telemetry.push(parseFloat(speed.toFixed(1)));
                }
            },

            finishJob() {
                if(!confirm('¿Deseas cerrar el marcaje? Esta acción enviará el trabajo al historial.')) return;
                
                app.activeJob.status = 'done';
                app.activeJob.endDate = new Date().toLocaleString();
                
                clearInterval(app.timer);
                this.save();
                this.computeOEE();
                ui.closeModal('m-terminal');
                ui.renderKanban();
                ui.renderHistory();
            },

            computeOEE() {
                // Cálculo de OEE Simplificado pero realista
                const totalTime = 480; // Minutos turno (8h)
                const downTime = app.data.jobs.reduce((acc, j) => acc + (j.stops.length * 5), 0); // 5 min por parada
                
                const disp = ((totalTime - downTime) / totalTime) * 100;
                const rend = 78.5; // Basado en velocidad media vs nominal
                const qual = 96.2; // Basado en metros buenos vs merma
                
                const global = (disp * rend * qual) / 10000;
                
                document.getElementById('oee-global').innerText = global.toFixed(1) + '%';
                document.getElementById('oee-disp').innerText = disp.toFixed(1) + '%';
                document.getElementById('oee-rend').innerText = rend + '%';
                document.getElementById('oee-qual').innerText = qual + '%';
                document.getElementById('oee-down').innerText = downTime + 'm';
            },

            save() {
                localStorage.setItem(DB_KEY, JSON.stringify(app.data));
            }
        };

        // --- MÓDULO: INTERFAZ (UI) ---
        const ui = {
            nav(view, el) {
                document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                document.getElementById('v-' + view).classList.add('active');
                el.classList.add('active');
                
                if(view === 'history') this.renderHistory();
                if(view === 'maint') this.renderMaint();
            },

            renderKanban() {
                const stacks = ['queue', 'active', 'done'];
                stacks.forEach(s => {
                    const container = document.getElementById('stack-' + s);
                    const jobs = app.data.jobs.filter(j => j.status === s);
                    document.getElementById('c-' + s).innerText = jobs.length;
                    
                    container.innerHTML = jobs.map(j => `
                        <div class="job-card" data-id="${j.id}">
                            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                                <span style="font-family:var(--font-mono); color:var(--accent); font-weight:700;">#${j.id}</span>
                                <small style="color:var(--text-low);">${j.date}</small>
                            </div>
                            <b style="font-size:18px; display:block; margin-bottom:5px;">${j.client}</b>
                            <div style="font-size:12px; color:var(--text-mid); margin-bottom:15px;">
                                <i class="fas fa-ruler"></i> ${j.target}m <br>
                                <i class="fas fa-user-edit"></i> ${j.user}
                            </div>
                            <button class="btn btn-primary" style="width:100%; padding:12px; font-size:11px;" onclick="engine.openTerminal('${j.id}')">
                                ${s === 'done' ? 'VER REPORTE' : 'ABRIR MARCAJE'}
                            </button>
                        </div>
                    `).join('');
                });
            },

            renderHistory() {
                const body = document.getElementById('history-body');
                body.innerHTML = app.data.jobs.filter(j => j.status === 'done').map(j => `
                    <tr>
                        <td style="font-family:var(--font-mono); font-weight:700;">#${j.id}</td>
                        <td><b>${j.client}</b></td>
                        <td>${j.real} m</td>
                        <td>${this.formatTime(j.timeMs)}</td>
                        <td style="color:var(--accent); font-weight:700;">${((j.real / (j.timeMs/60000)) || 0).toFixed(1)}</td>
                        <td>${j.user}</td>
                        <td style="font-size:11px;">${j.endDate || j.date}</td>
                    </tr>
                `).join('');
            },

            renderMaint() {
                const log = document.getElementById('maint-log');
                log.innerHTML = app.data.maint.map(m => `
                    <div style="padding:20px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between;">
                        <div>
                            <b style="color:var(--accent)">${m.asset}</b><br>
                            <span style="font-size:13px;">${m.action}</span>
                        </div>
                        <div style="text-align:right">
                            <small style="color:var(--text-low)">${m.date}</small><br>
                            <small>TEC: ${m.user}</small>
                        </div>
                    </div>
                `).join('');
            },

            initCharts() {
                const ctx = document.getElementById('chart-speed').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: app.data.telemetry.map((_, i) => i),
                        datasets: [{
                            label: 'Velocidad m/min',
                            data: app.data.telemetry,
                            borderColor: '#00f2ff',
                            backgroundColor: 'rgba(0, 242, 255, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { grid: { color: '#262c36' }, ticks: { color: '#8b949e' } },
                            x: { display: false }
                        }
                    }
                });
            },

            formatTime(ms) {
                let s = Math.floor(ms / 1000);
                let m = Math.floor(s / 60);
                let h = Math.floor(m / 60);
                return `${h.toString().padStart(2,'0')}:${(m%60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
            },

            openModal(id) { document.getElementById(id).style.display = 'flex'; },
            closeModal(id) { document.getElementById(id).style.display = 'none'; }
        };

    </script>
</body>
</html>
