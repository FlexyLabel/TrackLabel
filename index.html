<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Track Label Pro - Gesti√≥n de Planta</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --bg: #0b0e11;
            --sidebar: #15191d;
            --surface: #1e2329;
            --orange: #ff7a00;
            --green: #00ff88;
            --text: #f0f0f0;
            --border: #282e35;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: var(--bg); 
            color: var(--text); 
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; 
            margin: 0; 
            padding: 0;
            min-height: 100vh;
        }

        /* --- SEGURIDAD: CONTRASE√ëA MAESTRA --- */
        #master-lock {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 50000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .lock-card {
            background: var(--surface);
            padding: 40px;
            border-radius: 35px;
            text-align: center;
            border: 1px solid var(--border);
            width: 100%;
            max-width: 400px;
        }

        /* --- LOGIN: SELECCI√ìN USUARIO --- */
        .login-overlay {
            position: fixed;
            inset: 0;
            background: var(--bg);
            z-index: 40000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .user-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 25px 0;
        }

        .user-circle {
            background: var(--sidebar);
            padding: 15px;
            border-radius: 20px;
            border: 1px solid #333;
            cursor: pointer;
            transition: 0.3s;
        }

        .user-circle.selected { border-color: var(--orange); background: #222; }

        /* --- LAYOUT PRINCIPAL --- */
        .app-wrapper {
            display: flex;
            min-height: 100vh;
        }

        /* Columna Planta (Sidebar) */
        .sidebar-planta {
            width: 320px;
            background: var(--sidebar);
            border-right: 1px solid var(--border);
            padding: 25px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .planta-header { display: flex; align-items: center; gap: 15px; margin-bottom: 10px; }
        .planta-logo { background: var(--orange); color: #000; padding: 10px; border-radius: 12px; font-weight: 900; }

        .panel-info {
            background: var(--surface);
            padding: 20px;
            border-radius: 25px;
            border: 1px solid var(--border);
        }

        .panel-info h4 { margin: 0 0 15px 0; font-size: 11px; letter-spacing: 1.5px; color: var(--orange); text-transform: uppercase; }

        /* Barra de progreso / Rendimiento */
        .progress-container { background: #000; height: 8px; border-radius: 10px; margin: 15px 0 5px 0; overflow: hidden; }
        .progress-bar { background: var(--orange); height: 100%; width: 0%; transition: 1s; }

        /* √Årea de Contenido */
        .main-content {
            flex: 1;
            padding: 25px;
            background: var(--bg);
        }

        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        /* --- ORGANIZACI√ìN VERTICAL DE M√ÅQUINAS (M√ìVIL Y PC) --- */
        .vertical-kanban {
            display: flex;
            flex-direction: column; /* FORZADO VERTICAL */
            gap: 30px;
            max-width: 900px;
            margin: 0 auto;
        }

        .machine-section {
            background: var(--sidebar);
            border-radius: 30px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .machine-title {
            padding: 20px 25px;
            border-bottom: 1px solid #222;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            font-weight: bold;
            color: #888;
        }

        .drop-zone {
            padding: 20px;
            min-height: 120px;
        }

        /* --- TARJETAS --- */
        .job-item {
            background: var(--surface);
            padding: 20px;
            border-radius: 22px;
            margin-bottom: 15px;
            border-left: 6px solid var(--orange);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .job-info strong { display: block; font-size: 16px; margin-bottom: 5px; }
        .job-info span { font-size: 12px; color: #777; }

        /* Botones */
        .btn-main { 
            background: var(--orange); color: white; border: none; padding: 15px 30px; 
            border-radius: 18px; font-weight: bold; cursor: pointer; width: 100%;
        }

        /* --- RESPONSIVE M√ìVIL --- */
        @media (max-width: 850px) {
            .app-wrapper { flex-direction: column; }
            .sidebar-planta { width: 100%; border-right: none; border-bottom: 1px solid var(--border); padding: 15px; }
            .main-content { padding: 15px; }
            .vertical-kanban { gap: 15px; }
            .job-item { padding: 15px; }
        }

        /* Modales */
        .modal-full {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 20000;
            padding: 20px; overflow-y: auto;
        }
        .modal-box {
            background: var(--surface); border-radius: 35px; padding: 35px; width: 100%; max-width: 500px; margin: 0 auto;
        }
        input, select { 
            width: 100%; padding: 15px; background: #000; border: 1px solid #333; 
            color: white; border-radius: 15px; margin-bottom: 15px;
        }
    </style>
</head>
<body>

<div id="master-lock">
    <div class="lock-card">
        <h2 style="color:var(--orange)">SEGURIDAD</h2>
        <p>Entra la contrase√±a de la web: <strong>TrackLabel#</strong></p>
        <input type="password" id="m-pass" placeholder="Contrase√±a">
        <button class="btn-main" onclick="unlockWeb()">DESBLOQUEAR</button>
    </div>
</div>

<div id="login-overlay" class="login-overlay" style="display:none">
    <div class="lock-card">
        <h3>ACCESO OPERARIO</h3>
        <div class="user-grid">
            <div class="user-circle" onclick="selectUser('Isa', this)">I</div>
            <div class="user-circle" onclick="selectUser('Jaume', this)">J</div>
            <div class="user-circle" onclick="selectUser('Ivan', this)">I</div>
            <div class="user-circle" onclick="selectUser('Anna', this)">A</div>
            <div class="user-circle" onclick="selectUser('Toni', this)">T</div>
        </div>
        <input type="password" id="u-pin" placeholder="PIN">
        <button class="btn-main" onclick="login()">ENTRAR</button>
    </div>
</div>

<div id="app-body" class="app-wrapper" style="display:none">
    
    <aside class="sidebar-planta">
        <div class="planta-header">
            <div class="planta-logo">TL</div>
            <h3 style="margin:0">PLANTA</h3>
        </div>

        <div class="panel-info">
            <h4>RENDIMIENTO</h4>
            <div class="progress-container"><div id="progress" class="progress-bar"></div></div>
            <p id="progress-text" style="font-size:12px; margin-top:10px;">0% completado</p>
        </div>

        <div class="panel-info">
            <h4>ESTAD√çSTICAS</h4>
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span>Activos:</span> <strong id="count-activos">0</strong>
            </div>
            <div style="display:flex; justify-content:space-between;">
                <span>Finalizados:</span> <strong id="count-final" style="color:var(--green)">0</strong>
            </div>
        </div>

        <div class="panel-info" style="flex:1;">
            <h4>HISTORIAL</h4>
            <div id="log-list" style="font-size:11px; color:#555; overflow-y:auto; max-height:200px;"></div>
        </div>

        <p style="font-size:10px; color:#333; text-align:center;">SINCRONIZACI√ìN AUTOM√ÅTICA ACTIVA</p>
    </aside>

    <main class="main-content">
        <header class="top-nav">
            <div>
                <h2 id="current-op" style="margin:0">Hola, Iv√°n</h2>
                <span style="color:var(--orange); font-size:12px; font-weight:bold;">ACCESO ADMINISTRADOR</span>
            </div>
            <button class="btn-main" style="width:auto; padding:12px 20px;" onclick="openAdd()">+ NUEVO PEDIDO</button>
        </header>

        <div class="vertical-kanban">
            <div class="machine-section">
                <div class="machine-title">FLEXO / OFFSET <span id="n-flexo" class="badge">0</span></div>
                <div id="list-flexo" class="drop-zone"></div>
            </div>

            <div class="machine-section">
                <div class="machine-title">DIGITAL <span id="n-digital" class="badge">0</span></div>
                <div id="list-digital" class="drop-zone"></div>
            </div>

            <div class="machine-section">
                <div class="machine-title">REPASO / EXPEDICI√ìN <span id="n-repaso" class="badge">0</span></div>
                <div id="list-acabados" class="drop-zone"></div>
            </div>
        </div>
    </main>
</div>

<div id="modal-add" class="modal-full">
    <div class="modal-box">
        <h2 style="margin-top:0">NUEVA ORDEN</h2>
        <label>CLIENTE</label>
        <input type="text" id="f-cli" placeholder="Nombre cliente">
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
            <div>
                <label>M√ÅQUINA</label>
                <select id="f-maq">
                    <option value="list-flexo">FLEXO</option>
                    <option value="list-digital">DIGITAL</option>
                </select>
            </div>
            <div>
                <label>METROS</label>
                <input type="number" id="f-met" placeholder="0">
            </div>
        </div>

        <label>TROQUEL / GRABADO</label>
        <input type="text" id="f-tec" placeholder="Ref. t√©cnica">

        <button class="btn-main" onclick="saveJob()">Lanzar a Planta</button>
        <button onclick="closeAdd()" style="width:100%; background:none; border:none; color:#555; margin-top:15px; cursor:pointer;">Cancelar</button>
    </div>
</div>

<script>
// --- CONFIG ---
const MASTER_KEY = "TrackLabel#";
const OPERARIOS = {"Ivan":"1234", "Isa":"1234", "Jaume":"1234", "Anna":"1234", "Toni":"1234"};

let db = JSON.parse(localStorage.getItem('tl_v_db')) || {};
let finalizados = parseInt(localStorage.getItem('tl_v_final')) || 0;
let userActivo = "Iv√°n";

// --- SEGURIDAD ---
function unlockWeb() {
    if(document.getElementById('m-pass').value === MASTER_KEY) {
        document.getElementById('master-lock').style.display = 'none';
        document.getElementById('login-overlay').style.display = 'flex';
    } else { alert("Error"); }
}

function selectUser(n, el) {
    userActivo = n;
    document.querySelectorAll('.user-circle').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected');
}

function login() {
    const pin = document.getElementById('u-pin').value;
    if(OPERARIOS[userActivo] === pin) {
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('app-body').style.display = 'flex';
        document.getElementById('current-op').innerText = "Hola, " + userActivo;
        initSortable();
        render();
    } else { alert("PIN Incorrecto"); }
}

// --- PRODUCCI√ìN ---
function render() {
    document.querySelectorAll('.drop-zone').forEach(z => z.innerHTML = "");
    
    Object.keys(db).forEach(id => {
        const item = db[id];
        const card = document.createElement('div');
        card.className = "job-item";
        card.id = id;
        card.innerHTML = `
            <div class="job-info">
                <strong>${item.cli.toUpperCase()}</strong>
                <span>üìè ${item.met}m | üõ†Ô∏è ${item.tec}</span>
            </div>
            <button onclick="finishJob('${id}')" style="background:#00ff8822; color:var(--green); border:1px solid var(--green); padding:8px 15px; border-radius:12px; font-size:10px; cursor:pointer;">OK</button>
        `;
        document.getElementById(item.maq).appendChild(card);
    });
    
    updateStats();
}

function saveJob() {
    const cli = document.getElementById('f-cli').value;
    const met = document.getElementById('f-met').value;
    if(!cli || !met) return;

    const id = "ID-" + Date.now();
    db[id] = {
        cli: cli,
        maq: document.getElementById('f-maq').value,
        met: met,
        tec: document.getElementById('f-tec').value || "S/N"
    };
    
    saveAll();
    closeAdd();
    logAction("Pedido a√±adido: " + cli);
}

function finishJob(id) {
    logAction("Finalizado: " + db[id].cli);
    delete db[id];
    finalizados++;
    saveAll();
}

function initSortable() {
    document.querySelectorAll('.drop-zone').forEach(zone => {
        new Sortable(zone, {
            group: 'shared',
            animation: 150,
            onEnd: (evt) => {
                db[evt.item.id].maq = evt.to.id;
                saveAll();
                logAction("Movido a " + evt.to.id.replace('list-',''));
            }
        });
    });
}

// --- UTILIDADES ---
function saveAll() {
    localStorage.setItem('tl_v_db', JSON.stringify(db));
    localStorage.setItem('tl_v_final', finalizados);
    render();
}

function updateStats() {
    const activos = Object.keys(db).length;
    document.getElementById('count-activos').innerText = activos;
    document.getElementById('count-final').innerText = finalizados;
    
    // Calcular rendimiento
    const total = activos + finalizados;
    const porc = total === 0 ? 0 : Math.round((finalizados / total) * 100);
    document.getElementById('progress').style.width = porc + "%";
    document.getElementById('progress-text').innerText = porc + "% completado";

    // Contadores individuales
    document.getElementById('n-flexo').innerText = document.getElementById('list-flexo').children.length;
    document.getElementById('n-digital').innerText = document.getElementById('list-digital').children.length;
    document.getElementById('n-repaso').innerText = document.getElementById('list-acabados').children.length;
}

function logAction(msg) {
    const log = document.getElementById('log-list');
    const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    log.innerHTML = `<div>[${time}] ${msg}</div>` + log.innerHTML;
}

function openAdd() { document.getElementById('modal-add').style.display = 'block'; }
function closeAdd() { document.getElementById('modal-add').style.display = 'none'; }
</script>

</body>
</html>
