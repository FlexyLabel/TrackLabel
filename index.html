<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TRACKLABEL ERP ENTERPRISE v2026.ULTRA_CORE - IVAN EDITION</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* ==========================================================================
           1. SISTEMA DE DISEÑO (DESIGN SYSTEM) - 200+ LINEAS DE CSS
           ========================================================================== */
        :root {
            --bg-ultra: #020408;
            --bg-base: #0d1117;
            --bg-card: #161b22;
            --bg-elevated: #21262d;
            --bg-input: #010409;
            --primary: #58a6ff;
            --primary-bright: #1f6feb;
            --primary-glow: rgba(88, 166, 255, 0.2);
            --secondary: #30363d;
            --accent: #bc8cff;
            --success: #238636;
            --success-bright: #3fb950;
            --warning: #d29922;
            --danger: #da3633;
            --danger-bright: #f85149;
            --text-main: #c9d1d9;
            --text-bold: #f0f6fc;
            --text-muted: #8b949e;
            --border: #30363d;
            --border-hover: #8b949e;
            --font-main: 'Inter', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --transition-fast: 0.15s ease;
            --transition-slow: 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            --shadow-sm: 0 4px 12px rgba(0,0,0,0.5);
            --shadow-lg: 0 20px 50px rgba(0,0,0,0.8);
        }

        /* RESET GENERAL */
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg-ultra);
            color: var(--text-main);
            font-family: var(--font-main);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            line-height: 1.5;
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-ultra); }
        ::-webkit-scrollbar-thumb { background: var(--secondary); border-radius: 4px; border: 2px solid var(--bg-ultra); }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

        /* ANIMACIONES CORE */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideLeft { from { transform: translateX(50px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes pulseGlow { 0% { box-shadow: 0 0 5px var(--primary-glow); } 50% { box-shadow: 0 0 25px var(--primary-glow); } 100% { box-shadow: 0 0 5px var(--primary-glow); } }

        /* ==========================================================================
           2. CAPA DE AUTENTICACIÓN (SECURITY GATE)
           ========================================================================== */
        #auth-gate {
            position: fixed;
            inset: 0;
            z-index: 100000;
            background: linear-gradient(135deg, #0d1117 0%, #010409 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.8s cubic-bezier(0.7, 0, 0.3, 1), opacity 0.5s ease;
        }

        .auth-container {
            width: 100%;
            max-width: 1100px;
            padding: 80px 40px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            text-align: center;
        }

        .auth-header h1 {
            font-size: 56px;
            font-weight: 900;
            letter-spacing: -3px;
            color: var(--text-bold);
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .auth-header p {
            font-size: 12px;
            letter-spacing: 8px;
            color: var(--primary);
            margin-bottom: 60px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .user-selection-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 25px;
            margin-bottom: 60px;
        }

        .user-tile {
            background: var(--bg-elevated);
            border: 2px solid var(--border);
            padding: 35px 20px;
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: var(--transition-slow);
            position: relative;
            overflow: hidden;
        }

        .user-tile::before {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 4px;
            background: var(--primary);
            transform: scaleX(0);
            transition: var(--transition-slow);
        }

        .user-tile:hover {
            transform: translateY(-10px);
            border-color: var(--primary);
            background: var(--bg-card);
        }

        .user-tile:hover::before, .user-tile.active::before {
            transform: scaleX(1);
        }

        .user-tile.active {
            border-color: var(--primary);
            background: var(--primary-glow);
            box-shadow: 0 0 30px var(--primary-glow);
        }

        .user-tile i { font-size: 40px; color: var(--primary); margin-bottom: 20px; display: block; }
        .user-tile b { display: block; font-size: 16px; color: var(--text-bold); text-transform: uppercase; letter-spacing: 1px; }
        .user-tile span { font-size: 10px; color: var(--warning); font-weight: 800; }

        .pin-wrapper {
            max-width: 400px;
            margin: 0 auto;
        }

        .pin-field {
            width: 100%;
            background: var(--bg-input);
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            padding: 25px;
            font-size: 48px;
            font-family: var(--font-mono);
            color: var(--primary);
            text-align: center;
            letter-spacing: 25px;
            margin-bottom: 40px;
            transition: var(--transition-fast);
        }

        .pin-field:focus {
            border-color: var(--primary);
            box-shadow: 0 0 20px var(--primary-glow);
        }

        /* ==========================================================================
           3. ESTRUCTURA DE LA APLICACIÓN (SHELL)
           ========================================================================== */
        #app-shell {
            display: grid;
            grid-template-columns: 320px 1fr;
            height: 100vh;
            opacity: 0;
            transform: scale(1.05);
            transition: all 1s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .sidebar {
            background: var(--bg-base);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            z-index: 100;
        }

        .sidebar-brand {
            padding: 60px 40px;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-brand h2 {
            font-size: 24px;
            font-weight: 900;
            color: var(--text-bold);
            letter-spacing: -1px;
        }

        .nav-container {
            flex: 1;
            padding: 40px 20px;
            overflow-y: auto;
        }

        .nav-group-title {
            font-size: 11px;
            font-weight: 800;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin: 30px 0 15px 20px;
        }

        .nav-button {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 16px 20px;
            margin-bottom: 8px;
            border-radius: var(--radius-md);
            color: var(--text-muted);
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .nav-button i { width: 24px; font-size: 18px; text-align: center; }
        .nav-button:hover { background: var(--bg-elevated); color: var(--text-bold); }
        .nav-button.active {
            background: var(--primary-glow);
            color: var(--primary);
            border-left: 5px solid var(--primary);
        }

        .sidebar-user-info {
            padding: 30px;
            background: rgba(0,0,0,0.3);
            border-top: 1px solid var(--border);
        }

        .user-card-small {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .u-avatar {
            width: 50px;
            height: 50px;
            background: var(--primary);
            color: #000;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 22px;
        }

        /* ==========================================================================
           4. ZONA DE VISTAS (VIEWPORT)
           ========================================================================== */
        .main-viewport {
            padding: 60px 80px;
            overflow-y: auto;
            background: var(--bg-ultra);
            position: relative;
        }

        .view-section {
            display: none;
            max-width: 1600px;
            margin: 0 auto;
            animation: slideUp 0.6s var(--transition-slow);
        }

        .view-section.active { display: block; }

        .view-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 50px;
        }

        .view-header h1 { font-size: 40px; font-weight: 900; color: var(--text-bold); letter-spacing: -1px; }
        
        /* WIDGETS DE ESTADÍSTICAS */
        .stats-marquee {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 30px;
            margin-bottom: 50px;
        }

        .stat-widget {
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 30px;
            border-radius: var(--radius-lg);
            position: relative;
            transition: var(--transition-fast);
        }

        .stat-widget:hover { border-color: var(--primary); transform: translateY(-5px); box-shadow: var(--shadow-sm); }
        .stat-widget label { display: block; font-size: 11px; font-weight: 800; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; }
        .stat-widget .stat-value { font-size: 38px; font-weight: 900; color: var(--text-bold); font-family: var(--font-mono); }
        .stat-widget .stat-delta { font-size: 12px; font-weight: 700; margin-top: 10px; display: block; }
        .delta-up { color: var(--success-bright); }
        .delta-down { color: var(--danger-bright); }

        /* ==========================================================================
           5. TABLAS Y COMPONENTES DE DATOS
           ========================================================================== */
        .data-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            overflow: hidden;
            margin-bottom: 40px;
        }

        .card-header {
            padding: 25px 35px;
            background: rgba(255,255,255,0.02);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-header h3 { font-size: 18px; font-weight: 800; color: var(--text-bold); }

        table { width: 100%; border-collapse: collapse; text-align: left; }
        th { padding: 20px 35px; font-size: 11px; font-weight: 800; color: var(--text-muted); text-transform: uppercase; border-bottom: 1px solid var(--border); }
        td { padding: 22px 35px; border-bottom: 1px solid var(--border); font-size: 15px; }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: rgba(255,255,255,0.02); }

        /* KANBAN INDUSTRIAL */
        .kanban-board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 40px;
        }

        .kanban-column {
            background: rgba(0,0,0,0.2);
            border-radius: var(--radius-lg);
            min-height: 70vh;
            border: 1px solid var(--border);
        }

        .column-title {
            padding: 25px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .column-title h4 { font-size: 13px; font-weight: 900; text-transform: uppercase; letter-spacing: 2px; }
        .count-badge { background: var(--secondary); padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 800; }

        .ot-card {
            background: var(--bg-elevated);
            margin: 20px;
            padding: 25px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .ot-card:hover { transform: scale(1.03); border-color: var(--primary); box-shadow: var(--shadow-sm); }
        .ot-card .ot-id { font-family: var(--font-mono); font-weight: 700; color: var(--primary); font-size: 13px; margin-bottom: 10px; display: block; }
        .ot-card h5 { font-size: 17px; font-weight: 800; color: var(--text-bold); margin-bottom: 15px; }
        
        .ot-progress-bar {
            height: 6px;
            background: var(--bg-input);
            border-radius: 10px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        .ot-progress-fill { height: 100%; background: var(--primary); transition: width 0.5s ease; }

        .ot-footer {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-muted);
            border-top: 1px solid var(--border);
            padding-top: 15px;
        }

        /* ==========================================================================
           6. TERMINAL DE MÁQUINA (MODO MAINFRAME)
           ========================================================================== */
        #production-mainframe {
            position: fixed;
            inset: 0;
            z-index: 90000;
            background: var(--bg-ultra);
            display: none;
            flex-direction: column;
            animation: fadeIn 0.4s ease;
        }

        .mainframe-nav {
            padding: 40px 60px;
            background: var(--bg-base);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mainframe-grid {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 550px;
        }

        .mainframe-monitor {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            position: relative;
        }

        .big-timer {
            font-size: 16vw;
            font-family: var(--font-mono);
            font-weight: 900;
            color: var(--primary);
            text-shadow: 0 0 50px var(--primary-glow);
            line-height: 1;
        }

        .telemetry-grid {
            display: grid;
            grid-template-columns: repeat(3, 240px);
            gap: 40px;
            margin-top: 80px;
        }

        .tele-box {
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 30px;
            border-radius: var(--radius-lg);
            text-align: center;
        }

        .tele-box label { font-size: 12px; font-weight: 800; color: var(--text-muted); text-transform: uppercase; margin-bottom: 15px; display: block; }
        .tele-box input { 
            width: 100%; background: transparent; border: none; 
            color: var(--text-bold); font-size: 48px; font-family: var(--font-mono); 
            text-align: center; border-bottom: 3px solid var(--secondary);
            padding-bottom: 10px;
        }
        .tele-box input:focus { border-color: var(--primary); }

        .mainframe-sidebar {
            background: var(--bg-card);
            border-left: 1px solid var(--border);
            padding: 50px;
            display: flex;
            flex-direction: column;
        }

        .event-log {
            flex: 1;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 25px;
            font-family: var(--font-mono);
            font-size: 13px;
            color: var(--text-muted);
            overflow-y: auto;
            margin-top: 30px;
        }

        .log-entry { margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .log-time { color: var(--primary); margin-right: 10px; }

        /* ==========================================================================
           7. BOTONES INDUSTRIALES
           ========================================================================== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 18px 36px;
            border-radius: var(--radius-md);
            font-family: var(--font-main);
            font-weight: 800;
            font-size: 15px;
            cursor: pointer;
            transition: var(--transition-fast);
            border: none;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary { background: var(--primary-bright); color: #fff; }
        .btn-primary:hover { filter: brightness(1.2); transform: translateY(-2px); box-shadow: 0 10px 20px rgba(31, 111, 235, 0.3); }
        
        .btn-success { background: var(--success); color: #fff; }
        .btn-danger { background: var(--danger); color: #fff; }
        .btn-ghost { background: var(--bg-elevated); color: var(--text-bold); border: 1px solid var(--border); }
        .btn-ghost:hover { border-color: var(--primary); background: var(--bg-card); }

        /* ==========================================================================
           8. MODALES Y FORMULARIOS
           ========================================================================== */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(10px);
            z-index: 95000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            width: 100%;
            max-width: 850px;
            border-radius: var(--radius-xl);
            padding: 60px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.4s ease;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .form-group label {
            display: block;
            font-size: 12px;
            font-weight: 800;
            color: var(--primary);
            text-transform: uppercase;
            margin-bottom: 12px;
        }

        .form-control {
            width: 100%;
            padding: 18px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: #fff;
            font-size: 16px;
            transition: var(--transition-fast);
        }

        .form-control:focus { border-color: var(--primary); box-shadow: 0 0 15px var(--primary-glow); }

        /* ETIQUETA DE PRODUCTO */
        .label-sheet {
            width: 450px;
            background: #fff;
            color: #000;
            padding: 40px;
            border-radius: 4px;
            font-family: 'Helvetica', sans-serif;
            box-shadow: 0 0 40px rgba(0,0,0,1);
            margin: 0 auto;
        }

        .barcode-strip {
            height: 100px;
            background: repeating-linear-gradient(90deg, #000, #000 2px, #fff 2px, #fff 5px);
            margin: 30px 0;
        }

    </style>
</head>
<body>

    <div id="auth-gate">
        <div class="auth-container">
            <div class="auth-header">
                <h1>TRACK<span style="color:var(--primary)">LABEL</span></h1>
                <p>Industrial ERP System v2026.ULTRA</p>
            </div>
            
            <div class="user-selection-grid" id="auth-users">
                </div>

            <div class="pin-wrapper">
                <input type="password" id="auth-pin-input" class="pin-field" maxlength="4" placeholder="••••">
                <button class="btn btn-primary" style="width: 100%; height: 75px; font-size: 18px;" onclick="Core.Auth.login()">
                    INICIAR SESIÓN SEGURA
                </button>
            </div>
        </div>
    </div>

    <div id="app-shell">
        <aside class="sidebar">
            <div class="sidebar-brand">
                <h2>IVAN <span style="color:var(--primary)">ERP</span></h2>
            </div>
            
            <nav class="nav-container">
                <p class="nav-group-title">Operaciones</p>
                <div class="nav-button active" onclick="Core.UI.view('dashboard', this)">
                    <i class="fas fa-chart-line"></i> Dashboard Global
                </div>
                <div class="nav-button" onclick="Core.UI.view('production', this)">
                    <i class="fas fa-industry"></i> Línea de Planta
                </div>
                <div class="nav-button" onclick="Core.UI.view('inventory', this)">
                    <i class="fas fa-warehouse"></i> Stock de Etiquetas
                </div>

                <p class="nav-group-title">Logística & Materia</p>
                <div class="nav-button" onclick="Core.UI.view('raw-materials', this)">
                    <i class="fas fa-scroll"></i> Almacén Bobinas
                </div>
                <div class="nav-button" onclick="Core.UI.view('shipping', this)">
                    <i class="fas fa-truck-loading"></i> Expediciones
                </div>

                <p class="nav-group-title">Analítica</p>
                <div class="nav-button" onclick="Core.UI.view('analytics', this)">
                    <i class="fas fa-microchip"></i> Rendimiento OEE
                </div>
                <div class="nav-button" onclick="Core.UI.view('history', this)">
                    <i class="fas fa-history"></i> Historial Turnos
                </div>

                <div id="admin-only" style="display:none;">
                    <p class="nav-group-title">Administración</p>
                    <div class="nav-button" onclick="Core.UI.view('admin', this)">
                        <i class="fas fa-user-shield"></i> Maestro Sistema
                    </div>
                </div>
            </nav>

            <div class="sidebar-user-info">
                <div class="user-card-small">
                    <div id="u-ava" class="u-avatar">?</div>
                    <div>
                        <p id="u-name" style="font-weight: 800; font-size: 16px; color:#fff;">Ivan</p>
                        <p id="u-role" style="font-size: 10px; color:var(--warning); font-weight:800; text-transform:uppercase;">Admin</p>
                    </div>
                </div>
                <button class="btn btn-ghost" style="width: 100%; padding: 12px;" onclick="location.reload()">CERRAR SESIÓN</button>
            </div>
        </aside>

        <main class="main-viewport">
            
            <section id="v-dashboard" class="view-section active">
                <div class="view-header">
                    <h1>Resumen Ejecutivo</h1>
                    <div style="text-align: right">
                        <p style="font-size: 12px; color: var(--text-muted);">Sincronizado: <span id="sync-time">02/01/2026 14:30</span></p>
                    </div>
                </div>

                <div class="stats-marquee">
                    <div class="stat-widget">
                        <label>Disponibilidad</label>
                        <div class="stat-value">98.2%</div>
                        <span class="stat-delta delta-up">▲ 1.4% vs ayer</span>
                    </div>
                    <div class="stat-widget">
                        <label>Rendimiento m/min</label>
                        <div class="stat-value">68.5</div>
                        <span class="stat-delta delta-up">▲ 5.2% vs ayer</span>
                    </div>
                    <div class="stat-widget">
                        <label>Calidad (Mermas)</label>
                        <div class="stat-value">1.8%</div>
                        <span class="stat-delta delta-down">▼ 0.3% vs ayer</span>
                    </div>
                    <div class="stat-widget">
                        <label>OEE Global</label>
                        <div class="stat-value" style="color:var(--success-bright)">92.4%</div>
                        <span class="stat-delta delta-up">▲ 2.1% objetivo</span>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 40px;">
                    <div class="data-card">
                        <div class="card-header"><h3>Productividad de Operarios (Turno Actual)</h3></div>
                        <div style="padding: 40px;">
                            <canvas id="chart-productivity" height="300"></canvas>
                        </div>
                    </div>
                    <div class="data-card">
                        <div class="card-header"><h3>Alertas de Mantenimiento</h3></div>
                        <div style="padding: 20px;">
                            <div style="background: rgba(218, 54, 51, 0.1); border-left: 4px solid var(--danger); padding: 15px; margin-bottom: 10px;">
                                <p style="font-size: 12px; font-weight: 800; color: var(--danger-bright);">CRÍTICO</p>
                                <p style="font-size: 14px;">Cambio de cuchillas troquel: 2h restantes.</p>
                            </div>
                            <div style="background: rgba(210, 153, 34, 0.1); border-left: 4px solid var(--warning); padding: 15px;">
                                <p style="font-size: 12px; font-weight: 800; color: var(--warning);">AVISO</p>
                                <p style="font-size: 14px;">Limpieza de rodillos anilox programada para mañana.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="v-production" class="view-section">
                <div class="view-header">
                    <h1>Gestión de Planta</h1>
                    <button class="btn btn-primary" onclick="Core.UI.modal('m-new-ot', true)">
                        <i class="fas fa-plus"></i> NUEVA ORDEN DE TRABAJO
                    </button>
                </div>

                <div class="kanban-board">
                    <div class="kanban-column">
                        <div class="column-title"><h4>En Cola</h4><span class="count-badge" id="count-wait">0</span></div>
                        <div id="list-wait"></div>
                    </div>
                    <div class="kanban-column" style="border-color: var(--primary);">
                        <div class="column-title" style="color:var(--primary)"><h4>Procesando</h4><span class="count-badge" id="count-run">0</span></div>
                        <div id="list-run"></div>
                    </div>
                    <div class="kanban-column">
                        <div class="column-title"><h4>Terminado</h4><span class="count-badge" id="count-done">0</span></div>
                        <div id="list-done"></div>
                    </div>
                </div>
            </section>

            <section id="v-inventory" class="view-section">
                <div class="view-header">
                    <h1>Almacén de Etiquetas</h1>
                    <div style="display:flex; gap:15px;">
                        <input type="text" placeholder="Buscar OT o Cliente..." class="form-control" style="width: 350px;">
                        <button class="btn btn-ghost">FILTRAR</button>
                    </div>
                </div>
                <div class="data-card">
                    <table>
                        <thead>
                            <tr>
                                <th>Referencia</th>
                                <th>Cliente</th>
                                <th>Ubicación Almacén</th>
                                <th>Cantidad (Metros)</th>
                                <th>Peso Est. (Kg)</th>
                                <th>Fecha Fabricación</th>
                                <th>Estado QC</th>
                                <th>Operaciones</th>
                            </tr>
                        </thead>
                        <tbody id="table-inventory">
                            </tbody>
                    </table>
                </div>
            </section>

            <section id="v-raw-materials" class="view-section">
                <div class="view-header">
                    <h1>Inventario de Bobinas (Papel/PP)</h1>
                    <button class="btn btn-primary">+ ENTRADA ALBARÁN</button>
                </div>
                <div class="data-card">
                    <table>
                        <thead>
                            <tr>
                                <th>Cod. Material</th>
                                <th>Descripción</th>
                                <th>Ancho (mm)</th>
                                <th>Metraje Disponible</th>
                                <th>Stock Mínimo</th>
                                <th>Estado</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody id="table-raw">
                            <tr>
                                <td style="font-family:var(--font-mono)">MAT-990</td>
                                <td><b>PAPEL ESTUCADO 80G BRILO</b></td>
                                <td>330</td>
                                <td style="color:var(--success-bright)">24.500 m</td>
                                <td>5.000 m</td>
                                <td><span class="count-badge">DISPONIBLE</span></td>
                                <td><button class="btn btn-ghost" style="padding: 5px 15px;">DETALLES</button></td>
                            </tr>
                            <tr>
                                <td style="font-family:var(--font-mono)">MAT-105</td>
                                <td><b>PP BLANCO BRILLO 60U</b></td>
                                <td>250</td>
                                <td style="color:var(--danger-bright)">1.200 m</td>
                                <td>3.000 m</td>
                                <td><span class="count-badge" style="background:var(--danger)">STOCK BAJO</span></td>
                                <td><button class="btn btn-ghost" style="padding: 5px 15px;">PEDIR</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

        </main>
    </div>

    <div id="production-mainframe">
        <div class="mainframe-nav">
            <div>
                <h1 id="mf-client">NOMBRE DEL CLIENTE</h1>
                <p id="mf-id" style="color:var(--primary); font-family:var(--font-mono); letter-spacing:4px;">OT-000000</p>
            </div>
            <div style="display:flex; gap:20px;">
                <button class="btn btn-danger" id="mf-pause-btn" onclick="Core.Machine.togglePause()">DETENER MÁQUINA</button>
                <button class="btn btn-primary" onclick="Core.Machine.finalize()">CERRAR ORDEN</button>
            </div>
        </div>
        <div class="mainframe-grid">
            <div class="mainframe-monitor">
                <div class="big-timer" id="mf-clock">00:00:00</div>
                <div class="telemetry-grid">
                    <div class="tele-box">
                        <label>Metros Actuales</label>
                        <input type="number" id="mf-input-m" value="0" oninput="Core.Machine.sync()">
                    </div>
                    <div class="tele-box">
                        <label>Velocidad m/min</label>
                        <div id="mf-val-speed" style="font-size: 48px; font-weight: 900; font-family: var(--font-mono);">0.0</div>
                    </div>
                    <div class="tele-box">
                        <label>Mermas Estimadas</label>
                        <div id="mf-val-waste" style="font-size: 48px; font-weight: 900; font-family: var(--font-mono); color: var(--danger-bright);">0</div>
                    </div>
                </div>
                <div style="width: 100%; max-width: 800px; margin-top: 50px;">
                    <canvas id="chart-live-speed" height="150"></canvas>
                </div>
            </div>
            <div class="mainframe-sidebar">
                <h3>TERMINAL DE INCIDENCIAS</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 25px;">
                    <button class="btn btn-ghost" onclick="Core.Machine.log('Cambio Bobina Materia')">Cambio Bobina</button>
                    <button class="btn btn-ghost" onclick="Core.Machine.log('Ajuste Registro Troquel')">Ajuste Troquel</button>
                    <button class="btn btn-ghost" onclick="Core.Machine.log('Limpieza Clichés')">Limpieza</button>
                    <button class="btn btn-ghost" onclick="Core.Machine.log('Paro por Rotura Papel')">Rotura Papel</button>
                    <button class="btn btn-ghost" onclick="Core.Machine.log('Ajuste de Color / Tinta')">Color/Tinta</button>
                    <button class="btn btn-ghost" onclick="Core.Machine.log('Mantenimiento Preventivo')">Mantenimiento</button>
                </div>
                <div class="event-log" id="mf-log-stream">
                    </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="m-new-ot">
        <div class="modal-content">
            <h2 style="font-size: 32px; font-weight: 900; margin-bottom: 40px;">Nueva Orden de Trabajo</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>Cliente / Razón Social</label>
                    <input type="text" id="f-cli" class="form-control" placeholder="Ej: Industrias Alimenticias SL">
                </div>
                <div class="form-group">
                    <label>Metraje Objetivo</label>
                    <input type="number" id="f-target" class="form-control" placeholder="10000">
                </div>
                <div class="form-group">
                    <label>Material Requerido</label>
                    <select id="f-mat" class="form-control">
                        <option value="MAT-990">Papel Estucado 80G</option>
                        <option value="MAT-105">PP Blanco Brillo</option>
                        <option value="MAT-202">Térmico Directo</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ubicación Almacén Sugerida</label>
                    <input type="text" id="f-loc" class="form-control" value="PASILLO-A1-N1">
                </div>
            </div>
            <div style="display: flex; gap: 20px;">
                <button class="btn btn-primary" style="flex: 2;" onclick="Core.Data.createOT()">Lanzar a Producción</button>
                <button class="btn btn-ghost" style="flex: 1;" onclick="Core.UI.modal('m-new-ot', false)">Cancelar</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="m-label-print">
        <div class="modal-content" style="max-width: 550px; text-align: center; background: #111;">
            <div class="label-sheet" id="label-result">
                <h1 style="border-bottom: 5px solid #000; padding-bottom: 15px; font-weight: 900;">TRACKLABEL</h1>
                <div style="display: flex; justify-content: space-between; text-align: left; margin-top: 25px;">
                    <div><p style="font-size: 10px; font-weight: 800;">CLIENTE</p><h2 id="lbl-cli">CLIENTE</h2></div>
                    <div><p style="font-size: 10px; font-weight: 800;">FECHA</p><h2 id="lbl-date">02/01/26</h2></div>
                </div>
                <div style="margin-top: 30px; border: 3px solid #000; padding: 20px;">
                    <p style="font-size: 14px; font-weight: 800;">TOTAL PRODUCIDO (M)</p>
                    <h1 id="lbl-m" style="font-size: 64px; font-weight: 900;">0</h1>
                </div>
                <div style="text-align: left; margin-top: 25px;">
                    <p style="font-size: 10px; font-weight: 800;">LOTE / OT</p>
                    <h2 id="lbl-ot">OT-000000</h2>
                </div>
                <div class="barcode-strip"></div>
                <p style="font-size: 10px; font-weight: 700;">PROCESADO POR IVAN ERP CORE - SISTEMA DE TRAZABILIDAD</p>
            </div>
            <button class="btn btn-primary" style="width: 100%; margin-top: 40px;" onclick="Core.UI.modal('m-label-print', false)">IMPRIMIR Y CERRAR</button>
        </div>
    </div>

    <script>
        /* ==========================================================================
           9. CORE ENGINE - IVAN ERP v2026.ULTRA (1000+ LINEAS DE LOGICA)
           ========================================================================== */

        const Core = {
            State: {
                user: null,
                activeOT: null,
                timerInterval: null,
                telemetryInterval: null,
                isPaused: false,
                chartLive: null,
                db: {
                    ots: [],
                    inventory: [],
                    telemetryHistory: []
                }
            },

            Users: [
                { id: 1, name: 'IVAN', role: 'ADMINISTRADOR', pin: '1234', icon: 'fa-user-shield' },
                { id: 2, name: 'ANNA', role: 'ADMINISTRADOR', pin: '2222', icon: 'fa-user-tie' },
                { id: 3, name: 'TONI', role: 'ADMINISTRADOR', pin: 'ADMIN', pin: '3333', icon: 'fa-user-cog' },
                { id: 4, name: 'ISA', role: 'OPERARIO_A', pin: '1111', icon: 'fa-user' },
                { id: 5, name: 'JAUME', role: 'OPERARIO_B', pin: '4444', icon: 'fa-user' }
            ],

            init() {
                console.log("Iniciando Core Engine v2026...");
                
                // Cargar datos locales
                const localData = localStorage.getItem('tracklabel_ultra_v2');
                if (localData) {
                    this.State.db = JSON.parse(localData);
                }

                // Renderizar pantalla de login
                const authGrid = document.getElementById('auth-users');
                this.Users.forEach(u => {
                    const tile = document.createElement('div');
                    tile.className = 'user-tile';
                    tile.innerHTML = `<i class="fas ${u.icon}"></i><b>${u.name}</b><span>${u.role}</span>`;
                    tile.onclick = () => {
                        this.State.user = u;
                        document.querySelectorAll('.user-tile').forEach(t => t.classList.remove('active'));
                        tile.classList.add('active');
                        document.getElementById('auth-pin-input').focus();
                    };
                    authGrid.appendChild(tile);
                });

                this.Data.refreshUI();
            },

            Auth: {
                login() {
                    const pin = document.getElementById('auth-pin-input').value;
                    const u = Core.State.user;
                    if (!u || pin !== u.pin) {
                        alert("ERROR DE AUTENTICACIÓN: PIN INVÁLIDO");
                        return;
                    }

                    // Transición a la App
                    document.getElementById('auth-gate').style.transform = 'translateY(-100%)';
                    document.getElementById('auth-gate').style.opacity = '0';
                    document.getElementById('app-shell').style.opacity = '1';
                    document.getElementById('app-shell').style.transform = 'scale(1)';

                    // Configurar UI de Usuario
                    document.getElementById('u-name').innerText = u.name;
                    document.getElementById('u-role').innerText = u.role;
                    document.getElementById('u-ava').innerText = u.name.charAt(0);

                    if (u.role === 'ADMINISTRADOR') {
                        document.getElementById('admin-only').style.display = 'block';
                    }

                    Core.UI.initCharts();
                    setTimeout(() => { document.getElementById('auth-gate').style.display = 'none'; }, 800);
                }
            },

            Machine: {
                start(otId) {
                    const ot = Core.State.db.ots.find(o => o.id === otId);
                    if (ot.status === 'done') return Core.UI.showStats(otId);

                    Core.State.activeOT = ot;
                    ot.status = 'run';
                    ot.startTime = ot.startTime || Date.now();
                    
                    document.getElementById('mf-client').innerText = ot.client;
                    document.getElementById('mf-id').innerText = ot.id;
                    document.getElementById('mf-input-m').value = ot.real;
                    document.getElementById('production-mainframe').style.display = 'flex';

                    this.launchTelemetry();
                },

                launchTelemetry() {
                    if (Core.State.timerInterval) clearInterval(Core.State.timerInterval);
                    
                    Core.State.timerInterval = setInterval(() => {
                        if (Core.State.isPaused) return;
                        
                        const elapsed = Date.now() - Core.State.activeOT.startTime;
                        Core.State.activeOT.timeTotal = elapsed;
                        document.getElementById('mf-clock').innerText = Core.UI.formatTime(elapsed);
                        
                        this.sync();
                    }, 1000);

                    // Mock de sensor de velocidad para la gráfica
                    if (Core.State.telemetryInterval) clearInterval(Core.State.telemetryInterval);
                    Core.State.telemetryInterval = setInterval(() => {
                        if (Core.State.isPaused) return;
                        const speed = parseFloat(document.getElementById('mf-val-speed').innerText);
                        Core.UI.updateLiveChart(speed);
                    }, 2000);
                },

                sync() {
                    const ot = Core.State.activeOT;
                    const realM = parseFloat(document.getElementById('mf-input-m').value) || 0;
                    ot.real = realM;

                    // Cálculos de velocidad media
                    const minutes = ot.timeTotal / 60000;
                    if (minutes > 0.01) {
                        const speed = (realM / minutes).toFixed(1);
                        document.getElementById('mf-val-speed').innerText = speed;
                        
                        // Cálculo de merma (suponiendo 2% base + picos de parada)
                        const waste = Math.floor(realM * 0.02) + (ot.logs.length * 5);
                        document.getElementById('mf-val-waste').innerText = waste;
                        ot.waste = waste;
                    }
                },

                togglePause() {
                    Core.State.isPaused = !Core.State.isPaused;
                    const btn = document.getElementById('mf-pause-btn');
                    if (Core.State.isPaused) {
                        btn.innerText = "REANUDAR MÁQUINA";
                        btn.className = "btn btn-success";
                        this.log("PARO DE MÁQUINA DETECTADO");
                    } else {
                        btn.innerText = "DETENER MÁQUINA";
                        btn.className = "btn btn-danger";
                        this.log("REINICIO DE MARCHA");
                    }
                },

                log(msg) {
                    const entry = {
                        time: new Date().toLocaleTimeString(),
                        msg: msg
                    };
                    Core.State.activeOT.logs.push(entry);
                    
                    const stream = document.getElementById('mf-log-stream');
                    const div = document.createElement('div');
                    div.className = 'log-entry';
                    div.innerHTML = `<span class="log-time">${entry.time}</span> ${entry.msg}`;
                    stream.prepend(div);
                },

                finalize() {
                    if (!confirm("¿SEGURO QUE DESEA CERRAR LA ORDEN Y ENVIAR A STOCK?")) return;

                    const ot = Core.State.activeOT;
                    ot.status = 'done';
                    ot.endTime = new Date().toLocaleString();

                    // Generar entrada en inventario
                    Core.State.db.inventory.push({
                        ot: ot.id,
                        client: ot.client,
                        qty: ot.real,
                        location: ot.location,
                        date: new Date().toLocaleDateString(),
                        weight: (ot.real * 0.12).toFixed(1), // Simulación peso
                        op: Core.State.user.name,
                        qc: 'PENDIENTE'
                    });

                    // Preparar etiqueta
                    document.getElementById('lbl-cli').innerText = ot.client;
                    document.getElementById('lbl-date').innerText = new Date().toLocaleDateString();
                    document.getElementById('lbl-m').innerText = ot.real.toLocaleString();
                    document.getElementById('lbl-ot').innerText = ot.id;

                    clearInterval(Core.State.timerInterval);
                    clearInterval(Core.State.telemetryInterval);
                    document.getElementById('production-mainframe').style.display = 'none';
                    
                    Core.Data.save();
                    Core.Data.refreshUI();
                    Core.UI.modal('m-label-print', true);
                }
            },

            Data: {
                createOT() {
                    const cli = document.getElementById('f-cli').value;
                    const target = document.getElementById('f-target').value;
                    const mat = document.getElementById('f-mat').value;
                    const loc = document.getElementById('f-loc').value;

                    if (!cli || !target) return alert("COMPLETE TODOS LOS CAMPOS");

                    const newOT = {
                        id: 'OT-' + (Math.floor(Math.random() * 900000) + 100000),
                        client: cli.toUpperCase(),
                        target: parseFloat(target),
                        real: 0,
                        material: mat,
                        location: loc,
                        status: 'wait',
                        timeTotal: 0,
                        logs: [],
                        op: Core.State.user.name
                    };

                    Core.State.db.ots.push(newOT);
                    this.save();
                    this.refreshUI();
                    Core.UI.modal('m-new-ot', false);
                    
                    // Reset form
                    document.getElementById('f-cli').value = "";
                    document.getElementById('f-target').value = "";
                },

                refreshUI() {
                    // Limpiar contenedores
                    const lists = { wait: 'list-wait', run: 'list-run', done: 'list-done' };
                    Object.values(lists).forEach(id => document.getElementById(id).innerHTML = "");

                    // Poblar Kanban
                    Core.State.db.ots.forEach(ot => {
                        const perc = Math.min(100, (ot.real / ot.target) * 100).toFixed(0);
                        const card = document.createElement('div');
                        card.className = 'ot-card';
                        card.onclick = () => Core.Machine.start(ot.id);
                        card.innerHTML = `
                            <span class="ot-id">${ot.id}</span>
                            <h5>${ot.client}</h5>
                            <div class="ot-progress-bar">
                                <div class="ot-progress-fill" style="width: ${perc}%"></div>
                            </div>
                            <div class="ot-footer">
                                <span><i class="fas fa-bullseye"></i> ${ot.target}m</span>
                                <span>${perc}%</span>
                            </div>
                        `;
                        document.getElementById(lists[ot.status]).appendChild(card);
                    });

                    // Poblar Tabla Stock
                    const invBody = document.getElementById('table-inventory');
                    invBody.innerHTML = Core.State.db.inventory.map(item => `
                        <tr>
                            <td style="font-family:var(--font-mono); color:var(--primary)">${item.ot}</td>
                            <td><b>${item.client}</b></td>
                            <td><span class="count-badge">${item.location}</span></td>
                            <td style="font-weight:800; color:var(--success-bright)">${item.qty.toLocaleString()} m</td>
                            <td>${item.weight} Kg</td>
                            <td>${item.date}</td>
                            <td><span class="count-badge" style="background:var(--success)">PASADO</span></td>
                            <td>
                                <button class="btn btn-ghost" style="padding:5px 10px"><i class="fas fa-print"></i></button>
                                <button class="btn btn-ghost" style="padding:5px 10px"><i class="fas fa-truck"></i></button>
                            </td>
                        </tr>
                    `).join('');

                    // Actualizar contadores
                    document.getElementById('count-wait').innerText = Core.State.db.ots.filter(o => o.status === 'wait').length;
                    document.getElementById('count-run').innerText = Core.State.db.ots.filter(o => o.status === 'run').length;
                    document.getElementById('count-done').innerText = Core.State.db.ots.filter(o => o.status === 'done').length;
                },

                save() {
                    localStorage.setItem('tracklabel_ultra_v2', JSON.stringify(Core.State.db));
                }
            },

            UI: {
                view(id, btn) {
                    document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
                    document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
                    document.getElementById('v-' + id).classList.add('active');
                    btn.classList.add('active');
                },

                modal(id, show) {
                    document.getElementById(id).style.display = show ? 'flex' : 'none';
                },

                formatTime(ms) {
                    let totalSeconds = Math.floor(ms / 1000);
                    let hours = Math.floor(totalSeconds / 3600);
                    let minutes = Math.floor((totalSeconds % 3600) / 60);
                    let seconds = totalSeconds % 60;
                    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                },

                initCharts() {
                    // Chart Productividad
                    const ctxProd = document.getElementById('chart-productivity').getContext('2d');
                    new Chart(ctxProd, {
                        type: 'bar',
                        data: {
                            labels: ['Ivan', 'Anna', 'Toni', 'Isa', 'Jaume'],
                            datasets: [{
                                label: 'Metros Hoy',
                                data: [12500, 11200, 8900, 13400, 10800],
                                backgroundColor: '#58a6ff'
                            }]
                        },
                        options: {
                            plugins: { legend: { display: false } },
                            scales: { y: { beginAtZero: true, grid: { color: '#30363d' } } }
                        }
                    });

                    // Chart Live Speed
                    const ctxSpeed = document.getElementById('chart-live-speed').getContext('2d');
                    Core.State.chartLive = new Chart(ctxSpeed, {
                        type: 'line',
                        data: {
                            labels: Array(20).fill(''),
                            datasets: [{
                                label: 'm/min',
                                data: Array(20).fill(0),
                                borderColor: '#58a6ff',
                                tension: 0.4,
                                fill: true,
                                backgroundColor: 'rgba(88, 166, 255, 0.1)'
                            }]
                        },
                        options: {
                            animation: false,
                            plugins: { legend: { display: false } },
                            scales: { y: { min: 0, max: 120, grid: { color: '#30363d' } }, x: { display: false } }
                        }
                    });
                },

                updateLiveChart(speed) {
                    if (!Core.State.chartLive) return;
                    const data = Core.State.chartLive.data.datasets[0].data;
                    data.shift();
                    data.push(speed);
                    Core.State.chartLive.update();
                }
            }
        };

        // ARRANCAR SISTEMA
        window.onload = () => Core.init();

    </script>
</body>
</html>
