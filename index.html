<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Track Label Pro | M√≥vil & PC</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --bg: #0b0e14; --card: #1a1d26; --sidebar: #11141d;
            --orange: #ff7a00; --green: #00e676; --red: #ff5252;
            --text: #ffffff; --text-dim: #8a8f9d; --border: #2d313d;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            background: var(--bg); color: var(--text); font-family: -apple-system, Segoe UI, Roboto, sans-serif; 
            margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden;
        }

        /* --- LOGIN & BLOQUEO --- */
        .overlay { position: fixed; inset: 0; background: var(--bg); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .login-box { background: var(--card); padding: 30px; border-radius: 20px; width: 100%; max-width: 400px; text-align: center; border: 1px solid var(--border); }
        .user-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 20px 0; }
        .user-item { background: var(--bg); padding: 10px; border-radius: 12px; border: 2px solid transparent; font-size: 12px; cursor: pointer; }
        .user-item.selected { border-color: var(--orange); background: rgba(255,122,0,0.1); }

        /* --- LAYOUT RESPONSIVE --- */
        .header { background: var(--sidebar); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); flex-shrink: 0; }
        .container { display: flex; flex: 1; overflow: hidden; flex-direction: row; }
        
        /* Sidebar en PC, oculta en m√≥vil o adaptada */
        .sidebar { width: 250px; background: var(--sidebar); padding: 20px; display: flex; flex-direction: column; border-right: 1px solid var(--border); }
        .main-content { flex: 1; overflow-y: auto; padding: 15px; }

        /* --- KANBAN ADAPTADO --- */
        .kanban { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
        .column { background: rgba(255,255,255,0.03); border-radius: 15px; padding: 15px; min-height: 200px; border: 1px solid var(--border); }
        .col-title { font-size: 11px; font-weight: 800; color: var(--text-dim); text-transform: uppercase; margin-bottom: 15px; display: flex; justify-content: space-between; }

        /* --- TARJETAS --- */
        .job-card { 
            background: var(--card); border-radius: 12px; padding: 16px; margin-bottom: 12px; 
            border-left: 5px solid var(--orange); box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            cursor: pointer; position: relative;
        }
        .job-card h4 { margin: 0; font-size: 16px; }
        .job-card p { margin: 5px 0 0; font-size: 13px; color: var(--text-dim); }

        /* --- MODALES OPTIMIZADOS M√ìVIL --- */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9000; padding: 10px; overflow-y: auto; }
        .modal-content { 
            background: var(--card); border-radius: 20px; padding: 25px; 
            width: 100%; max-width: 500px; margin: 10px auto; border: 1px solid var(--border);
        }

        /* --- FORMULARIOS --- */
        .f-group { margin-bottom: 15px; }
        label { display: block; font-size: 11px; color: var(--text-dim); margin-bottom: 5px; font-weight: bold; }
        input, select { 
            width: 100%; padding: 12px; background: var(--bg); border: 1px solid var(--border); 
            border-radius: 10px; color: #fff; font-size: 16px; /* 16px evita zoom autom√°tico en iPhone */
        }
        .btn { 
            width: 100%; padding: 15px; border-radius: 12px; border: none; font-weight: bold; 
            font-size: 15px; cursor: pointer; transition: 0.2s;
        }
        .btn-orange { background: var(--orange); color: #fff; }
        .btn-green { background: var(--green); color: #000; }
        .btn-ghost { background: transparent; color: var(--text-dim); }

        /* --- TIEMPOS --- */
        .t-row { 
            background: var(--bg); padding: 15px; border-radius: 15px; margin-bottom: 10px;
            display: grid; grid-template-columns: 80px 1fr 80px; gap: 10px; align-items: center;
        }
        .t-val { font-family: monospace; font-size: 14px; text-align: center; color: var(--orange); }
        .btn-s { padding: 10px; border-radius: 8px; border: none; font-size: 10px; font-weight: bold; }

        /* AJUSTES M√ìVIL */
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .kanban { grid-template-columns: 1fr; }
            .header h2 { font-size: 16px; }
        }
    </style>
</head>
<body>

<div id="master-lock" class="overlay">
    <div class="login-box">
        <h2 style="color:var(--orange)">TRACK LABEL PRO</h2>
        <input type="password" id="m-pass" placeholder="Contrase√±a Maestra" style="text-align:center;">
        <button class="btn btn-orange" style="margin-top:20px" onclick="checkM()">ENTRAR</button>
    </div>
</div>

<div id="login-screen" class="overlay" style="display:none">
    <div class="login-box">
        <h3>OPERARIO</h3>
        <div class="user-grid">
            <div class="user-item" onclick="selU('Isa', this)">Isa</div>
            <div class="user-item" onclick="selU('Jaume', this)">Jaume</div>
            <div class="user-item" onclick="selU('Ivan', this)">Ivan</div>
            <div class="user-item" onclick="selU('Anna', this)">Anna</div>
            <div class="user-item" onclick="selU('Toni', this)">Toni</div>
        </div>
        <input type="password" id="u-pin" placeholder="PIN" style="text-align:center;">
        <button class="btn btn-orange" style="margin-top:20px" onclick="login()">ACCEDER</button>
    </div>
</div>

<header class="header">
    <h2 style="margin:0; color:var(--orange)">üü† TRACK LABEL</h2>
    <div id="user-display" style="font-size:12px; font-weight:bold"></div>
</header>

<div class="container">
    <aside class="sidebar">
        <button class="btn btn-orange" onclick="openM('modalPedido')">+ NUEVO PEDIDO</button>
        <div style="margin-top:20px; font-size:12px; color:var(--text-dim)">
            Utiliza este panel para gestionar las colas de impresi√≥n y acabados.
        </div>
        <button class="btn btn-ghost" style="margin-top:auto" onclick="location.reload()">Salir</button>
    </aside>

    <main class="main-content">
        <button class="btn btn-orange" id="btn-movil-add" style="margin-bottom:15px; display:none" onclick="openM('modalPedido')">+ NUEVO PEDIDO</button>
        
        <div class="kanban">
            <div class="column">
                <div class="col-title">FLEXO / OFFSET <span id="c-flexo">0</span></div>
                <div id="list-flexo" style="min-height:50px"></div>
            </div>
            <div class="column">
                <div class="col-title">DIGITAL <span id="c-digital">0</span></div>
                <div id="list-digital" style="min-height:50px"></div>
            </div>
            <div class="column">
                <div class="col-title">REPASO / ACABADO <span id="c-acabados">0</span></div>
                <div id="list-acabados" style="min-height:50px"></div>
            </div>
        </div>
    </main>
</div>

<div id="modalPedido" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0">Nuevo Pedido</h3>
        <div class="f-group"><label>CLIENTE</label><input type="text" id="in-cli"></div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
            <div class="f-group"><label>COLOR</label><input type="color" id="in-col" value="#ff7a00" style="height:45px"></div>
            <div class="f-group"><label>M√ÅQUINA</label>
                <select id="in-maq">
                    <option value="list-flexo">Flexo</option>
                    <option value="list-digital">Digital</option>
                </select>
            </div>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
            <div class="f-group"><label>METROS</label><input type="number" id="in-met"></div>
            <div class="f-group"><label>TROQUEL</label><input type="text" id="in-tro"></div>
        </div>
        <div class="f-group"><label>MATERIAL</label>
            <select id="in-mat" onchange="updEst()">
                <option value="">Seleccionar...</option>
                <option value="Couch√©">Couch√©</option>
                <option value="PP Mate">PP Mate</option>
                <option value="PP Brillo">PP Brillo</option>
                <option value="PE">PE</option>
            </select>
        </div>
        <div class="f-group"><label>ESTANTER√çA</label><input type="text" id="in-est" readonly></div>
        <button class="btn btn-orange" onclick="crearP()">CREAR PEDIDO</button>
        <button class="btn btn-ghost" onclick="closeM('modalPedido')">Cerrar</button>
    </div>
</div>

<div id="modalTiempos" class="modal">
    <div class="modal-content">
        <h3 id="v-cli" style="margin:0"></h3>
        <p id="v-det" style="font-size:12px; color:var(--orange); margin-bottom:20px"></p>

        <div class="t-row">
            <button class="btn-s" style="background:var(--green)" onclick="stmp('prep','inicio')">INI</button>
            <div class="t-val" id="v-prep">--:-- > --:--</div>
            <button class="btn-s" style="background:var(--red); color:#fff" onclick="stmp('prep','fin')">FIN</button>
        </div>
        <div class="t-row">
            <button class="btn-s" style="background:var(--green)" onclick="stmp('tiraje','inicio')">INI</button>
            <div class="t-val" id="v-tiraje">--:-- > --:--</div>
            <button class="btn-s" style="background:var(--red); color:#fff" onclick="stmp('tiraje','fin')">FIN</button>
        </div>
        <div id="v-box-rep" class="t-row" style="display:none">
            <button class="btn-s" style="background:var(--green)" onclick="stmp('repaso','inicio')">INI</button>
            <div class="t-val" id="v-repaso">--:-- > --:--</div>
            <button class="btn-s" style="background:var(--red); color:#fff" onclick="stmp('repaso','fin')">FIN</button>
        </div>

        <button id="btn-exp" class="btn btn-green" style="display:none; margin-bottom:10px" onclick="exp()">FINALIZAR Y EXPEDIR</button>
        <button class="btn btn-ghost" onclick="closeM('modalTiempos')">Volver</button>
    </div>
</div>

<script>
const M_KEY = "TrackLabel#";
const USR = {"Isa":"1234", "Jaume":"1234", "Ivan":"1234", "Anna":"1234", "Toni":"1234"};
const MATS = {"Couch√©":"A1", "PP Mate":"B2", "PP Brillo":"B3", "PE":"C1"};

let db = JSON.parse(localStorage.getItem('track_db_v3')) || {};
let uAct = "";
let idAct = null;

function checkM(){ if(document.getElementById('m-pass').value===M_KEY){ document.getElementById('master-lock').style.display='none'; document.getElementById('login-screen').style.display='flex'; } }
function selU(n, el){ uAct=n; document.querySelectorAll('.user-item').forEach(i=>i.classList.remove('selected')); el.classList.add('selected'); }
function login(){ if(USR[uAct]===document.getElementById('u-pin').value){ document.getElementById('login-screen').style.display='none'; document.getElementById('user-display').innerText=uAct; if(window.innerWidth<768) document.getElementById('btn-movil-add').style.display='block'; render(); initS(); } }

function updEst(){ document.getElementById('in-est').value = MATS[document.getElementById('in-mat').value] || ""; }
function openM(id){ document.getElementById(id).style.display='block'; }
function closeM(id){ document.getElementById(id).style.display='none'; }

function crearP(){
    const cli = document.getElementById('in-cli').value;
    if(!cli) return;
    const id = "ID-"+Date.now();
    db[id] = {
        cliente: cli, color: document.getElementById('in-col').value,
        maquina: document.getElementById('in-maq').value, metros: document.getElementById('in-met').value,
        troquel: document.getElementById('in-tro').value, material: document.getElementById('in-mat').value,
        estanteria: document.getElementById('in-est').value, tiempos: {prep:{}, tiraje:{}, repaso:{}}
    };
    save(); render(); closeM('modalPedido');
}

function render(){
    ['flexo', 'digital', 'acabados'].forEach(c=>{
        const box = document.getElementById('list-'+c);
        box.innerHTML = "";
        Object.keys(db).filter(k=>db[k].maquina==='list-'+c).forEach(id=>{
            const p = db[id];
            const div = document.createElement('div');
            div.className = 'job-card';
            div.style.borderLeftColor = p.color;
            div.onclick = () => abrirT(id); // Evento click directo
            div.innerHTML = `<h4>${p.cliente}</h4><p>${p.metros}m | Troquel: ${p.troquel}</p>`;
            box.appendChild(div);
        });
        document.getElementById('c-'+c).innerText = box.children.length;
    });
}

function abrirT(id){
    idAct = id;
    const p = db[id];
    document.getElementById('v-cli').innerText = p.cliente.toUpperCase();
    document.getElementById('v-det').innerText = `${p.metros}m - T:${p.troquel} - Mat:${p.material}`;
    
    refreshT(p);
    const esAcab = p.maquina === 'list-acabados';
    document.getElementById('v-box-rep').style.display = esAcab ? 'grid' : 'none';
    document.getElementById('btn-exp').style.display = esAcab ? 'block' : 'none';
    openM('modalTiempos');
}

function stmp(f, h){
    const now = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    db[idAct].tiempos[f][h] = now;
    if(f==='tiraje' && h==='fin'){ db[idAct].maquina = 'list-acabados'; render(); closeM('modalTiempos'); abrirT(idAct); }
    save(); refreshT(db[idAct]);
}

function refreshT(p){
    ['prep', 'tiraje', 'repaso'].forEach(f=>{
        document.getElementById('v-'+f).innerText = `${p.tiempos[f].inicio || '--'} > ${p.tiempos[f].fin || '--'}`;
    });
}

function exp(){ if(confirm("¬øExpedir pedido?")){ delete db[idAct]; save(); render(); closeM('modalTiempos'); } }
function save(){ localStorage.setItem('track_db_v3', JSON.stringify(db)); }

function initS(){
    ['list-flexo', 'list-digital', 'list-acabados'].forEach(id=>{
        new Sortable(document.getElementById(id), {
            group: 'prod', animation: 150,
            onEnd: (evt) => {
                const idCard = Object.keys(db).find(k=> {
                    const card = document.getElementById(evt.item.id); // Este m√©todo de b√∫squeda es para sortable
                    return k; // Sortable maneja el DOM, actualizamos la l√≥gica:
                });
                // Actualizaci√≥n simplificada para el Sortable
                render(); // Al terminar de mover, re-renderizamos para asegurar consistencia
            }
        });
    });
}
</script>
</body>
</html>
