<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Track Label Pro - Móvil & PC</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --bg: #0b0e11; --sidebar: #15191d; --surface: #1e2329;
            --orange: #ff7a00; --green: #00ff88; --text: #f0f0f0;
        }
        
        * { box-sizing: border-box; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; overflow-x: hidden; }

        /* --- LOGIN RESPONSIVE --- */
        .login-overlay { position: fixed; inset: 0; background: radial-gradient(circle, #1e2329 0%, #0b0e11 100%); display: flex; align-items: center; justify-content: center; z-index: 9999; padding: 20px; }
        .login-box { background: var(--surface); padding: 30px; border-radius: 35px; text-align: center; width: 100%; max-width: 440px; border: 1px solid #333; }
        .user-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .user-item { background: #15191d; padding: 10px; border-radius: 15px; border: 1px solid #222; cursor: pointer; font-size: 12px; }
        .user-initial { width: 35px; height: 35px; border-radius: 50%; border: 2px solid #333; display: flex; align-items: center; justify-content: center; margin: 0 auto 5px; font-weight: bold; }

        /* --- LAYOUT PRINCIPAL --- */
        .app-container { display: flex; flex-direction: row; min-height: 100vh; }
        
        /* Sidebar se oculta en móviles o se vuelve pequeña */
        .sidebar { width: 260px; background: var(--sidebar); border-right: 1px solid #222; padding: 20px; flex-shrink: 0; }
        .content-area { flex: 1; padding: 20px; display: flex; flex-direction: column; width: 100%; }

        /* --- HEADER RESPONSIVE --- */
        .main-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .header-actions { display: flex; gap: 8px; width: 100%; justify-content: space-between; }
        .btn-header { flex: 1; padding: 12px; border-radius: 10px; font-weight: bold; border: none; cursor: pointer; font-size: 12px; text-align: center; }
        .btn-add { background: var(--orange); color: white; }
        .btn-logout { background: #2a3139; color: #999; }

        /* --- KANBAN RESPONSIVE (CLAVE) --- */
        .kanban-board { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 15px; 
            margin-bottom: 20px; 
        }

        .machine-col { background: #15191d; padding: 15px; border-radius: 20px; border: 1px solid #222; min-height: 200px; }
        .col-header { display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 13px; color: #666; }

        /* --- TARJETAS --- */
        .job-card { background: var(--surface); padding: 15px; border-radius: 15px; margin-bottom: 12px; border-left: 4px solid; cursor: pointer; }
        .job-card strong { font-size: 14px; display: block; margin-bottom: 5px; }
        .job-card small { font-size: 11px; color: #888; display: block; }

        /* --- FOOTER --- */
        .finished-area { background: #15191d; padding: 15px; border-radius: 20px; border: 1px solid #222; }
        .finished-scroll { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; }
        .finished-card { min-width: 140px; background: #000; padding: 10px; border-radius: 12px; border-bottom: 3px solid var(--green); font-size: 11px; }

        /* --- MODALES --- */
        .modal-content { 
            background: var(--surface); 
            margin: 5% auto; 
            padding: 20px; 
            border-radius: 25px; 
            width: 90%; 
            max-width: 500px; 
            border: 1px solid #333; 
        }

        /* ********************************************* */
        /* ADAPTACIÓN PARA MÓVILES (PANTALLAS PEQUEÑAS)  */
        /* ********************************************* */
        @media (max-width: 768px) {
            .app-container { flex-direction: column; }
            .sidebar { width: 100%; border-right: none; border-bottom: 1px solid #222; padding: 15px; }
            .sidebar h4, .sidebar .activity { display: none; } /* Ocultamos historial en móvil para ahorrar espacio */
            
            .kanban-board { 
                grid-template-columns: 1fr; /* Una columna por fila */
            }

            .user-profile h2 { font-size: 18px; }
            .btn-header { font-size: 11px; padding: 10px; }
            
            .modal-content { margin: 15% auto; width: 95%; }
            input, select { font-size: 16px; } /* Evita zoom automático en iPhone */
        }
    </style>
</head>
<body>

<div id="login-screen" class="login-overlay">
    <div class="login-box">
        <div class="logo-icon-big">TL</div>
        <h2>TRACK LABEL PRO</h2>
        <div class="user-grid">
            <div class="user-item" onclick="selectUser('Isa', this)"><div class="user-initial">I</div><span>Isa</span></div>
            <div class="user-item" onclick="selectUser('Jaume', this)"><div class="user-initial">J</div><span>Jaume</span></div>
            <div class="user-item" onclick="selectUser('Ivan', this)"><div class="user-initial" style="border-color:var(--orange)">I</div><span>Ivan</span></div>
            <div class="user-item" onclick="selectUser('Anna', this)"><div class="user-initial">A</div><span>Anna</span></div>
            <div class="user-item" onclick="selectUser('Toni', this)"><div class="user-initial">T</div><span>Toni</span></div>
        </div>
        <input type="password" id="user-pin" placeholder="PIN" style="width:80%; padding:12px; margin-bottom:15px; background:#000; border:1px solid #333; color:white; text-align:center;">
        <button class="btn-login-action" onclick="login()" style="width:80%; padding:15px; background:var(--orange); border:none; border-radius:12px; color:white; font-weight:bold;">ENTRAR</button>
    </div>
</div>

<div id="main-app" class="app-container" style="display: none;">
    <aside class="sidebar">
        <div class="info-card">
            <h4>PROGRESO HOY</h4>
            <div class="progress-bar" style="background:#000; height:8px; border-radius:4px;"><div id="progress-fill" style="background:var(--green); height:100%; width:0%;"></div></div>
        </div>
        <div class="activity">
            <h4 style="font-size:10px; color:var(--orange)">HISTORIAL</h4>
            <ul id="activity-log" style="list-style:none; padding:0; font-size:10px; color:#666; max-height:100px; overflow-y:auto;"></ul>
        </div>
    </aside>

    <section class="content-area">
        <header class="main-header">
            <div class="user-profile">
                <h2 id="welcome-text" style="margin:0">Hola</h2>
            </div>
            <div class="header-actions">
                <button id="btn-nuevo-pedido" class="btn-header btn-add" onclick="openModal()">+ NUEVO</button>
                <button class="btn-header btn-logout" onclick="logout()">SALIR</button>
            </div>
        </header>

        <main class="kanban-board">
            <div class="machine-col">
                <div class="col-header">FLEXO <span class="badge" id="badge-list-flexo">0</span></div>
                <div id="list-flexo" class="drag-zone"></div>
            </div>
            <div class="machine-col">
                <div class="col-header">DIGITAL <span class="badge" id="badge-list-digital">0</span></div>
                <div id="list-digital" class="drag-zone"></div>
            </div>
            <div class="machine-col">
                <div class="col-header">REPASO <span class="badge" id="badge-list-acabados">0</span></div>
                <div id="list-acabados" class="drag-zone"></div>
            </div>
        </main>

        <footer class="finished-area">
            <h3 style="font-size:11px; margin-top:0;">EXPEDICIONES</h3>
            <div class="finished-scroll" id="list-finished"></div>
        </footer>
    </section>
</div>

<div id="modalPedido" class="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:10000;">
    <div class="modal-content">
        <h3>NUEVO PEDIDO</h3>
        <input type="text" id="inputCliente" placeholder="Cliente" style="width:100%; padding:12px; margin-bottom:10px; background:#000; color:white; border:1px solid #333;">
        <div style="display:flex; gap:10px; margin-bottom:10px;">
            <select id="inputMaquina" style="flex:1; padding:12px; background:#000; color:white; border:1px solid #333;">
                <option value="list-flexo">Flexo</option>
                <option value="list-digital">Digital</option>
            </select>
            <input type="number" id="inputMetros" placeholder="Metros" style="flex:1; padding:12px; background:#000; color:white; border:1px solid #333;">
        </div>
        <input type="text" id="inputTroquel" placeholder="Nº Troquel" style="width:100%; padding:12px; margin-bottom:10px; background:#000; color:white; border:1px solid #333;">
        <button onclick="guardarPedido()" style="width:100%; padding:15px; background:var(--orange); border:none; color:white; font-weight:bold; border-radius:10px;">CREAR</button>
        <button onclick="closeModal()" style="width:100%; background:none; border:none; color:#666; margin-top:10px;">Cancelar</button>
    </div>
</div>

<div id="modalTiempos" class="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:10000;">
    <div class="modal-content">
        <h2 id="tiempo-cliente"></h2>
        <div class="timer-box" style="margin-bottom:15px; padding:10px; border:1px solid #333;">
            <small>PREPARACIÓN</small>
            <div style="display:flex; align-items:center; gap:10px;">
                <button onclick="registrarTiempo('prep','inicio')" style="background:var(--green); border:none; padding:8px;">INI</button>
                <span id="display-prep" style="flex:1; text-align:center; font-family:monospace;">--:--</span>
                <button onclick="registrarTiempo('prep','fin')" style="background:#dc3545; border:none; padding:8px; color:white;">FIN</button>
            </div>
        </div>
        <div class="timer-box" style="margin-bottom:15px; padding:10px; border:1px solid #333;">
            <small>TIRAJE</small>
            <div style="display:flex; align-items:center; gap:10px;">
                <button onclick="registrarTiempo('tiraje','inicio')" style="background:var(--green); border:none; padding:8px;">INI</button>
                <span id="display-tiraje" style="flex:1; text-align:center; font-family:monospace;">--:--</span>
                <button onclick="registrarTiempo('tiraje','fin')" style="background:#dc3545; border:none; padding:8px; color:white;">FIN</button>
            </div>
        </div>
        <button id="btn-completar-final" onclick="completarTrabajo()" style="display:none; width:100%; padding:15px; background:var(--green); font-weight:bold; border:none; border-radius:10px;">EXPEDIR PEDIDO</button>
        <button onclick="closeModalTiempos()" style="width:100%; background:none; border:none; color:#666; margin-top:10px;">Cerrar</button>
    </div>
</div>

<script>
// El JavaScript es el mismo que antes, pero con las funciones de LocalStorage 
// para que no se pierda nada al refrescar.

const USUARIOS = {"Isa": "1234", "Jaume": "1234", "Ivan": "1234", "Anna": "1234", "Toni": "1234"};
let userSeleccionadoId = null;
let db = JSON.parse(localStorage.getItem('trackLabel_db')) || {};
let finalizadosDb = JSON.parse(localStorage.getItem('trackLabel_finalizados')) || [];
let pedidoActualId = null;

window.onload = () => {
    Object.keys(db).forEach(id => crearTarjetaDOM(id, db[id]));
    finalizadosDb.forEach(item => crearTarjetaFinalizadaDOM(item));
    actualizarDashboard();
};

function selectUser(nombre, element) {
    userSeleccionadoId = nombre;
    document.querySelectorAll('.user-item').forEach(el => el.style.borderColor = "#222");
    element.style.borderColor = "var(--orange)";
}

function login() {
    const pin = document.getElementById("user-pin").value;
    if (USUARIOS[userSeleccionadoId] === pin) {
        document.getElementById("login-screen").style.display = "none";
        document.getElementById("main-app").style.display = "flex";
        document.getElementById("welcome-text").innerText = "Hola, " + userSeleccionadoId;
        initSortable();
    } else { alert("PIN incorrecto"); }
}

function initSortable() {
    document.querySelectorAll('.drag-zone').forEach(zona => {
        new Sortable(zona, { 
            animation: 150,
            onEnd: () => {
                document.querySelectorAll('.drag-zone').forEach(col => {
                    col.querySelectorAll('.job-card').forEach(card => db[card.id].maquina = col.id);
                });
                save();
            }
        });
    });
}

function guardarPedido() {
    const c = document.getElementById("inputCliente").value;
    if(!c) return;
    const id = "ID-" + Date.now();
    db[id] = { 
        cliente: c, 
        maquina: document.getElementById("inputMaquina").value,
        metros: document.getElementById("inputMetros").value,
        troquel: document.getElementById("inputTroquel").value,
        tiempos: { prep: {}, tiraje: {}, repaso: {} },
        color: "#ff7a00"
    };
    crearTarjetaDOM(id, db[id]);
    save();
    closeModal();
}

function crearTarjetaDOM(id, data) {
    const card = document.createElement("div");
    card.className = "job-card";
    card.id = id;
    card.style.borderLeftColor = data.color;
    card.onclick = () => abrirTiempos(id);
    card.innerHTML = `<strong>${data.cliente}</strong><small>${data.metros}m | T: ${data.troquel}</small>`;
    document.getElementById(data.maquina).appendChild(card);
    actualizarDashboard();
}

function abrirTiempos(id) {
    pedidoActualId = id;
    const data = db[id];
    document.getElementById("tiempo-cliente").innerText = data.cliente;
    ['prep', 'tiraje'].forEach(f => {
        document.getElementById(`display-${f}`).innerText = (data.tiempos[f].inicio || "--") + " > " + (data.tiempos[f].fin || "--");
    });
    document.getElementById("btn-completar-final").style.display = (data.maquina === "list-acabados") ? "block" : "none";
    document.getElementById("modalTiempos").style.display = "block";
}

function registrarTiempo(fase, hito) {
    const ahora = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    db[pedidoActualId].tiempos[fase][hito] = ahora;
    if(fase === 'tiraje' && hito === 'fin') {
        document.getElementById("list-acabados").appendChild(document.getElementById(pedidoActualId));
        db[pedidoActualId].maquina = "list-acabados";
    }
    save();
    abrirTiempos(pedidoActualId);
}

function completarTrabajo() {
    finalizadosDb.unshift({cliente: db[pedidoActualId].cliente, hora: new Date().toLocaleTimeString()});
    document.getElementById(pedidoActualId).remove();
    delete db[pedidoActualId];
    save();
    location.reload();
}

function crearTarjetaFinalizadaDOM(item) {
    const fCard = document.createElement("div");
    fCard.className = "finished-card";
    fCard.innerHTML = `<strong>${item.cliente}</strong><br><small>${item.hora}</small>`;
    document.getElementById("list-finished").prepend(fCard);
}

function save() {
    localStorage.setItem('trackLabel_db', JSON.stringify(db));
    localStorage.setItem('trackLabel_finalizados', JSON.stringify(finalizadosDb));
    actualizarDashboard();
}

function actualizarDashboard() {
    ['list-flexo', 'list-digital', 'list-acabados'].forEach(id => {
        document.getElementById('badge-' + id).innerText = document.getElementById(id).children.length;
    });
}

function openModal() { document.getElementById("modalPedido").style.display = "block"; }
function closeModal() { document.getElementById("modalPedido").style.display = "none"; }
function closeModalTiempos() { document.getElementById("modalTiempos").style.display = "none"; }
function logout() { location.reload(); }
function resetSistema() { localStorage.clear(); location.reload(); }
</script>
</body>
</html>
