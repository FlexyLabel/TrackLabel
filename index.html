<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TRACKLABEL ERP ENTERPRISE v2026.ULTIMATE - IVAN CORE</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* ==========================================================================
           SISTEMA DE DISEÑO - VARIABLES CORE
           ========================================================================== */
        :root {
            --bg-ultra: #010204;
            --bg-base: #0a0c10;
            --bg-surface: #12151c;
            --bg-elevated: #1c212c;
            --primary: #00f2ff;
            --primary-glow: rgba(0, 242, 255, 0.3);
            --primary-dim: rgba(0, 242, 255, 0.08);
            --secondary: #30363d;
            --accent: #79c0ff;
            --success: #3fb950;
            --warning: #d29922;
            --danger: #f85149;
            --border: #30363d;
            --border-hover: #444c56;
            --text-main: #c9d1d9;
            --text-bold: #ffffff;
            --text-muted: #8b949e;
            --font-main: 'Inter', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            --radius-sm: 6px;
            --radius-md: 12px;
            --radius-lg: 24px;
            --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ==========================================================================
           RESET & BASE STYLES
           ========================================================================== */
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-base); }
        ::-webkit-scrollbar-thumb { background: var(--secondary); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

        body {
            background: var(--bg-ultra);
            color: var(--text-main);
            font-family: var(--font-main);
            height: 100vh;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* ==========================================================================
           GATEKEEPER - SISTEMA DE ACCESO (5 USUARIOS)
           ========================================================================== */
        #gatekeeper {
            position: fixed;
            inset: 0;
            z-index: 100000;
            background: radial-gradient(circle at center, #111b27 0%, #010409 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease, transform 0.6s cubic-bezier(0.8, 0, 0.2, 1);
        }

        .login-box {
            width: 100%;
            max-width: 900px;
            padding: 60px;
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            text-align: center;
            box-shadow: 0 50px 100px rgba(0,0,0,0.9);
        }

        .login-header h1 {
            font-size: 48px;
            font-weight: 900;
            letter-spacing: -2px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .login-header p {
            color: var(--text-muted);
            font-size: 11px;
            letter-spacing: 6px;
            margin-bottom: 50px;
            text-transform: uppercase;
        }

        .user-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 20px;
            margin-bottom: 50px;
        }

        .user-card {
            background: var(--bg-elevated);
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            padding: 25px 15px;
            cursor: pointer;
            transition: var(--transition);
        }

        .user-card:hover {
            border-color: var(--primary);
            transform: translateY(-8px);
            background: var(--bg-surface);
        }

        .user-card.active {
            border-color: var(--primary);
            background: var(--primary-dim);
            box-shadow: 0 0 30px var(--primary-glow);
        }

        .user-card i {
            font-size: 32px;
            color: var(--primary);
            margin-bottom: 15px;
            display: block;
        }

        .user-card .u-name {
            display: block;
            font-weight: 800;
            font-size: 14px;
            color: var(--text-bold);
            margin-bottom: 5px;
        }

        .user-card .u-role {
            font-size: 9px;
            color: var(--warning);
            font-weight: 800;
            text-transform: uppercase;
        }

        .pin-container {
            margin: 0 auto 40px;
            width: 320px;
        }

        .pin-input {
            width: 100%;
            background: #000;
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            padding: 20px;
            font-family: var(--font-mono);
            font-size: 42px;
            color: var(--primary);
            text-align: center;
            letter-spacing: 20px;
            transition: var(--transition);
        }

        .pin-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 20px var(--primary-glow);
        }

        /* ==========================================================================
           LAYOUT PRINCIPAL
           ========================================================================== */
        #app-shell {
            display: grid;
            grid-template-columns: 300px 1fr;
            height: 100vh;
            opacity: 0;
            transition: opacity 1s ease;
        }

        .sidebar {
            background: var(--bg-surface);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            z-index: 100;
        }

        .sidebar-logo {
            padding: 50px 40px;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-logo h2 {
            font-size: 20px;
            font-weight: 900;
            letter-spacing: -1px;
        }

        .nav-menu {
            flex: 1;
            padding: 30px 20px;
        }

        .nav-group-label {
            font-size: 10px;
            font-weight: 800;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin: 25px 0 15px 15px;
        }

        .nav-item {
            padding: 16px 20px;
            margin-bottom: 6px;
            border-radius: var(--radius-md);
            color: var(--text-muted);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: var(--transition);
        }

        .nav-item i {
            width: 20px;
            font-size: 16px;
            text-align: center;
        }

        .nav-item:hover {
            background: var(--bg-elevated);
            color: var(--text-bold);
        }

        .nav-item.active {
            background: var(--primary-dim);
            color: var(--primary);
            border-left: 4px solid var(--primary);
        }

        .sidebar-footer {
            padding: 30px;
            border-top: 1px solid var(--border);
            background: rgba(0,0,0,0.2);
        }

        .user-badge {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .avatar {
            width: 48px;
            height: 48px;
            background: var(--primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: 900;
            font-size: 20px;
        }

        /* ==========================================================================
           CONTENEDOR DE VISTAS (VIEWPORT)
           ========================================================================== */
        .viewport {
            padding: 50px 60px;
            overflow-y: auto;
            background: var(--bg-base);
            position: relative;
        }

        .view {
            display: none;
            max-width: 1400px;
            margin: 0 auto;
        }

        .view.active {
            display: block;
            animation: fadeInSlide 0.4s cubic-bezier(0, 0, 0.2, 1);
        }

        @keyframes fadeInSlide {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .view-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
        }

        .view-header h1 {
            font-size: 32px;
            font-weight: 900;
            color: var(--text-bold);
        }

        /* ==========================================================================
           TARJETAS Y WIDGETS
           ========================================================================== */
        .card {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 30px;
            margin-bottom: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 25px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            padding: 25px;
            border-radius: var(--radius-md);
            transition: var(--transition);
        }

        .stat-card:hover {
            border-color: var(--primary);
            background: var(--bg-elevated);
        }

        .stat-card label {
            display: block;
            font-size: 11px;
            font-weight: 800;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: 900;
            color: var(--text-bold);
            font-family: var(--font-mono);
        }

        /* ==========================================================================
           KANBAN DE PRODUCCIÓN
           ========================================================================== */
        .kanban {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 30px;
            align-items: flex-start;
        }

        .kanban-col {
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            min-height: 70vh;
            display: flex;
            flex-direction: column;
        }

        .kanban-head {
            padding: 20px 25px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .kanban-head h3 {
            font-size: 12px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--text-muted);
        }

        .ot-list {
            padding: 15px;
            flex: 1;
        }

        .ot-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: var(--transition);
        }

        .ot-card:hover {
            border-color: var(--primary);
            transform: scale(1.02);
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
        }

        .ot-card h4 {
            font-size: 16px;
            color: var(--text-bold);
            margin-bottom: 8px;
        }

        .ot-card .id-tag {
            font-family: var(--font-mono);
            color: var(--primary);
            font-size: 12px;
            font-weight: 700;
            margin-bottom: 12px;
            display: block;
        }

        .ot-meta {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-muted);
            border-top: 1px solid var(--border);
            padding-top: 12px;
        }

        /* ==========================================================================
           TERMINAL DE PRODUCCIÓN (MAINFRAME)
           ========================================================================== */
        #terminal {
            position: fixed;
            inset: 0;
            z-index: 50000;
            background: var(--bg-ultra);
            display: none;
            flex-direction: column;
        }

        .term-nav {
            padding: 25px 60px;
            background: var(--bg-surface);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .term-content {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 480px;
        }

        .term-center {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .timer-main {
            font-size: 14vw;
            font-family: var(--font-mono);
            font-weight: 900;
            color: var(--primary);
            text-shadow: 0 0 100px var(--primary-glow);
            line-height: 1;
        }

        .term-inputs {
            display: grid;
            grid-template-columns: repeat(2, 280px);
            gap: 30px;
            margin-top: 60px;
        }

        .input-card {
            background: var(--bg-elevated);
            padding: 30px;
            border-radius: var(--radius-md);
            text-align: center;
            border: 1px solid var(--border);
        }

        .input-card label {
            display: block;
            font-size: 12px;
            font-weight: 800;
            color: var(--text-muted);
            margin-bottom: 15px;
            text-transform: uppercase;
        }

        .big-input {
            width: 100%;
            background: transparent;
            border: none;
            border-bottom: 3px solid var(--border);
            color: var(--text-bold);
            font-family: var(--font-mono);
            font-size: 56px;
            text-align: center;
            transition: var(--transition);
        }

        .big-input:focus {
            border-color: var(--primary);
        }

        .term-right {
            background: var(--bg-surface);
            border-left: 1px solid var(--border);
            padding: 50px;
            display: flex;
            flex-direction: column;
        }

        /* ==========================================================================
           BOTONES INDUSTRIALES
           ========================================================================== */
        .btn {
            padding: 16px 30px;
            border-radius: var(--radius-md);
            border: none;
            font-family: var(--font-main);
            font-weight: 800;
            font-size: 14px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: var(--transition);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary { background: var(--primary); color: #000; }
        .btn-primary:hover { transform: translateY(-2px); filter: brightness(1.1); box-shadow: 0 10px 20px var(--primary-glow); }
        
        .btn-danger { background: var(--danger); color: #fff; }
        .btn-warning { background: var(--warning); color: #000; }
        .btn-ghost { background: var(--bg-elevated); color: var(--text-bold); border: 1px solid var(--border); }
        .btn-ghost:hover { border-color: var(--primary); background: var(--bg-surface); }

        /* ==========================================================================
           TABLAS DE DATOS - STOCK & HISTORIAL
           ========================================================================== */
        .table-container {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
        }

        th {
            background: rgba(0,0,0,0.3);
            padding: 20px 25px;
            font-size: 11px;
            font-weight: 800;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid var(--border);
        }

        td {
            padding: 20px 25px;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
            color: var(--text-main);
        }

        tr:last-child td { border-bottom: none; }
        tr:hover td { background: rgba(255,255,255,0.02); }

        .badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 800;
            text-transform: uppercase;
        }

        .badge-success { background: rgba(63, 185, 80, 0.15); color: var(--success); }
        .badge-warning { background: rgba(210, 153, 34, 0.15); color: var(--warning); }
        .badge-info { background: rgba(0, 242, 255, 0.15); color: var(--primary); }

        /* ==========================================================================
           MODALES DINÁMICOS
           ========================================================================== */
        .modal-overlay {
            position: fixed;
            inset: 0;
            z-index: 60000;
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            width: 100%;
            max-width: 800px;
            border-radius: var(--radius-lg);
            padding: 50px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .form-group { margin-bottom: 25px; }
        .form-group label {
            display: block;
            font-size: 11px;
            font-weight: 800;
            color: var(--primary);
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .form-input {
            width: 100%;
            padding: 18px;
            background: #000;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: #fff;
            font-size: 16px;
        }

        .form-input:focus { border-color: var(--primary); }

        /* ==========================================================================
           ESTADÍSTICAS DE IMPRESIÓN (DESGLOSE)
           ========================================================================== */
        .stats-detail-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .detail-box {
            background: var(--bg-elevated);
            padding: 20px;
            border-radius: var(--radius-md);
        }

        .detail-box h5 {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 5px;
        }

        .detail-box p {
            font-size: 20px;
            font-weight: 800;
            color: var(--text-bold);
            font-family: var(--font-mono);
        }

    </style>
</head>
<body>

    <div id="gatekeeper">
        <div class="login-box">
            <div class="login-header">
                <h1>TRACK<span style="color:var(--primary)">LABEL</span></h1>
                <p>Enterprise Resource Planning - Industrial Core v2026</p>
            </div>
            
            <div class="user-grid" id="login-users">
                </div>

            <div class="pin-container">
                <input type="password" id="login-pin" class="pin-input" placeholder="••••" maxlength="4">
            </div>

            <button class="btn btn-primary" style="width: 320px; height: 70px; font-size: 18px;" onclick="Engine.Auth.login()">
                Sincronizar Terminal
            </button>
        </div>
    </div>

    <div id="app-shell">
        <aside class="sidebar">
            <div class="sidebar-logo">
                <h2>CORE <span style="color:var(--primary)">SYSTEM</span></h2>
            </div>
            
            <nav class="nav-menu">
                <p class="nav-group-label">Producción Activa</p>
                <div class="nav-item active" onclick="Engine.UI.view('production', this)">
                    <i class="fas fa-microchip"></i> Panel de Planta
                </div>
                
                <p class="nav-group-label">Gestión de Stock</p>
                <div class="nav-item" onclick="Engine.UI.view('stock-finished', this)">
                    <i class="fas fa-barcode"></i> Etiquetas Hechas
                </div>
                <div class="nav-item" onclick="Engine.UI.view('warehouse', this)">
                    <i class="fas fa-scroll"></i> Almacén Bobinas
                </div>

                <p class="nav-group-label">Analítica & Datos</p>
                <div class="nav-item" onclick="Engine.UI.view('analytics', this)">
                    <i class="fas fa-chart-area"></i> Estadísticas OEE
                </div>
                <div class="nav-item" onclick="Engine.UI.view('history', this)">
                    <i class="fas fa-folder-open"></i> Historial de Turnos
                </div>

                <div id="admin-section" style="display:none;">
                    <p class="nav-group-label">Administración</p>
                    <div class="nav-item" onclick="Engine.UI.view('admin', this)">
                        <i class="fas fa-shield-halved"></i> Configuración Maestro
                    </div>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="user-badge">
                    <div id="u-ava" class="avatar">?</div>
                    <div>
                        <p id="u-name" style="font-weight: 800; font-size: 15px; color:#fff;">Ivan</p>
                        <p id="u-role" style="font-size: 10px; color:var(--warning); font-weight:700;">ADMINISTRADOR</p>
                    </div>
                </div>
                <button class="btn btn-ghost" style="width: 100%;" onclick="location.reload()">Cerrar Sesión</button>
            </div>
        </aside>

        <main class="viewport">
            
            <div id="v-production" class="view active">
                <div class="view-header">
                    <h1>Monitor de Planta</h1>
                    <button class="btn btn-primary" onclick="Engine.UI.modal('m-new-ot', true)">
                        <i class="fas fa-plus"></i> Nueva OT
                    </button>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <label>Eficiencia Turno</label>
                        <div class="value" style="color:var(--success)">94.2%</div>
                    </div>
                    <div class="stat-card">
                        <label>Metros Hoy</label>
                        <div class="value">12.450 m</div>
                    </div>
                    <div class="stat-card">
                        <label>Tiempo en Paro</label>
                        <div class="value" style="color:var(--danger)">12m</div>
                    </div>
                    <div class="stat-card">
                        <label>Velocidad Med.</label>
                        <div class="value" style="color:var(--primary)">65 <small>m/min</small></div>
                    </div>
                </div>

                <div class="kanban">
                    <div class="kanban-col">
                        <div class="kanban-head"><h3>En Cola</h3><span id="c-wait" class="badge">0</span></div>
                        <div class="ot-list" id="l-wait"></div>
                    </div>
                    <div class="kanban-col" style="border-color: var(--primary);">
                        <div class="kanban-head" style="color:var(--primary)"><h3>Produciendo</h3><span id="c-run" class="badge">0</span></div>
                        <div class="ot-list" id="l-run"></div>
                    </div>
                    <div class="kanban-col">
                        <div class="kanban-head"><h3>Completado</h3><span id="c-done" class="badge">0</span></div>
                        <div class="ot-list" id="l-done"></div>
                    </div>
                </div>
            </div>

            <div id="v-stock-finished" class="view">
                <div class="view-header">
                    <h1>Inventario Producto Terminado</h1>
                    <button class="btn btn-ghost" onclick="Engine.Inventory.exportStock()">Exportar Excel</button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Referencia / OT</th>
                                <th>Cliente</th>
                                <th>Ubicación Almacén</th>
                                <th>Cantidad Disponible</th>
                                <th>Fecha Fabricación</th>
                                <th>Operario</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody id="table-stock-finished">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="v-history" class="view">
                <div class="view-header">
                    <h1>Historial de Producción</h1>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>OT ID</th>
                                <th>Cliente</th>
                                <th>Metros</th>
                                <th>Vel. Media</th>
                                <th>Tiempo Total</th>
                                <th>Estado</th>
                                <th>Análisis</th>
                            </tr>
                        </thead>
                        <tbody id="table-history"></tbody>
                    </table>
                </div>
            </div>

            <div id="v-analytics" class="view">
                <div class="view-header"><h1>Analítica OEE Industrial</h1></div>
                <div class="card">
                    <canvas id="chart-oee" style="width: 100%; height: 400px;"></canvas>
                </div>
            </div>

        </main>
    </div>

    <div id="terminal">
        <div class="term-nav">
            <div>
                <h2 id="tm-client" style="font-size: 32px; font-weight: 900;">NOMBRE DEL CLIENTE</h2>
                <p id="tm-id" style="font-family: var(--font-mono); color: var(--primary); letter-spacing: 3px;">OT-00000</p>
            </div>
            <div style="display: flex; gap: 20px;">
                <button class="btn btn-warning" id="tm-pause" onclick="Engine.Prod.pause()">Pausar</button>
                <button class="btn btn-primary" onclick="Engine.Prod.finish()">Finalizar Orden</button>
            </div>
        </div>
        <div class="term-content">
            <div class="term-center">
                <div class="timer-main" id="tm-clock">00:00:00</div>
                
                <div class="term-inputs">
                    <div class="input-card">
                        <label>Metros Actuales</label>
                        <input type="number" id="tm-val-m" class="big-input" value="0" oninput="Engine.Prod.sync()">
                    </div>
                    <div class="input-card">
                        <label>m/min Instantáneos</label>
                        <div id="tm-val-speed" class="big-input" style="color: var(--primary); border: none;">0.0</div>
                    </div>
                </div>
            </div>
            <div class="term-right">
                <h3 style="font-size: 11px; letter-spacing: 3px; color: var(--text-muted); margin-bottom: 30px;">REGISTRO DE INCIDENCIAS</h3>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <button class="btn btn-ghost" onclick="Engine.Prod.log('Cambio de Bobina')">Cambio Bobina</button>
                    <button class="btn btn-ghost" onclick="Engine.Prod.log('Ajuste de Registro')">Ajuste Registro</button>
                    <button class="btn btn-ghost" onclick="Engine.Prod.log('Limpieza de Planchas')">Limpieza Planchas</button>
                    <button class="btn btn-ghost" onclick="Engine.Prod.log('Avería Mecánica')">Avería / Motor</button>
                </div>
                <div id="tm-event-log" style="margin-top: 40px; flex: 1; border-top: 1px solid var(--border); padding-top: 20px; font-family: var(--font-mono); font-size: 12px; color: var(--text-muted); overflow-y: auto;">
                    </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="m-new-ot">
        <div class="modal">
            <h2>Configurar Nueva Orden de Trabajo</h2>
            <div style="margin-top: 40px;">
                <div class="form-group">
                    <label>Cliente</label>
                    <input type="text" id="f-client" class="form-input" placeholder="Nombre de la empresa">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <label>Metraje Objetivo</label>
                        <input type="number" id="f-target" class="form-input" placeholder="5000">
                    </div>
                    <div class="form-group">
                        <label>Ubicación Sugerida Almacén</label>
                        <input type="text" id="f-location" class="form-input" value="PASILLO-A1">
                    </div>
                </div>
                <div style="display: flex; gap: 20px; margin-top: 20px;">
                    <button class="btn btn-primary" style="flex: 1;" onclick="Engine.Data.createOT()">Crear Orden</button>
                    <button class="btn btn-ghost" style="flex: 1;" onclick="Engine.UI.modal('m-new-ot', false)">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="m-stats">
        <div class="modal" style="max-width: 600px;">
            <h2 id="st-id">ESTADÍSTICAS OT</h2>
            <div class="stats-detail-grid" style="margin-top: 30px;">
                <div class="detail-box"><h5 id="st-client">CLIENTE</h5><p>Análisis Completo</p></div>
                <div class="detail-box"><h5>METRAJE FINAL</h5><p id="st-m">0 m</p></div>
                <div class="detail-box"><h5>VELOCIDAD MEDIA</h5><p id="st-avg">0 m/min</p></div>
                <div class="detail-box"><h5>TIEMPO OPERATIVO</h5><p id="st-time">00:00:00</p></div>
            </div>
            <div style="margin-top: 30px; background: #000; padding: 20px; border-radius: 12px;">
                <p style="font-size: 10px; color: var(--primary); margin-bottom: 10px;">LOG DE INCIDENCIAS DEL TURNO</p>
                <div id="st-logs" style="font-size: 12px; font-family: var(--font-mono); color: var(--warning);"></div>
            </div>
            <button class="btn btn-primary" style="width: 100%; margin-top: 30px;" onclick="Engine.UI.modal('m-stats', false)">Cerrar Informe</button>
        </div>
    </div>

    <script>
        /* ==========================================================================
           ENGINE - NÚCLEO DEL ERP v2026.ULTIMATE
           ========================================================================== */
        
        const Engine = {
            State: {
                user: null,
                activeOT: null,
                timer: null,
                isPaused: false,
                db: {
                    ots: [],
                    stock: [], // Producto terminado
                    inventory: [] // Materia prima (bobinas)
                }
            },

            Users: [
                { id: 1, name: 'IVAN', role: 'ADMIN', pin: '1234', icon: 'fa-user-shield' },
                { id: 2, name: 'ANNA', role: 'ADMIN', pin: '2222', icon: 'fa-user-tie' },
                { id: 3, name: 'TONI', role: 'ADMIN', pin: '3333', icon: 'fa-user-cog' },
                { id: 4, name: 'ISA', role: 'OPERARIO', pin: '1111', icon: 'fa-user' },
                { id: 5, name: 'JAUME', role: 'OPERARIO', pin: '4444', icon: 'fa-user' }
            ],

            init() {
                // Renderizar Login
                const grid = document.getElementById('login-users');
                this.Users.forEach(u => {
                    const card = document.createElement('div');
                    card.className = 'user-card';
                    card.id = `u-${u.id}`;
                    card.innerHTML = `<i class="fas ${u.icon}"></i><span class="u-name">${u.name}</span><span class="u-role">${u.role}</span>`;
                    card.onclick = () => {
                        this.State.user = u;
                        document.querySelectorAll('.user-card').forEach(c => c.classList.remove('active'));
                        card.classList.add('active');
                        document.getElementById('login-pin').focus();
                    };
                    grid.appendChild(card);
                });

                // Cargar DB
                const data = localStorage.getItem('tracklabel_ultimate_db');
                if(data) this.State.db = JSON.parse(data);
                
                this.Data.render();
            },

            Auth: {
                login() {
                    const pin = document.getElementById('login-pin').value;
                    const user = Engine.State.user;
                    if(!user || pin !== user.pin) return alert("ACCESO DENEGADO: PIN INCORRECTO");

                    document.getElementById('gatekeeper').style.transform = 'translateY(-100%)';
                    document.getElementById('gatekeeper').style.opacity = '0';
                    document.getElementById('app-shell').style.opacity = '1';

                    document.getElementById('u-name').innerText = user.name;
                    document.getElementById('u-role').innerText = user.role;
                    document.getElementById('u-ava').innerText = user.name[0];

                    if(user.role === 'ADMIN') document.getElementById('admin-section').style.display = 'block';
                    
                    Engine.UI.initCharts();
                }
            },

            Prod: {
                start(id) {
                    const ot = Engine.State.db.ots.find(o => o.id === id);
                    if(ot.status === 'done') return Engine.UI.showStats(id);
                    
                    Engine.State.activeOT = ot;
                    ot.status = 'run';
                    document.getElementById('tm-client').innerText = ot.client;
                    document.getElementById('tm-id').innerText = ot.id;
                    document.getElementById('tm-val-m').value = ot.real;
                    document.getElementById('terminal').style.display = 'flex';
                    
                    this.launchTimer();
                },

                launchTimer() {
                    if(Engine.State.timer) clearInterval(Engine.State.timer);
                    let baseTime = Engine.State.activeOT.time;
                    let startTime = Date.now();

                    Engine.State.timer = setInterval(() => {
                        if(Engine.State.isPaused) {
                            startTime = Date.now();
                            return;
                        }
                        let now = Date.now();
                        Engine.State.activeOT.time = baseTime + (now - startTime);
                        document.getElementById('tm-clock').innerText = Engine.UI.fmtTime(Engine.State.activeOT.time);
                        this.sync();
                    }, 1000);
                },

                pause() {
                    Engine.State.isPaused = !Engine.State.isPaused;
                    const btn = document.getElementById('tm-pause');
                    btn.innerText = Engine.State.isPaused ? 'REANUDAR' : 'PAUSAR';
                    btn.className = Engine.State.isPaused ? 'btn btn-primary' : 'btn btn-warning';
                },

                sync() {
                    const m = parseFloat(document.getElementById('tm-val-m').value) || 0;
                    Engine.State.activeOT.real = m;
                    const min = Engine.State.activeOT.time / 60000;
                    if(min > 0.05) {
                        const speed = (m / min).toFixed(1);
                        document.getElementById('tm-val-speed').innerText = speed;
                    }
                },

                log(msg) {
                    const entry = `[${new Date().toLocaleTimeString()}] ${msg}`;
                    Engine.State.activeOT.logs.push(entry);
                    const logEl = document.getElementById('tm-event-log');
                    logEl.innerHTML = `<div>${entry}</div>` + logEl.innerHTML;
                },

                finish() {
                    if(!confirm("¿CONFIRMAR CIERRE DE OT Y TRASPASO A STOCK?")) return;
                    
                    const ot = Engine.State.activeOT;
                    ot.status = 'done';
                    ot.finishedAt = new Date().toLocaleString();
                    
                    // Lógica de Stock: Mover lo producido al almacén de terminados
                    Engine.State.db.stock.push({
                        id: ot.id,
                        client: ot.client,
                        qty: ot.real,
                        location: ot.location || 'PASILLO-DEFAULT',
                        date: new Date().toLocaleDateString(),
                        op: Engine.State.user.name
                    });

                    clearInterval(Engine.State.timer);
                    document.getElementById('terminal').style.display = 'none';
                    Engine.Data.save();
                    Engine.Data.render();
                }
            },

            Data: {
                createOT() {
                    const cli = document.getElementById('f-client').value;
                    const tar = document.getElementById('f-target').value;
                    const loc = document.getElementById('f-location').value;

                    if(!cli || !tar) return alert("CAMPOS OBLIGATORIOS");

                    const newOT = {
                        id: 'OT-' + Math.floor(Math.random()*90000 + 10000),
                        client: cli.toUpperCase(),
                        target: parseFloat(tar),
                        real: 0,
                        time: 0,
                        status: 'wait',
                        location: loc.toUpperCase(),
                        logs: [],
                        op: Engine.State.user.name
                    };

                    Engine.State.db.ots.push(newOT);
                    this.save();
                    this.render();
                    Engine.UI.modal('m-new-ot', false);
                },

                render() {
                    // Kanban
                    const cols = { wait: 'l-wait', run: 'l-run', done: 'l-done' };
                    Object.values(cols).forEach(c => document.getElementById(c).innerHTML = '');
                    
                    Engine.State.db.ots.forEach(o => {
                        const card = document.createElement('div');
                        card.className = 'ot-card';
                        card.innerHTML = `
                            <span class="id-tag">${o.id}</span>
                            <h4>${o.client}</h4>
                            <div class="ot-meta">
                                <span><i class="fas fa-crosshairs"></i> ${o.target}m</span>
                                <span><i class="fas fa-user"></i> ${o.op}</span>
                            </div>
                        `;
                        card.onclick = () => Engine.Prod.start(o.id);
                        document.getElementById(cols[o.status]).appendChild(card);
                    });

                    // Historial
                    document.getElementById('table-history').innerHTML = Engine.State.db.ots.filter(o => o.status === 'done').map(o => `
                        <tr>
                            <td style="font-family:var(--font-mono); color:var(--primary)">${o.id}</td>
                            <td><b>${o.client}</b></td>
                            <td>${o.real} m</td>
                            <td>${(o.real / (o.time/60000)).toFixed(1)} m/min</td>
                            <td>${Engine.UI.fmtTime(o.time)}</td>
                            <td><span class="badge badge-success">Finalizado</span></td>
                            <td><button class="btn btn-ghost" style="padding:5px 10px" onclick="Engine.UI.showStats('${o.id}')">Análisis</button></td>
                        </tr>
                    `).join('');

                    // Stock Terminado
                    document.getElementById('table-stock-finished').innerHTML = Engine.State.db.stock.map(s => `
                        <tr>
                            <td style="font-family:var(--font-mono)">${s.id}</td>
                            <td><b>${s.client}</b></td>
                            <td><span class="badge badge-info">${s.location}</span></td>
                            <td style="color:var(--success); font-weight:800">${s.qty.toLocaleString()} m</td>
                            <td>${s.date}</td>
                            <td>${s.op}</td>
                            <td><button class="btn btn-ghost" style="padding:5px">Salida</button></td>
                        </tr>
                    `).join('');

                    // Contadores
                    document.getElementById('c-wait').innerText = Engine.State.db.ots.filter(o => o.status === 'wait').length;
                    document.getElementById('c-run').innerText = Engine.State.db.ots.filter(o => o.status === 'run').length;
                    document.getElementById('c-done').innerText = Engine.State.db.ots.filter(o => o.status === 'done').length;
                },

                save() { localStorage.setItem('tracklabel_ultimate_db', JSON.stringify(Engine.State.db)); }
            },

            UI: {
                view(id, el) {
                    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                    document.getElementById('v-' + id).classList.add('active');
                    el.classList.add('active');
                },

                modal(id, show) { document.getElementById(id).style.display = show ? 'flex' : 'none'; },

                fmtTime(ms) {
                    let s = Math.floor(ms/1000); let m = Math.floor(s/60); let h = Math.floor(m/60);
                    return `${h.toString().padStart(2,'0')}:${(m%60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
                },

                showStats(id) {
                    const o = Engine.State.db.ots.find(x => x.id === id);
                    document.getElementById('st-id').innerText = `INFORME OT: ${o.id}`;
                    document.getElementById('st-client').innerText = o.client;
                    document.getElementById('st-m').innerText = o.real + " m";
                    document.getElementById('st-time').innerText = this.fmtTime(o.time);
                    document.getElementById('st-avg').innerText = (o.real / (o.time/60000)).toFixed(1) + " m/min";
                    document.getElementById('st-logs').innerHTML = o.logs.length ? o.logs.join('<br>') : 'Sin incidencias.';
                    this.modal('m-stats', true);
                },

                initCharts() {
                    const ctx = document.getElementById('chart-oee').getContext('2d');
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: ['Lun', 'Mar', 'Mie', 'Jue', 'Vie', 'Sab', 'Dom'],
                            datasets: [{
                                label: 'OEE %',
                                data: [88, 92, 90, 95, 93, 89, 94],
                                borderColor: '#00f2ff',
                                tension: 0.4,
                                fill: true,
                                backgroundColor: 'rgba(0, 242, 255, 0.05)'
                            }]
                        },
                        options: {
                            plugins: { legend: { display: false } },
                            scales: { y: { beginAtZero: false, min: 80 } }
                        }
                    });
                }
            }
        };

        window.onload = () => Engine.init();

    </script>
</body>
</html>
