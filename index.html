<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Track Label Pro - Cloud</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --bg: #0b0e11; --sidebar: #15191d; --surface: #1e2329;
            --orange: #ff7a00; --green: #00ff88; --text: #f0f0f0; --border: #282e35;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; overflow: hidden; }

        /* 1. PANTALLA DE CONTRASE√ëA MAESTRA */
        #master-lock { position: fixed; inset: 0; background: #000; z-index: 20000; display: flex; align-items: center; justify-content: center; }
        .lock-box { background: var(--surface); padding: 30px; border-radius: 30px; text-align: center; border: 1px solid #333; width: 90%; max-width: 350px; }

        /* 2. LOGIN USUARIOS */
        .login-overlay { position: fixed; inset: 0; background: var(--bg); z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .user-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 20px 0; }
        .user-item { background: #15191d; padding: 15px 5px; border-radius: 15px; border: 1px solid #222; cursor: pointer; text-align: center; font-size: 11px; }
        .user-item.selected { border-color: var(--orange); background: #2a3139; }

        /* 3. ESTRUCTURA PRINCIPAL (CORREGIDA PARA M√ìVIL) */
        .app-container { display: flex; height: 100vh; width: 100vw; }
        
        /* Sidebar: En PC es lateral, en m√≥vil es un panel que no estorba */
        .sidebar { 
            width: 280px; background: var(--sidebar); border-right: 1px solid var(--border); 
            padding: 20px; flex-shrink: 0; display: flex; flex-direction: column; overflow-y: auto;
        }

        .content-area { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: var(--bg); }
        
        .main-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; background: var(--sidebar); border-bottom: 1px solid var(--border); }

        /* KANBAN: El coraz√≥n del problema */
        .kanban-board { 
            flex: 1; display: flex; gap: 15px; padding: 15px; overflow-x: auto; /* Permite scroll horizontal si no caben */
            align-items: flex-start;
        }

        .machine-col { 
            background: #15191d; border-radius: 20px; border: 1px solid var(--border); 
            width: 320px; min-width: 280px; max-height: 100%; display: flex; flex-direction: column; flex-shrink: 0;
        }
        
        .col-header { padding: 15px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; font-weight: bold; font-size: 13px; color: #888; }
        .drag-zone { flex: 1; padding: 10px; overflow-y: auto; min-height: 100px; }

        /* TARJETAS */
        .job-card { background: var(--surface); padding: 15px; border-radius: 15px; margin-bottom: 10px; border-left: 5px solid var(--orange); box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .job-card strong { display: block; font-size: 14px; margin-bottom: 5px; }
        .job-card small { color: #888; font-size: 11px; }

        /* MODALES */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 15000; padding: 20px; }
        .modal-content { background: var(--surface); margin: 0 auto; padding: 25px; border-radius: 25px; width: 100%; max-width: 450px; border: 1px solid #444; }

        input, select { width: 100%; padding: 12px; margin-bottom: 10px; background: #000; border: 1px solid #333; color: white; border-radius: 10px; }
        .btn-orange { width: 100%; padding: 15px; background: var(--orange); border: none; border-radius: 12px; color: white; font-weight: bold; cursor: pointer; }

        /* --- RESPONSIVE ADAPTATION --- */
        @media (max-width: 850px) {
            .sidebar { display: none; } /* En m√≥vil ocultamos la sidebar para ver las m√°quinas */
            .machine-col { width: 85vw; } /* Las columnas ocupan casi toda la pantalla */
            .kanban-board { padding: 10px; gap: 10px; -webkit-overflow-scrolling: touch; }
        }
    </style>
</head>
<body>

<div id="master-lock">
    <div class="lock-box">
        <h2 style="color:var(--orange); margin-top:0;">SEGURIDAD</h2>
        <p style="font-size:12px; color:#888;">Introduce la contrase√±a de acceso</p>
        <input type="password" id="master-pass" placeholder="Contrase√±a">
        <button class="btn-orange" onclick="checkMaster()">ENTRAR</button>
    </div>
</div>

<div id="login-screen" class="login-overlay" style="display:none">
    <div class="lock-box" style="max-width: 400px;">
        <h3>OPERARIO ACTUAL</h3>
        <div class="user-grid">
            <div class="user-item" onclick="selectUser('Isa', this)">Isa</div>
            <div class="user-item" onclick="selectUser('Jaume', this)">Jaume</div>
            <div class="user-item" onclick="selectUser('Ivan', this)">Ivan</div>
            <div class="user-item" onclick="selectUser('Anna', this)">Anna</div>
            <div class="user-item" onclick="selectUser('Toni', this)">Toni</div>
        </div>
        <input type="password" id="user-pin" placeholder="PIN">
        <button class="btn-orange" onclick="doLogin()">ACCEDER</button>
    </div>
</div>

<div id="main-app" class="app-container" style="display:none">
    <aside class="sidebar">
        <h2 style="color:var(--orange)">TL PLANTA</h2>
        <div id="sync-status" style="font-size:10px; color:var(--green); margin-bottom:20px;">‚óè NUBE ACTIVADA</div>
        <div style="background:#000; padding:15px; border-radius:15px;">
            <p style="margin:0; font-size:11px; color:#666;">PEDIDOS ACTIVOS</p>
            <h1 id="count-activos" style="margin:5px 0 0 0;">0</h1>
        </div>
        <button onclick="logout()" style="margin-top:auto; background:none; border:1px solid #333; color:#666; padding:10px; border-radius:10px; cursor:pointer;">Cerrar Sesi√≥n</button>
    </aside>

    <main class="content-area">
        <header class="main-header">
            <div id="user-label" style="font-weight:bold;">Operario: ---</div>
            <button onclick="openModal()" style="background:var(--orange); border:none; padding:8px 15px; border-radius:8px; color:white; font-weight:bold; font-size:12px;">+ NUEVO</button>
        </header>

        <div class="kanban-board">
            <div class="machine-col">
                <div class="col-header">FLEXO <span class="badge" id="b-flexo">0</span></div>
                <div id="list-flexo" class="drag-zone"></div>
            </div>
            <div class="machine-col">
                <div class="col-header">DIGITAL <span class="badge" id="b-digital">0</span></div>
                <div id="list-digital" class="drag-zone"></div>
            </div>
            <div class="machine-col">
                <div class="col-header">REPASO <span class="badge" id="b-repaso">0</span></div>
                <div id="list-acabados" class="drag-zone"></div>
            </div>
        </div>
    </main>
</div>

<div id="modalPedido" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0">NUEVO TRABAJO</h3>
        <label style="font-size:10px; color:var(--orange)">CLIENTE</label>
        <input type="text" id="inCli" placeholder="Nombre cliente">
        <label style="font-size:10px; color:var(--orange)">M√ÅQUINA</label>
        <select id="inMaq">
            <option value="list-flexo">FLEXO</option>
            <option value="list-digital">DIGITAL</option>
        </select>
        <label style="font-size:10px; color:var(--orange)">METROS</label>
        <input type="number" id="inMet" placeholder="0">
        <button class="btn-orange" onclick="addJob()">LANZAR A M√ÅQUINA</button>
        <button onclick="closeModal()" style="width:100%; background:none; border:none; color:#666; margin-top:15px; cursor:pointer;">Cancelar</button>
    </div>
</div>

<script>
const MASTER_PASS = "TrackLabel#";
const USERS = {"Isa":"1234", "Jaume":"1234", "Ivan":"1234", "Anna":"1234", "Toni":"1234"};

let db = JSON.parse(localStorage.getItem('tl_db')) || {};
let currentUser = null;

// SEGURIDAD
function checkMaster() {
    if(document.getElementById('master-pass').value === MASTER_PASS) {
        document.getElementById('master-lock').style.display = 'none';
        document.getElementById('login-screen').style.display = 'flex';
    } else { alert("Acceso denegado"); }
}

function selectUser(name, el) {
    currentUser = name;
    document.querySelectorAll('.user-item').forEach(i => i.classList.remove('selected'));
    el.classList.add('selected');
}

function doLogin() {
    const pin = document.getElementById('user-pin').value;
    if(USERS[currentUser] === pin) {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('main-app').style.display = 'flex';
        document.getElementById('user-label').innerText = "Hola, " + currentUser;
        render();
        initSortable();
    } else { alert("PIN incorrecto"); }
}

// LOGICA DE TRABAJOS
function render() {
    document.querySelectorAll('.drag-zone').forEach(z => z.innerHTML = "");
    Object.keys(db).forEach(id => {
        const job = db[id];
        const card = document.createElement('div');
        card.className = "job-card";
        card.id = id;
        card.innerHTML = `<strong>${job.cli.toUpperCase()}</strong><small>üìè ${job.met}m</small>`;
        card.onclick = () => { if(confirm("¬øEliminar o completar este trabajo?")) { delete db[id]; save(); } };
        document.getElementById(job.maq).appendChild(card);
    });
    actualizarBadges();
}

function addJob() {
    const cli = document.getElementById('inCli').value;
    if(!cli) return;
    const id = "ID-" + Date.now();
    db[id] = {
        cli: cli,
        maq: document.getElementById('inMaq').value,
        met: document.getElementById('inMet').value
    };
    save();
    closeModal();
    // Limpiar campos
    document.getElementById('inCli').value = "";
    document.getElementById('inMet').value = "";
}

function initSortable() {
    document.querySelectorAll('.drag-zone').forEach(zone => {
        new Sortable(zone, {
            group: 'shared',
            animation: 150,
            onEnd: (evt) => {
                db[evt.item.id].maq = evt.to.id;
                save();
            }
        });
    });
}

function save() {
    localStorage.setItem('tl_db', JSON.stringify(db));
    render();
    // Aqu√≠ se conectar√≠a la API de sincronizaci√≥n real (ej: Firebase o JSONBin)
}

function actualizarBadges() {
    const ids = ['list-flexo', 'list-digital', 'list-acabados'];
    const badges = ['b-flexo', 'b-digital', 'b-repaso'];
    ids.forEach((id, i) => {
        const count = document.getElementById(id).children.length;
        document.getElementById(badges[i]).innerText = count;
    });
    document.getElementById('count-activos').innerText = Object.keys(db).length;
}

function logout() { location.reload(); }
function openModal() { document.getElementById('modalPedido').style.display = 'block'; }
function closeModal() { document.getElementById('modalPedido').style.display = 'none'; }
</script>
</body>
</html>
