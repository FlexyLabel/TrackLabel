<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TRACKLABEL ERP ENTERPRISE v2026.1 - SISTEMA INTEGRAL DE PLANTA</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-base: #02040a; --bg-surface: #0d1117; --bg-elevated: #161b22;
            --primary: #00f2ff; --primary-dim: rgba(0, 242, 255, 0.1);
            --secondary: #21262d; --accent: #79c0ff; --success: #3fb950;
            --warning: #d29922; --danger: #f85149; --border: #30363d;
            --text-main: #c9d1d9; --text-bold: #ffffff; --text-muted: #8b949e;
            --radius-sm: 8px; --radius-md: 15px; --radius-lg: 30px;
            --shadow-lg: 0 20px 50px rgba(0,0,0,0.6); --font-mono: 'JetBrains Mono', monospace;
        }

        /* RESET & SCROLL */
        * { margin: 0; padding: 0; box-sizing: border-box; scrollbar-width: thin; scrollbar-color: var(--border) transparent; }
        body { background: var(--bg-base); color: var(--text-main); font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; }
        
        /* LOGIN LAYER */
        #login-overlay {
            position: fixed; inset: 0; z-index: 99999; background: radial-gradient(circle at center, #111b27 0%, #010409 100%);
            display: flex; align-items: center; justify-content: center; transition: transform 0.8s cubic-bezier(0.8,0,0.2,1);
        }
        .login-card {
            width: 100%; max-width: 800px; padding: 60px; background: var(--bg-surface);
            border: 1px solid var(--border); border-radius: var(--radius-lg); text-align: center; box-shadow: var(--shadow-lg);
        }
        .user-selector { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin: 40px 0; }
        .u-btn {
            padding: 20px 10px; background: var(--bg-elevated); border: 2px solid var(--border);
            border-radius: var(--radius-md); cursor: pointer; transition: 0.3s;
        }
        .u-btn:hover { border-color: var(--primary); transform: translateY(-5px); }
        .u-btn.active { border-color: var(--primary); background: var(--primary-dim); box-shadow: 0 0 20px var(--primary-dim); }
        .u-btn i { font-size: 24px; color: var(--primary); display: block; margin-bottom: 10px; }
        .u-btn b { font-size: 12px; display: block; color: var(--text-bold); }
        .u-btn span { font-size: 8px; color: var(--warning); font-weight: 800; text-transform: uppercase; }

        .pin-field {
            width: 240px; padding: 20px; background: #000; border: 2px solid var(--border);
            border-radius: var(--radius-md); color: var(--primary); font-family: var(--font-mono);
            font-size: 32px; text-align: center; letter-spacing: 12px; margin-bottom: 30px;
        }

        /* MAIN STRUCTURE */
        .main-container { display: grid; grid-template-columns: 280px 1fr; height: 100vh; opacity: 0; transition: 1s; }
        
        .sidebar { background: var(--bg-surface); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .sidebar-brand { padding: 40px; text-align: center; border-bottom: 1px solid var(--border); }
        .sidebar-nav { flex: 1; padding: 20px; }
        .nav-item {
            padding: 16px 20px; border-radius: var(--radius-sm); color: var(--text-muted);
            cursor: pointer; display: flex; align-items: center; gap: 15px; font-weight: 600; margin-bottom: 5px;
        }
        .nav-item:hover { background: var(--bg-elevated); color: var(--text-bold); }
        .nav-item.active { background: var(--primary-dim); color: var(--primary); }
        
        /* VIEWS */
        .content-area { padding: 40px 60px; overflow-y: auto; position: relative; }
        .view-section { display: none; }
        .view-section.active { display: block; animation: view-in 0.4s ease; }
        @keyframes view-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* KANBAN DESIGN */
        .kanban-board { display: grid; grid-template-columns: repeat(3, 1fr); gap: 30px; margin-top: 30px; }
        .kanban-col { background: rgba(0,0,0,0.2); border: 1px solid var(--border); border-radius: var(--radius-md); min-height: 70vh; display: flex; flex-direction: column; }
        .col-header { padding: 20px; font-weight: 800; font-size: 11px; text-transform: uppercase; letter-spacing: 1.5px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; }
        .card-list { padding: 15px; flex: 1; }
        .ot-card {
            background: var(--bg-elevated); padding: 20px; border-radius: var(--radius-sm); border: 1px solid var(--border);
            margin-bottom: 15px; cursor: pointer; transition: 0.2s; position: relative;
        }
        .ot-card:hover { border-color: var(--primary); transform: translateX(5px); }
        .ot-card h4 { font-size: 16px; color: var(--text-bold); }
        .ot-card .meta { font-size: 11px; color: var(--text-muted); margin-top: 8px; display: flex; gap: 10px; }
        .priority-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--success); }

        /* PRODUCTION TERMINAL (MAINFRAME) */
        #production-terminal {
            position: fixed; inset: 0; z-index: 9000; background: var(--bg-base); display: none; flex-direction: column;
        }
        .term-header { padding: 25px 50px; border-bottom: 1px solid var(--border); background: var(--bg-surface); display: flex; justify-content: space-between; align-items: center; }
        .term-body { flex: 1; display: grid; grid-template-columns: 1fr 450px; }
        .term-main { display: flex; flex-direction: column; align-items: center; justify-content: center; background: radial-gradient(circle at center, #0d1117 0%, #02040a 100%); }
        .timer-display { font-size: 14vw; font-family: var(--font-mono); font-weight: 800; color: var(--primary); text-shadow: 0 0 80px rgba(0, 242, 255, 0.2); }
        .term-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 30px; width: 80%; margin-top: 40px; }
        
        .stat-box { background: rgba(0,0,0,0.4); border: 1px solid var(--border); padding: 25px; border-radius: var(--radius-md); text-align: center; }
        .stat-box label { display: block; font-size: 11px; color: var(--text-muted); margin-bottom: 10px; text-transform: uppercase; }
        .stat-box .val { font-size: 40px; font-weight: 900; color: var(--text-bold); font-family: var(--font-mono); }
        .stat-input { width: 100%; background: transparent; border: none; border-bottom: 2px solid var(--border); color: var(--primary); font-size: 40px; text-align: center; font-family: var(--font-mono); }
        .stat-input:focus { border-color: var(--primary); }

        .term-sidebar { background: var(--bg-surface); border-left: 1px solid var(--border); padding: 40px; overflow-y: auto; }
        .control-btn { 
            width: 100%; padding: 20px; border-radius: var(--radius-sm); border: none; font-weight: 800; cursor: pointer;
            margin-bottom: 12px; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.2s;
        }
        .btn-run { background: var(--success); color: #000; }
        .btn-stop { background: var(--danger); color: #fff; }
        .btn-pause { background: var(--warning); color: #000; }
        .btn-op { background: var(--bg-elevated); color: #fff; border: 1px solid var(--border); }
        .btn-op:hover { background: var(--secondary); }

        /* TABLES & DATA */
        .data-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .data-table th { padding: 15px; text-align: left; color: var(--text-muted); font-size: 11px; text-transform: uppercase; border-bottom: 2px solid var(--border); }
        .data-table td { padding: 18px 15px; border-bottom: 1px solid var(--border); font-size: 14px; }
        .status-pill { padding: 4px 10px; border-radius: 20px; font-size: 10px; font-weight: 800; }

        /* MODALS */
        .modal-wrap { position: fixed; inset: 0; z-index: 10000; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-box { background: var(--bg-surface); width: 600px; padding: 45px; border-radius: var(--radius-lg); border: 1px solid var(--border); }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-size: 11px; color: var(--primary); font-weight: 800; margin-bottom: 8px; }
        .form-control { width: 100%; padding: 15px; background: #000; border: 1px solid var(--border); border-radius: var(--radius-sm); color: #fff; }

        /* CHARTS */
        .chart-container { background: var(--bg-surface); padding: 30px; border-radius: var(--radius-md); border: 1px solid var(--border); margin-top: 30px; }

    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-card">
            <h1 style="font-size: 40px; font-weight: 900; letter-spacing: -2px;">TRACK<span style="color:var(--primary)">LABEL</span></h1>
            <p style="color: var(--text-muted); letter-spacing: 5px; font-size: 10px; margin-bottom: 40px;">INDUSTRIAL ERP CORE v2026.1</p>
            
            <div class="user-selector" id="user-grid">
                </div>

            <input type="password" id="auth-pin" class="pin-field" maxlength="4" placeholder="••••">
            
            <div style="margin-top: 20px;">
                <button class="control-btn btn-run" style="width: 300px; margin: 0 auto; height: 65px; font-size: 18px;" onclick="Engine.Auth.validate()">
                    INGRESAR AL SISTEMA
                </button>
            </div>
        </div>
    </div>

    <div class="main-container" id="app-shell">
        <aside class="sidebar">
            <div class="sidebar-brand">
                <h2 style="font-size: 18px;">PANEL DE <span style="color:var(--primary)">CONTROL</span></h2>
            </div>
            
            <nav class="sidebar-nav">
                <div class="nav-item active" onclick="Engine.UI.switchView('production', this)"><i class="fas fa-industry"></i> Producción</div>
                <div class="nav-item" onclick="Engine.UI.switchView('warehouse', this)"><i class="fas fa-boxes-stacked"></i> Almacén / Bobinas</div>
                <div class="nav-item" onclick="Engine.UI.switchView('analytics', this)"><i class="fas fa-chart-line"></i> Estadísticas OEE</div>
                <div class="nav-item" onclick="Engine.UI.switchView('history', this)"><i class="fas fa-book"></i> Registro Histórico</div>
                <div class="nav-item" id="nav-admin" style="display:none;" onclick="Engine.UI.switchView('admin', this)"><i class="fas fa-user-shield"></i> Administración</div>
            </nav>

            <div style="padding: 30px; border-top: 1px solid var(--border);">
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                    <div id="user-avatar" style="width: 45px; height: 45px; background: var(--primary); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #000; font-weight: 900;">?</div>
                    <div>
                        <p id="user-display-name" style="font-weight: 700; color: #fff; font-size: 14px;">Usuario</p>
                        <p id="user-display-role" style="font-size: 10px; color: var(--warning);">ROL</p>
                    </div>
                </div>
                <button class="control-btn btn-op" style="padding: 10px;" onclick="location.reload()">SALIR</button>
            </div>
        </aside>

        <main class="content-area">
            
            <section id="view-production" class="view-section active">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h1>Monitor de Órdenes</h1>
                    <button class="control-btn btn-run" style="width: auto; padding: 12px 25px;" onclick="Engine.UI.toggleModal('modal-new-ot', true)">
                        <i class="fas fa-plus"></i> NUEVA ORDEN DE TRABAJO
                    </button>
                </div>

                <div class="kanban-board">
                    <div class="kanban-col">
                        <div class="col-header"><span>Pendiente</span> <i class="fas fa-clock"></i></div>
                        <div class="card-list" id="col-wait"></div>
                    </div>
                    <div class="kanban-col" style="border-color: var(--primary);">
                        <div class="col-header" style="color:var(--primary)"><span>En Proceso</span> <i class="fas fa-spinner fa-spin"></i></div>
                        <div class="card-list" id="col-run"></div>
                    </div>
                    <div class="kanban-col">
                        <div class="col-header"><span>Completado</span> <i class="fas fa-check-double"></i></div>
                        <div class="card-list" id="col-done"></div>
                    </div>
                </div>
            </section>

            <section id="view-warehouse" class="view-section">
                <h1>Inventario de Bobinas</h1>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID Bobina</th>
                            <th>Material</th>
                            <th>Metraje Inicial</th>
                            <th>Metraje Restante</th>
                            <th>Estado</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody id="warehouse-body">
                        </tbody>
                </table>
            </section>

            <section id="view-analytics" class="view-section">
                <h1>Rendimiento de Planta</h1>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-top: 30px;">
                    <div class="stat-box">
                        <label>OEE Global</label>
                        <div class="val" style="color:var(--primary)">92.4%</div>
                    </div>
                    <div class="stat-box">
                        <label>Disponibilidad</label>
                        <div class="val">96.1%</div>
                    </div>
                    <div class="stat-box">
                        <label>Rendimiento</label>
                        <div class="val">98.5%</div>
                    </div>
                    <div class="stat-box">
                        <label>Calidad</label>
                        <div class="val">99.8%</div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="oeeChart" style="width: 100%; height: 400px;"></canvas>
                </div>
            </section>

            <section id="view-history" class="view-section">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h1>Logs de Producción</h1>
                    <button class="control-btn btn-op" style="width: auto;" onclick="Engine.Data.exportCSV()">EXCEL / CSV</button>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>OT</th>
                            <th>Cliente</th>
                            <th>Metros Reales</th>
                            <th>Tiempo</th>
                            <th>Vel. Media</th>
                            <th>Mermas</th>
                            <th>Operario</th>
                        </tr>
                    </thead>
                    <tbody id="history-body"></tbody>
                </table>
            </section>

            <section id="view-admin" class="view-section">
                <h1>Panel de Administración Maestro</h1>
                <div style="margin-top: 40px; display: grid; grid-template-columns: 1fr 1fr; gap: 40px;">
                    <div class="stat-box" style="text-align: left;">
                        <h3>Seguridad de la Base de Datos</h3>
                        <p style="margin: 20px 0; color: var(--text-muted);">Iván, desde aquí puedes reiniciar el sistema o auditar los registros de acceso.</p>
                        <button class="control-btn btn-stop" onclick="Engine.Data.wipe()">FORMATEAR SISTEMA</button>
                    </div>
                    <div class="stat-box" style="text-align: left;">
                        <h3>Configuración de Máquina</h3>
                        <p style="margin: 20px 0; color: var(--text-muted);">Ajuste de velocidad nominal y márgenes de error de sensores.</p>
                        <button class="control-btn btn-op">CALIBRAR SENSORES</button>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <div id="production-terminal">
        <div class="term-header">
            <div>
                <h2 id="tm-client">CARGANDO CLIENTE...</h2>
                <p id="tm-id" style="color: var(--primary); font-family: var(--font-mono); font-weight: 700;">OT-00000</p>
            </div>
            <div style="display: flex; gap: 15px;">
                <button class="control-btn btn-pause" id="tm-btn-pause" onclick="Engine.Production.pause()">PAUSAR</button>
                <button class="control-btn btn-run" onclick="Engine.Production.finish()">FINALIZAR Y CERRAR</button>
            </div>
        </div>
        <div class="term-body">
            <div class="term-main">
                <div class="timer-display" id="tm-clock">00:00:00</div>
                <div class="term-stats">
                    <div class="stat-box">
                        <label>Metraje Real</label>
                        <input type="number" id="tm-meters" class="stat-input" value="0" oninput="Engine.Production.sync()">
                    </div>
                    <div class="stat-box">
                        <label>Metraje Restante</label>
                        <div class="val" id="tm-left">0</div>
                    </div>
                    <div class="stat-box">
                        <label>m/min Actual</label>
                        <div class="val" id="tm-speed" style="color: var(--primary);">0.0</div>
                    </div>
                </div>
            </div>
            <div class="term-sidebar">
                <h3 style="margin-bottom: 25px; font-size: 14px; letter-spacing: 2px;">PANEL DE INCIDENCIAS</h3>
                <button class="control-btn btn-op" onclick="Engine.Production.logEvent('Cambio Bobina')">CAMBIO DE BOBINA</button>
                <button class="control-btn btn-op" onclick="Engine.Production.logEvent('Limpieza Planchas')">LIMPIEZA DE PLANCHAS</button>
                <button class="control-btn btn-op" onclick="Engine.Production.logEvent('Ajuste de Registro')">AJUSTE DE REGISTRO</button>
                <button class="control-btn btn-op" onclick="Engine.Production.logEvent('Ajuste de Tinta')">AJUSTE DE TINTA</button>
                <button class="control-btn btn-stop" onclick="Engine.Production.logEvent('Avería Mecánica')">AVERÍA MECÁNICA</button>
                
                <div style="margin-top: 40px; padding: 25px; border: 1px solid var(--border); border-radius: var(--radius-md); background: rgba(0,0,0,0.3);">
                    <p style="font-size: 11px; color: var(--primary); font-weight: 800; margin-bottom: 15px;">LOG DE ESTADO</p>
                    <div id="tm-log-content" style="font-size: 12px; color: var(--text-muted); line-height: 1.8;">
                        Esperando inicio...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-wrap" id="modal-new-ot">
        <div class="modal-box">
            <h2>Registrar Nueva Orden</h2>
            <div style="margin-top: 30px;">
                <div class="form-group">
                    <label>NOMBRE DEL CLIENTE</label>
                    <input type="text" id="form-cli" class="form-control" placeholder="Ej. Empresa Packaging S.L.">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <label>METROS TEÓRICOS</label>
                        <input type="number" id="form-met" class="form-control" placeholder="10000">
                    </div>
                    <div class="form-group">
                        <label>MATERIAL (BOBINA)</label>
                        <select id="form-mat" class="form-control">
                            <option value="B-001">Papel Estucado 80g</option>
                            <option value="B-002">Polipropileno Brillo</option>
                            <option value="B-003">Térmico Protegido</option>
                        </select>
                    </div>
                </div>
                <div style="display: flex; gap: 15px; margin-top: 30px;">
                    <button class="control-btn btn-run" style="flex: 1;" onclick="Engine.Data.createOT()">GENERAR ORDEN</button>
                    <button class="control-btn btn-op" style="flex: 1;" onclick="Engine.UI.toggleModal('modal-new-ot', false)">CANCELAR</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        /**
         * ENGINE CORE - IVAN EDITION
         * Este objeto gestiona absolutamente toda la lógica del sistema.
         */
        const Engine = {
            State: {
                currentUser: null,
                activeOT: null,
                timerInterval: null,
                isPaused: false,
                db: {
                    ots: [],
                    inventory: [
                        { id: 'B-001', name: 'Papel Estucado 80g', total: 50000, current: 42000, status: 'ok' },
                        { id: 'B-002', name: 'PP Brillo', total: 20000, current: 5000, status: 'low' },
                        { id: 'B-003', name: 'Térmico', total: 30000, current: 30000, status: 'ok' }
                    ],
                    telemetry: [88, 92, 85, 94, 91, 89, 95]
                }
            },

            Users: [
                { id: 1, name: 'IVAN', role: 'ADMIN', pin: '1234', icon: 'fa-user-shield' },
                { id: 2, name: 'ANNA', role: 'ADMIN', pin: '2222', icon: 'fa-user-tie' },
                { id: 3, name: 'TONI', role: 'ADMIN', pin: '3333', icon: 'fa-user-cog' },
                { id: 4, name: 'ISA', role: 'OPERADOR', pin: '1111', icon: 'fa-user' },
                { id: 5, name: 'JAUME', role: 'OPERADOR', pin: '4444', icon: 'fa-user' }
            ],

            Init() {
                // Generar Grid de Usuarios
                const grid = document.getElementById('user-grid');
                this.Users.forEach(u => {
                    const btn = document.createElement('div');
                    btn.className = 'u-btn';
                    btn.innerHTML = `<i class="fas ${u.icon}"></i><b>${u.name}</b><span>${u.role}</span>`;
                    btn.onclick = () => {
                        this.State.currentUser = u;
                        document.querySelectorAll('.u-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        document.getElementById('auth-pin').focus();
                    };
                    grid.appendChild(btn);
                });

                // Cargar DB
                const saved = localStorage.getItem('tracklabel_full_db');
                if(saved) this.State.db = JSON.parse(saved);

                this.Data.renderAll();
            },

            Auth: {
                validate() {
                    const pin = document.getElementById('auth-pin').value;
                    const user = Engine.State.currentUser;
                    if(!user || pin !== user.pin) return alert("PIN INCORRECTO O USUARIO NO SELECCIONADO");

                    document.getElementById('login-overlay').style.transform = 'translateY(-100%)';
                    document.getElementById('app-shell').style.opacity = '1';
                    
                    document.getElementById('user-display-name').innerText = user.name;
                    document.getElementById('user-display-role').innerText = user.role;
                    document.getElementById('user-avatar').innerText = user.name[0];

                    if(user.role === 'ADMIN') document.getElementById('nav-admin').style.display = 'flex';
                    
                    Engine.UI.initCharts();
                }
            },

            Production: {
                start(id) {
                    const ot = Engine.State.db.ots.find(o => o.id === id);
                    if(!ot) return;
                    
                    Engine.State.activeOT = ot;
                    ot.status = 'run';
                    
                    document.getElementById('tm-client').innerText = ot.client;
                    document.getElementById('tm-id').innerText = ot.id;
                    document.getElementById('tm-meters').value = ot.real;
                    document.getElementById('tm-left').innerText = (ot.target - ot.real).toLocaleString();
                    
                    document.getElementById('production-terminal').style.display = 'flex';
                    this.runTimer();
                    Engine.Data.renderAll();
                },

                runTimer() {
                    if(Engine.State.timerInterval) clearInterval(Engine.State.timerInterval);
                    let start = Date.now() - Engine.State.activeOT.time;
                    
                    Engine.State.timerInterval = setInterval(() => {
                        if(Engine.State.isPaused) return;
                        Engine.State.activeOT.time = Date.now() - start;
                        document.getElementById('tm-clock').innerText = Engine.UI.formatTime(Engine.State.activeOT.time);
                        this.sync();
                    }, 1000);
                },

                pause() {
                    Engine.State.isPaused = !Engine.State.isPaused;
                    const btn = document.getElementById('tm-btn-pause');
                    btn.innerText = Engine.State.isPaused ? 'REANUDAR' : 'PAUSAR';
                    btn.className = Engine.State.isPaused ? 'control-btn btn-run' : 'control-btn btn-pause';
                },

                sync() {
                    const m = parseFloat(document.getElementById('tm-meters').value) || 0;
                    const ot = Engine.State.activeOT;
                    ot.real = m;
                    
                    const min = ot.time / 60000;
                    if(min > 0.1) {
                        document.getElementById('tm-speed').innerText = (m / min).toFixed(1);
                    }
                    document.getElementById('tm-left').innerText = (ot.target - m).toFixed(0);
                },

                logEvent(type) {
                    const ot = Engine.State.activeOT;
                    const time = new Date().toLocaleTimeString();
                    ot.events = ot.events || [];
                    ot.events.push(`[${time}] ${type}`);
                    
                    const logBox = document.getElementById('tm-log-content');
                    logBox.innerHTML = ot.events.map(e => `<div>${e}</div>`).join('');
                    
                    if(type.includes('Avería') || type.includes('Cambio')) this.pause();
                },

                finish() {
                    if(!confirm("¿Deseas cerrar la Orden de Trabajo y guardar los datos?")) return;
                    
                    const ot = Engine.State.activeOT;
                    ot.status = 'done';
                    ot.endDate = new Date().toLocaleString();
                    
                    clearInterval(Engine.State.timerInterval);
                    document.getElementById('production-terminal').style.display = 'none';
                    
                    Engine.Data.save();
                    Engine.Data.renderAll();
                }
            },

            Data: {
                createOT() {
                    const cli = document.getElementById('form-cli').value;
                    const met = document.getElementById('form-met').value;
                    if(!cli || !met) return alert("Completa todos los campos");

                    const newOT = {
                        id: 'OT-' + Math.floor(Math.random()*90000+10000),
                        client: cli.toUpperCase(),
                        target: parseFloat(met),
                        real: 0,
                        time: 0,
                        status: 'wait',
                        op: Engine.State.currentUser.name,
                        events: [],
                        created: new Date().toLocaleString()
                    };

                    Engine.State.db.ots.push(newOT);
                    this.save();
                    this.renderAll();
                    Engine.UI.toggleModal('modal-new-ot', false);
                },

                renderAll() {
                    // Kanban
                    const cols = { wait: 'col-wait', run: 'col-run', done: 'col-done' };
                    Object.values(cols).forEach(id => document.getElementById(id).innerHTML = '');

                    Engine.State.db.ots.forEach(ot => {
                        const card = document.createElement('div');
                        card.className = 'ot-card';
                        card.innerHTML = `
                            <h4>${ot.client}</h4>
                            <p style="font-size:12px; color:var(--primary); font-family:var(--font-mono)">${ot.id}</p>
                            <div class="meta">
                                <span><i class="fas fa-bullseye"></i> ${ot.target}m</span>
                                <span><i class="fas fa-user"></i> ${ot.op}</span>
                            </div>
                        `;
                        card.onclick = () => Engine.Production.start(ot.id);
                        document.getElementById(cols[ot.status]).appendChild(card);
                    });

                    // Historial
                    const hBody = document.getElementById('history-body');
                    if(hBody) {
                        hBody.innerHTML = Engine.State.db.ots.filter(o => o.status === 'done').map(o => `
                            <tr>
                                <td style="color:var(--primary); font-family:var(--font-mono)">${o.id}</td>
                                <td><b>${o.client}</b></td>
                                <td>${o.real} m</td>
                                <td>${Engine.UI.formatTime(o.time)}</td>
                                <td style="color:var(--success)">${(o.real/(o.time/60000)).toFixed(1)}</td>
                                <td style="color:var(--danger)">${(o.target - o.real).toFixed(0)}m</td>
                                <td>${o.op}</td>
                            </tr>
                        `).join('');
                    }

                    // Inventario
                    const wBody = document.getElementById('warehouse-body');
                    if(wBody) {
                        wBody.innerHTML = Engine.State.db.inventory.map(b => `
                            <tr>
                                <td>${b.id}</td>
                                <td>${b.name}</td>
                                <td>${b.total} m</td>
                                <td style="font-weight:800; color:${b.status === 'low' ? 'var(--danger)' : 'var(--success)'}">${b.current} m</td>
                                <td><span class="status-pill" style="background:${b.status === 'low' ? 'var(--danger)' : 'var(--success)'}">${b.status.toUpperCase()}</span></td>
                                <td><button class="btn-op" style="padding:5px 10px; border-radius:5px;">PEDIR</button></td>
                            </tr>
                        `).join('');
                    }
                },

                save() { localStorage.setItem('tracklabel_full_db', JSON.stringify(Engine.State.db)); },
                wipe() { if(confirm("¿Eliminar toda la base de datos?")) { localStorage.clear(); location.reload(); } }
            },

            UI: {
                switchView(viewId, el) {
                    document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
                    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                    document.getElementById('view-' + viewId).classList.add('active');
                    el.classList.add('active');
                    Engine.Data.renderAll();
                },

                toggleModal(id, show) { document.getElementById(id).style.display = show ? 'flex' : 'none'; },

                formatTime(ms) {
                    let s = Math.floor(ms/1000); let m = Math.floor(s/60); let h = Math.floor(m/60);
                    return `${h.toString().padStart(2,'0')}:${(m%60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
                },

                initCharts() {
                    const ctx = document.getElementById('oeeChart').getContext('2d');
                    if(window.myChart) window.myChart.destroy();
                    window.myChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: ['Lun', 'Mar', 'Mie', 'Jue', 'Vie', 'Sab', 'Dom'],
                            datasets: [{
                                label: 'OEE Diario %',
                                data: Engine.State.db.telemetry,
                                borderColor: '#00f2ff',
                                tension: 0.4,
                                fill: true,
                                backgroundColor: 'rgba(0, 242, 255, 0.05)'
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: { legend: { display: false } },
                            scales: { y: { beginAtZero: false, min: 70, grid: { color: '#30363d' } }, x: { grid: { display: false } } }
                        }
                    });
                }
            }
        };

        window.onload = () => Engine.Init();

    </script>
</body>
</html>
