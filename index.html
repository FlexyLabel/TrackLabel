<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Track Label Pro - Cloud Sync</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --bg: #0b0e11; --sidebar: #15191d; --surface: #1e2329;
            --orange: #ff7a00; --green: #00ff88; --text: #f0f0f0; --border: #282e35;
        }
        
        * { box-sizing: border-box; outline: none; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; overflow-x: hidden; }

        /* PANTALLA DE SEGURIDAD (PASSWORD MAESTRA) */
        .security-overlay { position: fixed; inset: 0; background: #000; display: flex; align-items: center; justify-content: center; z-index: 10000; }
        
        /* LOGIN DE USUARIOS */
        .login-overlay { position: fixed; inset: 0; background: radial-gradient(circle, #1e2329 0%, #0b0e11 100%); display: flex; align-items: center; justify-content: center; z-index: 9999; padding: 20px; }
        .login-box { background: var(--surface); padding: 40px; border-radius: 35px; text-align: center; width: 100%; max-width: 440px; border: 1px solid #333; }
        
        .user-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 30px 0; }
        .user-item { background: #15191d; padding: 15px; border-radius: 20px; border: 1px solid #222; cursor: pointer; transition: 0.3s; }
        .user-item.selected { border-color: var(--orange); background: #2a3139; }
        .user-initial { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #333; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; font-weight: bold; }

        /* APP LAYOUT */
        .app-container { display: flex; height: 100vh; }
        .sidebar { width: 280px; background: var(--sidebar); border-right: 1px solid var(--border); padding: 30px 20px; flex-shrink: 0; }
        .content-area { flex: 1; padding: 30px; overflow-y: auto; background: var(--bg); }

        /* KANBAN */
        .kanban-board { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .machine-col { background: #15191d; padding: 20px; border-radius: 25px; border: 1px solid var(--border); min-height: 500px; }
        .job-card { background: var(--surface); padding: 20px; border-radius: 20px; margin-bottom: 15px; border-left: 5px solid; cursor: pointer; }

        /* MODALES */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 8000; backdrop-filter: blur(8px); overflow-y: auto; padding: 20px; }
        .modal-content { background: var(--surface); margin: 2% auto; padding: 35px; border-radius: 35px; width: 100%; max-width: 550px; border: 1px solid #333; }

        /* BOTONES */
        .btn-main { width: 100%; padding: 18px; background: var(--orange); border: none; border-radius: 15px; color: white; font-weight: bold; cursor: pointer; font-size: 16px; }
        .sync-indicator { font-size: 10px; color: var(--green); text-align: center; margin-top: 10px; opacity: 0.7; }

        @media (max-width: 1024px) {
            .app-container { flex-direction: column; }
            .sidebar { width: 100%; height: auto; }
            .kanban-board { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div id="master-lock" class="security-overlay">
    <div class="login-box">
        <div style="background:var(--orange); width:50px; height:50px; margin:0 auto 20px; border-radius:10px;"></div>
        <h3>ACCESO RESTRINGIDO</h3>
        <input type="password" id="master-pass" placeholder="Contrase√±a de la web" style="width:100%; padding:15px; border-radius:12px; background:#111; border:1px solid #333; color:white; text-align:center;">
        <button class="btn-main" style="margin-top:20px" onclick="checkMasterPass()">DESBLOQUEAR</button>
    </div>
</div>

<div id="login-screen" class="login-overlay" style="display:none">
    <div class="login-box">
        <h2>TRACK LABEL PRO</h2>
        <div class="user-grid">
            <div class="user-item" onclick="selectUser('Isa', this)"><div class="user-initial">I</div><span>Isa</span></div>
            <div class="user-item" onclick="selectUser('Jaume', this)"><div class="user-initial">J</div><span>Jaume</span></div>
            <div class="user-item" onclick="selectUser('Ivan', this)"><div class="user-initial" style="border-color:var(--orange)">I</div><span>Ivan</span></div>
            <div class="user-item" onclick="selectUser('Anna', this)"><div class="user-initial">A</div><span>Anna</span></div>
            <div class="user-item" onclick="selectUser('Toni', this)"><div class="user-initial">T</div><span>Toni</span></div>
        </div>
        <input type="password" id="user-pin" placeholder="PIN" style="width:100%; padding:15px; border-radius:12px; background:#000; border:1px solid #333; color:white; text-align:center; margin-bottom:20px;">
        <button class="btn-main" onclick="login()">ENTRAR</button>
    </div>
</div>

<div id="main-app" class="app-container" style="display: none;">
    <aside class="sidebar">
        <h3>PLANTA</h3>
        <div id="sync-status" class="sync-indicator">‚óè Nube Sincronizada</div>
        <hr style="border:0; border-top:1px solid #222; margin:20px 0">
        <div id="stats">
            <p>Activos: <strong id="stat-pend">0</strong></p>
            <p>Hechos: <strong id="stat-done" style="color:var(--green)">0</strong></p>
        </div>
        <button onclick="syncCloud()" style="width:100%; padding:10px; background:#222; color:white; border-radius:10px; border:none; margin-top:20px; cursor:pointer; font-size:11px;">üîÑ FORZAR SINCRONIZACI√ìN</button>
    </aside>

    <section class="content-area">
        <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
            <h2 id="welcome-text">Panel</h2>
            <button class="btn-main" style="width:auto; padding:12px 30px" onclick="openModal()">+ NUEVO PEDIDO</button>
        </header>

        <main class="kanban-board">
            <div class="machine-col"><h4>FLEXO</h4><div class="drag-zone" id="list-flexo"></div></div>
            <div class="machine-col"><h4>DIGITAL</h4><div class="drag-zone" id="list-digital"></div></div>
            <div class="machine-col"><h4>REPASO</h4><div class="drag-zone" id="list-acabados"></div></div>
        </main>
    </section>
</div>

<div id="modalPedido" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0">NUEVA ORDEN</h3>
        <input type="text" id="inputCliente" placeholder="Cliente" style="width:100%; padding:15px; margin-bottom:15px; background:#000; border:1px solid #333; color:white;">
        <select id="inputMaquina" style="width:100%; padding:15px; margin-bottom:15px; background:#000; color:white;">
            <option value="list-flexo">Flexo</option>
            <option value="list-digital">Digital</option>
        </select>
        <input type="number" id="inputMetros" placeholder="Metros" style="width:100%; padding:15px; margin-bottom:15px; background:#000; border:1px solid #333; color:white;">
        <button class="btn-main" onclick="guardarPedido()">LANZAR A PLANTA</button>
        <button onclick="closeModal()" style="width:100%; background:none; border:none; color:#666; margin-top:15px; cursor:pointer;">Cancelar</button>
    </div>
</div>

<script>
const PASS_MAESTRA = "TrackLabel#";
const USUARIOS = {"Isa":"1234", "Jaume":"1234", "Ivan":"1234", "Anna":"1234", "Toni":"1234"};

let db = JSON.parse(localStorage.getItem('trackLabel_db')) || {};
let userSeleccionado = null;

// --- SEGURIDAD ---
function checkMasterPass() {
    const p = document.getElementById("master-pass").value;
    if(p === PASS_MAESTRA) {
        document.getElementById("master-lock").style.display = "none";
        document.getElementById("login-screen").style.display = "flex";
    } else { alert("Contrase√±a incorrecta"); }
}

function selectUser(n, el) {
    userSeleccionado = n;
    document.querySelectorAll('.user-item').forEach(i => i.classList.remove('selected'));
    el.classList.add('selected');
}

function login() {
    const pin = document.getElementById("user-pin").value;
    if(USUARIOS[userSeleccionado] === pin) {
        document.getElementById("login-screen").style.display = "none";
        document.getElementById("main-app").style.display = "flex";
        document.getElementById("welcome-text").innerText = "Operario: " + userSeleccionado;
        renderAll();
        initSortable();
    }
}

// --- L√ìGICA DE DATOS ---
function renderAll() {
    document.querySelectorAll('.drag-zone').forEach(z => z.innerHTML = "");
    Object.keys(db).forEach(id => {
        const data = db[id];
        const card = document.createElement("div");
        card.className = "job-card";
        card.id = id;
        card.style.borderLeftColor = data.color || "var(--orange)";
        card.innerHTML = `<strong>${data.cliente}</strong><br><small>${data.metros}m</small>`;
        document.getElementById(data.maquina).appendChild(card);
    });
    actualizarStats();
}

function guardarPedido() {
    const cli = document.getElementById("inputCliente").value;
    if(!cli) return;
    const id = "ID-" + Date.now();
    db[id] = {
        cliente: cli,
        maquina: document.getElementById("inputMaquina").value,
        metros: document.getElementById("inputMetros").value,
        color: "var(--orange)"
    };
    save();
    closeModal();
    renderAll();
}

function initSortable() {
    document.querySelectorAll('.drag-zone').forEach(zona => {
        new Sortable(zona, { 
            group: 'planta',
            animation: 150,
            onEnd: (evt) => {
                db[evt.item.id].maquina = evt.to.id;
                save();
            }
        });
    });
}

function save() {
    localStorage.setItem('trackLabel_db', JSON.stringify(db));
    // Aqu√≠ podr√≠as a√±adir un fetch() a una API para sincronizar dispositivos
    actualizarStats();
}

function actualizarStats() {
    document.getElementById("stat-pend").innerText = Object.keys(db).length;
}

// --- GESTI√ìN DE MODALES (CORRECCI√ìN DE BLOQUEO) ---
function openModal() {
    document.getElementById("modalPedido").style.display = "block";
    document.body.style.overflow = "hidden"; // Bloquea scroll fondo
}

function closeModal() {
    document.getElementById("modalPedido").style.display = "none";
    document.body.style.overflow = "auto"; // Libera la pantalla principal
}

// Funci√≥n para sincronizaci√≥n manual (Simulaci√≥n nube)
function syncCloud() {
    document.getElementById("sync-status").innerText = "‚åõ Sincronizando...";
    setTimeout(() => {
        document.getElementById("sync-status").innerText = "‚óè Nube Actualizada";
    }, 1500);
}
</script>
</body>
</html>
